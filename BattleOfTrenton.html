<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battle of Trenton - Campaign Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #1e3a5f;
            --secondary: #d4af37;
            --accent: #dc2626;
            --success: #16a34a;
            --bg-dark: #0a0a0a;
            --bg-light: #1a1410;
            --text: #f4e8d0;
        }

        body {
            font-family: Georgia, serif;
            background: var(--bg-dark);
            color: var(--text);
            overflow: hidden;
        }

        /* Map */
        #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }

        /* Quick Help Banner */
        .help-banner {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--primary), #0f1f3a);
            border: 2px solid var(--secondary);
            border-radius: 8px;
            padding: 0.8rem 1.5rem;
            z-index: 3000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.8);
            display: none;
        }

        .help-banner.show { display: block; }

        .help-text {
            font-size: 0.9rem;
            text-align: center;
        }

        /* Layer Control */
        .layer-control {
            position: fixed;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, var(--primary), #0f1f3a);
            border: 2px solid var(--secondary);
            border-radius: 6px;
            padding: 0.5rem;
            z-index: 1500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }

        .layer-btn {
            background: rgba(26, 20, 16, 0.5);
            border: 1px solid var(--secondary);
            color: var(--text);
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.75rem;
            font-family: Georgia, serif;
            transition: all 0.2s;
            display: block;
            width: 100%;
            margin-bottom: 0.3rem;
        }

        .layer-btn:last-child { margin-bottom: 0; }
        .layer-btn:hover, .layer-btn.active {
            background: var(--secondary);
            color: var(--primary);
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 350px;
            height: 100vh;
            background: linear-gradient(180deg, var(--bg-light), var(--bg-dark));
            border-right: 3px solid var(--secondary);
            transition: transform 0.3s ease;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 20px rgba(0,0,0,0.5);
        }

        .sidebar.hidden { transform: translateX(-350px); }

        .toggle-btn {
            position: fixed;
            left: 10px;
            top: 10px;
            background: linear-gradient(135deg, var(--primary), #0f1f3a);
            color: var(--secondary);
            border: 2px solid var(--secondary);
            padding: 0.6rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            z-index: 2001;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            transition: all 0.3s;
            display: none;
        }

        .sidebar.hidden ~ .toggle-btn { display: block; }
        .toggle-btn:hover {
            background: linear-gradient(135deg, var(--secondary), #b8941f);
            color: var(--primary);
            transform: scale(1.05);
        }

        .sidebar-header {
            background: linear-gradient(135deg, var(--primary), #0f1f3a);
            padding: 1.2rem;
            border-bottom: 3px solid var(--secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .campaign-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--secondary);
            margin-bottom: 0.3rem;
        }

        .campaign-meta {
            font-size: 0.8rem;
            opacity: 0.8;
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .close-btn {
            background: transparent;
            border: none;
            color: var(--secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 1;
            transition: all 0.2s;
        }

        .close-btn:hover {
            color: var(--accent);
            transform: scale(1.2);
        }

        /* Tabs */
        .sidebar-tabs {
            display: flex;
            background: rgba(30, 58, 95, 0.3);
            border-bottom: 2px solid var(--secondary);
        }

        .tab {
            flex: 1;
            padding: 0.7rem 0.3rem;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.75rem;
            transition: all 0.3s;
            border-right: 1px solid rgba(212, 175, 55, 0.3);
        }

        .tab:last-child { border-right: none; }
        .tab:hover { background: rgba(212, 175, 55, 0.2); }
        .tab.active { background: rgba(212, 175, 55, 0.3); color: var(--secondary); }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: none;
        }

        .tab-content.active { display: block; }

        /* Location Cards */
        .location-card {
            background: rgba(30, 58, 95, 0.2);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-left: 4px solid var(--primary);
            border-radius: 6px;
            padding: 0.9rem;
            margin-bottom: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .location-card:hover {
            background: rgba(30, 58, 95, 0.4);
            border-left-color: var(--secondary);
            transform: translateX(5px);
        }

        .location-card.active {
            background: rgba(212, 175, 55, 0.2);
            border-color: var(--secondary);
        }

        .location-card.quest { border-left-color: var(--accent); }
        .location-card.continental { border-left-color: #3b82f6; }
        .location-card.hessian { border-left-color: #f59e0b; }
        .location-card.crossing { border-left-color: #06b6d4; }

        .location-name {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 0.4rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .location-desc {
            font-size: 0.85rem;
            opacity: 0.8;
            line-height: 1.4;
        }

        .badge {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 0.3rem;
        }

        .badge.visited { background: var(--success); color: white; }
        .badge.tactical { background: var(--accent); color: white; }
        .badge.has-image { background: #3b82f6; color: white; }

        /* Buttons */
        .btn {
            width: 100%;
            background: linear-gradient(135deg, var(--primary), #0f1f3a);
            color: var(--secondary);
            border: 2px solid var(--secondary);
            padding: 0.7rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
            font-family: Georgia, serif;
            transition: all 0.3s;
            margin-bottom: 0.5rem;
        }

        .btn:hover {
            background: linear-gradient(135deg, var(--secondary), #b8941f);
            color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .btn.danger {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .btn.danger:hover {
            background: #b91c1c;
            border-color: #b91c1c;
        }

        /* Stats */
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.6rem;
            background: rgba(30, 58, 95, 0.2);
            border-radius: 4px;
            margin-bottom: 0.4rem;
            font-size: 0.85rem;
        }

        .stat-value {
            font-weight: bold;
            color: var(--secondary);
        }

        .save-section {
            margin-bottom: 1.5rem;
        }

        .save-label {
            font-weight: bold;
            color: var(--secondary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        /* Info Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 4000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-overlay.active { display: flex; }

        .modal-content {
            background: linear-gradient(135deg, var(--bg-light), var(--bg-dark));
            border: 4px solid var(--secondary);
            border-radius: 12px;
            padding: 2rem;
            max-width: 700px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid var(--secondary);
        }

        .modal-title {
            font-size: 1.7rem;
            color: var(--secondary);
            font-weight: bold;
        }

        .modal-subtitle {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-top: 0.3rem;
        }

        .modal-close {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-family: Georgia, serif;
        }

        .modal-close:hover { background: #b91c1c; }

        .info-section {
            background: rgba(30, 58, 95, 0.2);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 1.3rem;
            margin-bottom: 1.3rem;
        }

        .section-title {
            font-size: 1.1rem;
            color: var(--secondary);
            font-weight: bold;
            margin-bottom: 0.8rem;
        }

        .info-text {
            font-size: 0.95rem;
            line-height: 1.7;
            margin-bottom: 0.8rem;
        }

        .info-list {
            list-style: none;
            padding: 0;
        }

        .info-list li {
            padding: 0.4rem 0 0.4rem 1.3rem;
            position: relative;
            line-height: 1.6;
            font-size: 0.9rem;
        }

        .info-list li:before {
            content: "‚ñ∏";
            position: absolute;
            left: 0;
            color: var(--secondary);
        }

        .historical-fact {
            background: rgba(212, 175, 55, 0.1);
            border-left: 4px solid var(--secondary);
            padding: 0.9rem;
            margin: 0.8rem 0;
            font-style: italic;
        }

        /* Tactical Overlay */
        .tactical-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #1a1410;
            z-index: 5000;
        }

        .tactical-overlay.active {
            display: flex;
            flex-direction: column;
        }

        .tactical-header {
            background: linear-gradient(135deg, var(--primary), #0f1f3a);
            border-bottom: 3px solid var(--secondary);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tactical-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--secondary);
        }

        .tactical-close {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-family: Georgia, serif;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .tactical-close:hover {
            background: #b91c1c;
            transform: scale(1.05);
        }

        .tactical-tabs {
            display: flex;
            background: rgba(30, 58, 95, 0.3);
            border-bottom: 3px solid var(--secondary);
            padding: 0 1rem;
        }

        .tactical-tab {
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
            border-bottom: 3px solid transparent;
            margin-bottom: -3px;
            transition: all 0.3s;
            color: rgba(244, 232, 208, 0.7);
        }

        .tactical-tab:hover {
            background: rgba(212, 175, 55, 0.2);
            color: var(--text);
        }

        .tactical-tab.active {
            background: rgba(212, 175, 55, 0.3);
            border-bottom-color: var(--secondary);
            color: var(--secondary);
        }

        .tactical-body {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
        }

        .tactical-content {
            display: none;
            flex: 1;
            position: relative;
        }

        .tactical-content.active {
            display: flex;
            flex-direction: column;
        }

        #tactical-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }

        .tactical-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(26, 20, 16, 0.95);
            border: 2px solid var(--secondary);
            border-radius: 8px;
            padding: 1rem;
            max-width: 250px;
            z-index: 100;
        }

        .control-title {
            font-weight: bold;
            color: var(--secondary);
            margin-bottom: 0.8rem;
            font-size: 0.9rem;
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 0.5rem;
        }

        .control-btn {
            width: 100%;
            background: rgba(30, 58, 95, 0.5);
            border: 1px solid var(--secondary);
            color: var(--text);
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-family: Georgia, serif;
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: rgba(212, 175, 55, 0.3);
        }

        .control-btn.active {
            background: var(--secondary);
            color: var(--primary);
        }

        .token-controls {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(26, 20, 16, 0.95);
            border: 2px solid var(--secondary);
            border-radius: 8px;
            padding: 0.8rem 1.5rem;
            display: flex;
            gap: 1rem;
            z-index: 100;
        }

        .token-btn {
            background: linear-gradient(135deg, var(--primary), #0f1f3a);
            border: 2px solid var(--secondary);
            color: var(--secondary);
            padding: 0.6rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .token-btn:hover {
            background: var(--secondary);
            color: var(--primary);
            transform: translateY(-2px);
        }

        .token-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* Battle Log */
        .battle-log {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 350px;
            max-height: 300px;
            background: rgba(26, 20, 16, 0.95);
            border: 2px solid var(--secondary);
            border-radius: 8px;
            padding: 1rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--secondary);
        }

        .log-title {
            font-weight: bold;
            color: var(--secondary);
            font-size: 0.9rem;
        }

        .log-clear {
            background: var(--accent);
            border: none;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            font-family: Georgia, serif;
        }

        .log-entries {
            flex: 1;
            overflow-y: auto;
            max-height: 220px;
        }

        .log-entry {
            background: rgba(30, 58, 95, 0.2);
            border-left: 3px solid var(--secondary);
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .log-entry.combat { border-left-color: var(--accent); }
        .log-entry.movement { border-left-color: #3b82f6; }
        .log-entry.info { border-left-color: var(--secondary); }

        .log-time {
            font-size: 0.7rem;
            opacity: 0.6;
            font-family: 'Courier New', monospace;
        }

        .tab-panel {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .section-header {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--secondary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--secondary);
        }

        .character-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .character-card {
            background: rgba(30, 58, 95, 0.2);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .character-card:hover {
            background: rgba(30, 58, 95, 0.4);
            border-color: var(--secondary);
            transform: translateY(-3px);
        }

        .character-name {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 0.3rem;
            color: var(--secondary);
        }

        .character-info {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Markers */
        .custom-marker {
            background: none;
            border: none;
        }

        .marker-pin {
            width: 40px;
            height: 40px;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            border: 3px solid #fff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            cursor: pointer;
            transition: all 0.3s;
        }

        .marker-pin:hover {
            transform: rotate(-45deg) scale(1.4);
            z-index: 1000;
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.6);
        }

        .marker-pin.quest {
            background: radial-gradient(circle, var(--accent), #991b1b);
            animation: pulse 2s infinite;
        }

        .marker-pin.hessian { background: radial-gradient(circle, #f59e0b, #d97706); }
        .marker-pin.continental { background: radial-gradient(circle, #3b82f6, #1e40af); }
        .marker-pin.crossing { background: radial-gradient(circle, #06b6d4, #0891b2); }

        @keyframes pulse {
            0%, 100% { transform: rotate(-45deg) scale(1); }
            50% { transform: rotate(-45deg) scale(1.2); }
        }

        .marker-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            font-size: 1.2rem;
        }

        /* Leaflet Popup */
        .leaflet-popup-content-wrapper {
            background: rgba(26, 20, 16, 0.98);
            color: var(--text);
            border: 3px solid var(--secondary);
            border-radius: 8px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.7);
        }

        .leaflet-popup-content {
            font-family: Georgia, serif;
            margin: 1.2rem;
            min-width: 220px;
        }

        .leaflet-popup-tip { background: rgba(26, 20, 16, 0.98); }

        .popup-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--secondary);
            margin-bottom: 0.5rem;
        }

        .popup-desc {
            font-size: 0.9rem;
            margin-bottom: 0.8rem;
            line-height: 1.5;
        }

        .popup-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .popup-btn {
            background: var(--primary);
            color: var(--secondary);
            border: 1px solid var(--secondary);
            padding: 0.6rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-family: Georgia, serif;
            font-size: 0.8rem;
            transition: all 0.3s;
        }

        .popup-btn:hover {
            background: var(--secondary);
            color: var(--primary);
        }

        .popup-btn.tactical {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
            grid-column: 1 / -1;
        }

        .popup-btn.tactical:hover { background: #b91c1c; }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 4px;
            margin: 0.5rem 0;
        }

        .grid-overlay {
            pointer-events: none;
            z-index: 600;
        }

        .grid-line {
            fill: none;
            stroke: rgba(212, 175, 55, 0.4);
            stroke-width: 1.5;
        }

        .grid-line.major {
            stroke: rgba(212, 175, 55, 0.6);
            stroke-width: 2;
        }

        .grid-label {
            fill: var(--secondary);
            font-size: 12px;
            font-weight: bold;
            text-anchor: middle;
            paint-order: stroke;
            stroke: rgba(0, 0, 0, 0.9);
            stroke-width: 3px;
            font-family: 'Courier New', monospace;
        }

        /* Contextual Help Icon */
        .help-icon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), #0f1f3a);
            border: 2px solid var(--secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--secondary);
            cursor: pointer;
            z-index: 3000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            transition: all 0.3s;
        }

        .help-icon:hover {
            background: linear-gradient(135deg, var(--secondary), #b8941f);
            color: var(--primary);
            transform: scale(1.1);
        }

        .help-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 4000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .help-overlay.active { display: flex; }

        .help-content {
            background: linear-gradient(135deg, var(--bg-light), var(--bg-dark));
            border: 4px solid var(--secondary);
            border-radius: 12px;
            padding: 2rem;
            max-width: 700px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- Map -->
    <div id="map"></div>

    <!-- Help Banner -->
    <div class="help-banner" id="help-banner">
        <div class="help-text">üí° Click any location on the map or sidebar to explore!</div>
    </div>

    <!-- Layer Control -->
    <div class="layer-control">
        <button class="layer-btn" id="layer-street" onclick="app.setLayer('street')">Street</button>
        <button class="layer-btn active" id="layer-satellite" onclick="app.setLayer('satellite')">Satellite</button>
        <button class="layer-btn" id="layer-terrain" onclick="app.setLayer('terrain')">Terrain</button>
        <div style="border-top: 1px solid rgba(212, 175, 55, 0.3); margin: 0.5rem 0;"></div>
        <button class="layer-btn" id="dm-mode-toggle" onclick="app.toggleDMMode()">üé≤ DM Mode</button>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div>
                <div class="campaign-title">‚öîÔ∏è Battle of Trenton</div>
                <div class="campaign-meta">
                    <span>üìÖ Dec 25-26, 1776</span>
                    <span>üå°Ô∏è 28¬∞F</span>
                </div>
            </div>
            <button class="close-btn" onclick="toggleSidebar()">√ó</button>
        </div>

        <div class="sidebar-tabs">
            <div class="tab active" onclick="showTab('locations')">üìç Locations</div>
            <div class="tab" onclick="showTab('characters')">üë§ Characters</div>
            <div class="tab" onclick="showTab('save')">üíæ Save</div>
        </div>

        <div class="tab-content active" id="tab-locations">
            <div id="locations-list"></div>
        </div>

        <div class="tab-content" id="tab-characters">
            <div class="save-label">üë§ Character Library</div>
            <p style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 1rem; line-height: 1.5;">
                View all characters in the campaign. Click any location's tactical map to add them to the battlefield.
            </p>
            <div id="characters-library"></div>
        </div>

        <div class="tab-content" id="tab-save">
            <div class="save-section">
                <div class="save-label">üíæ Save Game</div>
                <button class="btn" onclick="app.save()">Save Progress Now</button>
                <button class="btn" onclick="app.exportSave()">üì§ Export Save</button>
                <button class="btn" onclick="document.getElementById('import-file').click()">üì• Import Save</button>
                <input type="file" id="import-file" accept=".json" style="display:none">
            </div>

            <div class="save-section">
                <div class="save-label">üìä Statistics</div>
                <div class="stat-row">
                    <span>Locations Visited</span>
                    <span class="stat-value" id="stat-visited">0 / 7</span>
                </div>
            </div>

            <div class="save-section">
                <div class="save-label">‚ö†Ô∏è Reset</div>
                <button class="btn danger" onclick="app.reset()">Reset Campaign</button>
            </div>
        </div>
    </div>

    <button class="toggle-btn" onclick="toggleSidebar()">üó∫Ô∏è Map</button>

    <!-- Info Modal -->
    <div class="modal-overlay" id="info-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <div class="modal-title" id="info-title">Location</div>
                    <div class="modal-subtitle" id="info-subtitle">Coordinates</div>
                </div>
                <button class="modal-close" onclick="closeInfo()">‚úï</button>
            </div>
            <div id="info-body"></div>
        </div>
    </div>

    <!-- Contextual Help Icon -->
    <div class="help-icon" onclick="toggleHelp()" title="Help">‚ùì</div>

    <!-- Help Overlay -->
    <div class="help-overlay" id="help-overlay">
        <div class="help-content">
            <div class="modal-header">
                <div class="modal-title">üìñ Quick Start Guide</div>
                <button class="modal-close" onclick="toggleHelp()">‚úï</button>
            </div>

            <div class="info-section">
                <div class="section-title">üó∫Ô∏è Using the Map</div>
                <ul class="info-list">
                    <li>Click markers or sidebar cards to visit locations</li>
                    <li>Click "‚Üí Enter" to zoom into location</li>
                    <li>Use layer buttons (Street/Satellite) to change view</li>
                </ul>
            </div>

            <div class="info-section">
                <div class="section-title">üë§ Character System</div>
                <ul class="info-list">
                    <li>View all characters in the Characters tab</li>
                    <li>Enter a location's tactical map to add characters</li>
                    <li>Click character cards to add them to the battlefield</li>
                    <li>Click tokens to select, click again to drag</li>
                </ul>
            </div>

            <div class="info-section">
                <div class="section-title">‚öîÔ∏è Tactical Maps</div>
                <ul class="info-list">
                    <li>Toggle 5ft grid for tactical view</li>
                    <li>Use "Add Player/Enemy" to open character library</li>
                    <li>Click tokens to select and see movement range</li>
                    <li>Drag tokens to move (snap-to-grid enabled by default)</li>
                    <li>Hover over tokens to see character names</li>
                </ul>
            </div>

            <div class="info-section">
                <div class="section-title">üíæ Saving</div>
                <ul class="info-list">
                    <li>Auto-saves every 30 seconds</li>
                    <li>Export/Import to backup or share</li>
                    <li>Saves track visited locations</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Tactical Overlay -->
    <div class="tactical-overlay" id="tactical-overlay">
        <div class="tactical-header">
            <div class="tactical-title" id="tactical-location-name">‚öîÔ∏è Tactical Map</div>
            <button class="tactical-close" onclick="closeTactical()">‚Üê Back to Map</button>
        </div>

        <div class="tactical-tabs">
            <div class="tactical-tab active" onclick="switchTacticalTab('maps')">üó∫Ô∏è MAPS</div>
            <div class="tactical-tab" onclick="switchTacticalTab('party')">üë• PARTY</div>
            <div class="tactical-tab" onclick="switchTacticalTab('encounters')">üìñ ENCOUNTERS</div>
            <div class="tactical-tab" onclick="switchTacticalTab('combat')">‚öîÔ∏è COMBAT</div>
            <div class="tactical-tab" onclick="switchTacticalTab('notes')">üìù NOTES</div>
            <div class="tactical-tab" onclick="switchTacticalTab('info')">‚ÑπÔ∏è INFO</div>
        </div>

        <div class="tactical-body">
            <!-- MAPS Tab -->
            <div class="tactical-content active" id="tactical-tab-maps">
                <canvas id="tactical-canvas"></canvas>
                <div class="tactical-controls">
                    <div class="control-title">Grid Controls</div>
                    <button class="control-btn active" id="grid-toggle-btn" onclick="tactical.toggleGrid()">Hide Grid</button>
                    <button class="control-btn" id="snap-toggle-btn" onclick="tactical.toggleSnap()">Snap: ON</button>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; opacity: 0.7;">Grid: <span id="grid-info">5ft ‚Ä¢ 30√ó20</span></div>
                </div>
                <div class="token-controls">
                    <button class="token-btn" onclick="tactical.openCharacterLibrary('player')">Add Player</button>
                    <button class="token-btn" onclick="tactical.openCharacterLibrary('enemy')">Add Enemy</button>
                    <button class="token-btn" onclick="tactical.clearTokens()">Clear All</button>
                </div>
                <div class="battle-log" id="battle-log">
                    <div class="log-header">
                        <div class="log-title">‚öîÔ∏è Combat Log</div>
                        <button class="log-clear" onclick="tactical.clearLog()">Clear</button>
                    </div>
                    <div class="log-entries" id="log-entries"></div>
                </div>
            </div>

            <!-- PARTY Tab -->
            <div class="tactical-content" id="tactical-tab-party">
                <div class="tab-panel">
                    <div class="section-header">üë• Party Members</div>
                    <div class="character-list" id="party-list">
                        <div class="character-card">
                            <div class="character-name">Add party members...</div>
                            <div class="character-info">Use the character library to add players</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ENCOUNTERS Tab -->
            <div class="tactical-content" id="tactical-tab-encounters">
                <div class="tab-panel">
                    <div class="section-header">üìñ Active Encounters</div>
                    <div id="encounters-list">
                        <p style="opacity: 0.7; font-size: 0.9rem;">No active encounters</p>
                    </div>
                </div>
            </div>

            <!-- COMBAT Tab -->
            <div class="tactical-content" id="tactical-tab-combat">
                <div class="tab-panel">
                    <div class="section-header">‚öîÔ∏è Combat Tracker</div>
                    <div id="combat-tracker">
                        <p style="opacity: 0.7; font-size: 0.9rem;">Initiative order will appear here</p>
                    </div>
                </div>
            </div>

            <!-- NOTES Tab -->
            <div class="tactical-content" id="tactical-tab-notes">
                <div class="tab-panel">
                    <div class="section-header">üìù Notes</div>
                    <textarea id="tactical-notes" style="width: 100%; height: 400px; background: rgba(26, 20, 16, 0.5); border: 2px solid var(--secondary); color: var(--text); padding: 1rem; border-radius: 6px; font-family: Georgia, serif; font-size: 0.9rem;" placeholder="Campaign notes..."></textarea>
                </div>
            </div>

            <!-- INFO Tab -->
            <div class="tactical-content" id="tactical-tab-info">
                <div class="tab-panel">
                    <div class="section-header">‚ÑπÔ∏è Location Information</div>
                    <div id="location-info-detail"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CAMPAIGN DATA - Embedded for simplicity
        const CAMPAIGN = {
            "washington-camp": {
                name: "Washington's Encampment",
                coords: [40.2976, -74.8900],
                type: "continental",
                icon: "‚õ∫",
                faction: "Continental Army",
                desc: "General Washington's command tent on the Pennsylvania side.",
                info: "On Christmas night 1776, approximately 2,400 Continental Army troops assembled here. The password: 'Victory or Death'.",
                dmOnly: "Cell #4 holds prisoner A.G. Achilles - rescued during the Old Barracks raid.",
                placeholderImage: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Continental_Army_camp_-_Valley_Forge.jpg/1280px-Continental_Army_camp_-_Valley_Forge.jpg"
            },
            "river-crossing": {
                name: "Delaware River Crossing",
                coords: [40.2950, -74.8650],
                type: "crossing",
                icon: "üö£",
                faction: "Continental Army",
                desc: "McConkey's Ferry. 2,400 troops crossed Christmas night.",
                info: "Durham boats ferried troops across ice floes for 9 hours. One of the most iconic moments in American history.",
                dmOnly: null,
                placeholderImage: "https://upload.wikimedia.org/wikipedia/commons/thumb/9/95/Washington_Crossing_the_Delaware_by_Emanuel_Leutze%2C_MMA-NYC%2C_1851.jpg/1280px-Washington_Crossing_the_Delaware_by_Emanuel_Leutze%2C_MMA-NYC%2C_1851.jpg"
            },
            "old-barracks": {
                name: "The Old Barracks",
                coords: [40.2190, -74.7608],
                type: "quest",
                icon: "‚öîÔ∏è",
                faction: "Hessian / British",
                desc: "Hessian garrison.",
                playerDesc: "Hessian garrison. Important objective.",
                info: "Built in 1758, still standing today! Approximately 40-50 Hessian soldiers were quartered here. Some were captured in their bunks.",
                dmOnly: "A.G. Achilles imprisoned in Cell #4. Rescue mission objective. 4 guards outside, 2 inside near cell.",
                placeholderImage: "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/Old_Barracks_Trenton_NJ.jpg/1280px-Old_Barracks_Trenton_NJ.jpg"
            },
            "rall-hq": {
                name: "Rall's Headquarters",
                coords: [40.2195, -74.7592],
                type: "hessian",
                icon: "üèõÔ∏è",
                faction: "Hessian / British",
                desc: "Colonel Rall's command at Stacy's Tavern.",
                info: "Colonel Rall was playing cards when the attack began. An unread warning note was found in his pocket after he died.",
                dmOnly: "Contains intelligence documents about troop movements.",
                placeholderImage: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/df/Colonial_tavern_interior.jpg/1024px-Colonial_tavern_interior.jpg"
            },
            "king-street": {
                name: "King Street Battery",
                coords: [40.2210, -74.7615],
                type: "hessian",
                icon: "üõ°Ô∏è",
                faction: "Hessian / British",
                desc: "Northern artillery with 6-pounder cannon.",
                info: "Main northern defense. Artillery pieces were captured early in the battle when crews were caught off-guard.",
                dmOnly: null,
                placeholderImage: "https://upload.wikimedia.org/wikipedia/commons/thumb/1/1f/Revolutionary_War_Cannon.jpg/1280px-Revolutionary_War_Cannon.jpg"
            },
            "queen-street": {
                name: "Queen Street Battery",
                coords: [40.2175, -74.7600],
                type: "hessian",
                icon: "üõ°Ô∏è",
                faction: "Hessian / British",
                desc: "Southern artillery position.",
                info: "Crews struggled to serve their pieces in the sleet and snow. Position was abandoned as Hessians attempted to retreat.",
                dmOnly: null,
                placeholderImage: "https://upload.wikimedia.org/wikipedia/commons/thumb/2/2c/18th_century_artillery_position.jpg/1280px-18th_century_artillery_position.jpg"
            },
            "assunpink": {
                name: "Assunpink Creek Bridge",
                coords: [40.2145, -74.7598],
                type: "continental",
                icon: "üåâ",
                faction: "Continental Army",
                desc: "Continental fallback position.",
                info: "Washington's planned escape route became a trap for the Hessians. Americans blocked the bridge, forcing surrender.",
                dmOnly: null,
                placeholderImage: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6a/Old_stone_bridge_winter.jpg/1280px-Old_stone_bridge_winter.jpg"
            }
        };

        // CHARACTER LIBRARY
        let CHARACTERS = {};

        // Load characters from JSON
        fetch('campaigns/american-revolution.json')
            .then(res => res.json())
            .then(data => {
                CHARACTERS = data.characters || {};
                console.log('Loaded characters:', Object.keys(CHARACTERS).length);

                // Re-render character library after loading
                if (window.app) {
                    app.renderCharacters();
                }

                // Re-render tactical character library if in tactical view
                if (window.tactical && tactical.currentLocation) {
                    tactical.renderCharacterLibrary(tactical.currentLocation);
                }
            })
            .catch(err => console.error('Failed to load characters:', err));

        // TACTICAL GRID SYSTEM
        class TacticalGrid {
            constructor() {
                this.canvas = null;
                this.ctx = null;
                this.gridSize = 40; // pixels per square
                this.gridFeet = 5; // feet per square
                this.cols = 30;
                this.rows = 20;
                this.showGrid = true;
                this.snapToGrid = true;
                this.backgroundImage = null;
                this.tokens = [];
                this.selectedToken = null;
                this.hoveredToken = null;
                this.isDragging = false;
                this.dragOffset = { x: 0, y: 0 };
                this.battleLog = [];
                this.currentLocation = null;
            }

            init(locationKey, location) {
                this.canvas = document.getElementById('tactical-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.currentLocation = locationKey;

                // Set canvas size
                this.canvas.width = this.cols * this.gridSize;
                this.canvas.height = this.rows * this.gridSize;

                document.getElementById('grid-info').textContent = `${this.gridFeet}ft ‚Ä¢ ${this.cols}√ó${this.rows}`;

                // Try to load background image
                this.loadBackground(locationKey, location);

                // Setup event listeners
                this.setupEventListeners();

                // Initial draw
                this.draw();

                // Add log entry
                this.addLog(`Entered ${location.name}`, 'info');

                // Update INFO tab with location details
                this.updateLocationInfo(location);

                // Update PARTY tab to show character library
                this.renderCharacterLibrary(locationKey);
            }

            loadBackground(key, location) {
                const possiblePaths = [
                    `campaign-images/${key}/background.jpg`,
                    `campaign-images/${key}/background.png`,
                    `campaign-images/${key}/background.webp`,
                    location.placeholderImage
                ];

                const tryLoad = (index = 0) => {
                    if (index >= possiblePaths.length || !possiblePaths[index]) {
                        this.draw();
                        return;
                    }

                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = () => {
                        this.backgroundImage = img;
                        this.draw();
                    };
                    img.onerror = () => tryLoad(index + 1);
                    img.src = possiblePaths[index];
                };

                tryLoad();
            }

            setupEventListeners() {
                this.canvas.addEventListener('mousedown', (e) => this.onMouseDown(e));
                this.canvas.addEventListener('mousemove', (e) => this.onMouseMove(e));
                this.canvas.addEventListener('mouseup', () => this.onMouseUp());
                this.canvas.addEventListener('mouseleave', () => this.onMouseUp());
            }

            onMouseDown(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                // Check if clicking on a token
                for (let i = this.tokens.length - 1; i >= 0; i--) {
                    const token = this.tokens[i];
                    const dx = x - token.x;
                    const dy = y - token.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < this.gridSize * 0.4) {
                        if (this.selectedToken === token) {
                            // Already selected - start dragging
                            this.isDragging = true;
                            this.dragOffset = { x: dx, y: dy };
                        } else {
                            // Select this token
                            this.selectedToken = token;
                            this.isDragging = false;
                            this.draw();
                        }
                        return;
                    }
                }

                // Clicked empty space - deselect
                this.selectedToken = null;
                this.isDragging = false;
                this.draw();
            }

            onMouseMove(e) {
                const rect = this.canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                // Handle dragging
                if (this.selectedToken && this.isDragging) {
                    let x = mouseX - this.dragOffset.x;
                    let y = mouseY - this.dragOffset.y;

                    if (this.snapToGrid) {
                        // Snap to center of grid squares, not intersections
                        x = Math.round(x / this.gridSize) * this.gridSize + this.gridSize / 2;
                        y = Math.round(y / this.gridSize) * this.gridSize + this.gridSize / 2;
                    }

                    this.selectedToken.x = x;
                    this.selectedToken.y = y;
                    this.draw();
                    return;
                }

                // Check for hover over tokens
                let hovering = false;
                for (let i = this.tokens.length - 1; i >= 0; i--) {
                    const token = this.tokens[i];
                    const dx = mouseX - token.x;
                    const dy = mouseY - token.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < this.gridSize * 0.4) {
                        this.hoveredToken = token;
                        this.canvas.style.cursor = 'pointer';
                        hovering = true;
                        this.draw();
                        return;
                    }
                }

                // Not hovering over anything
                if (!hovering && this.hoveredToken) {
                    this.hoveredToken = null;
                    this.canvas.style.cursor = 'crosshair';
                    this.draw();
                }
            }

            onMouseUp() {
                this.isDragging = false;
                this.draw();
            }

            toggleGrid() {
                this.showGrid = !this.showGrid;
                const btn = document.getElementById('grid-toggle-btn');
                btn.textContent = this.showGrid ? 'Hide Grid' : 'Show Grid';
                btn.classList.toggle('active', this.showGrid);
                this.draw();
            }

            toggleSnap() {
                this.snapToGrid = !this.snapToGrid;
                const btn = document.getElementById('snap-toggle-btn');
                btn.textContent = `Snap: ${this.snapToGrid ? 'ON' : 'OFF'}`;
                btn.classList.toggle('active', this.snapToGrid);
            }

            addToken(type) {
                // Center tokens within grid squares, not at intersections
                const centerX = (this.cols / 2) * this.gridSize + this.gridSize / 2;
                const centerY = (this.rows / 2) * this.gridSize + this.gridSize / 2;

                this.tokens.push({
                    type: type,
                    x: centerX,
                    y: centerY,
                    speed: 30, // movement speed in feet
                    selected: false
                });

                this.addLog(`Added ${type} token to battlefield`, 'info');
                this.draw();
            }

            clearTokens() {
                const count = this.tokens.length;
                this.tokens = [];
                if (count > 0) {
                    this.addLog(`Cleared ${count} token(s) from battlefield`, 'info');
                }
                this.draw();
            }

            updateLocationInfo(location) {
                const container = document.getElementById('location-info-detail');
                if (!container) return;

                container.innerHTML = `
                    <div class="info-section">
                        <div class="section-title">üìç ${location.icon} ${location.name}</div>
                        <div class="info-text">${location.info}</div>
                    </div>
                    ${location.dmOnly && app.dmMode ? `
                        <div class="info-section" style="border: 2px solid #dc2626; background: rgba(220, 38, 38, 0.1);">
                            <div class="section-title">üé≤ DM Only</div>
                            <div class="info-text">${location.dmOnly}</div>
                        </div>
                    ` : ''}
                `;
            }

            draw() {
                // Clear canvas
                this.ctx.fillStyle = '#2a2a2a';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                // Draw background image
                if (this.backgroundImage) {
                    this.ctx.globalAlpha = 0.7;
                    this.ctx.drawImage(
                        this.backgroundImage,
                        0, 0,
                        this.canvas.width,
                        this.canvas.height
                    );
                    this.ctx.globalAlpha = 1.0;
                }

                // Draw grid
                if (this.showGrid) {
                    this.drawGrid();
                }

                // Draw tokens
                this.tokens.forEach(token => this.drawToken(token));
            }

            drawGrid() {
                this.ctx.strokeStyle = 'rgba(212, 175, 55, 0.3)';
                this.ctx.lineWidth = 1;

                // Vertical lines
                for (let x = 0; x <= this.cols; x++) {
                    const px = x * this.gridSize;
                    this.ctx.beginPath();
                    this.ctx.moveTo(px, 0);
                    this.ctx.lineTo(px, this.canvas.height);
                    this.ctx.stroke();

                    // Labels every 5 squares
                    if (x % 5 === 0 && x > 0) {
                        this.ctx.fillStyle = '#d4af37';
                        this.ctx.font = 'bold 12px monospace';
                        this.ctx.fillText(x.toString(), px - 10, 15);
                    }
                }

                // Horizontal lines
                for (let y = 0; y <= this.rows; y++) {
                    const py = y * this.gridSize;
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, py);
                    this.ctx.lineTo(this.canvas.width, py);
                    this.ctx.stroke();

                    // Labels every 5 squares
                    if (y % 5 === 0 && y > 0) {
                        this.ctx.fillStyle = '#d4af37';
                        this.ctx.font = 'bold 12px monospace';
                        this.ctx.fillText(y.toString(), 5, py - 5);
                    }
                }
            }

            drawToken(token) {
                const isHovered = token === this.hoveredToken;
                const isSelected = token === this.selectedToken;
                const radius = this.gridSize * 0.35 * (isHovered ? 1.15 : 1);

                // Draw movement range (glowing circle) - only when selected and NOT dragging
                if (isSelected && !this.isDragging) {
                    const moveSquares = Math.floor(token.speed / this.gridFeet);
                    const moveRadius = moveSquares * this.gridSize;

                    // Outer glow
                    const gradient = this.ctx.createRadialGradient(token.x, token.y, 0, token.x, token.y, moveRadius);
                    gradient.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
                    gradient.addColorStop(0.7, 'rgba(59, 130, 246, 0.1)');
                    gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
                    this.ctx.fillStyle = gradient;
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                    // Range circle
                    this.ctx.strokeStyle = 'rgba(59, 130, 246, 0.6)';
                    this.ctx.lineWidth = 2;
                    this.ctx.beginPath();
                    this.ctx.arc(token.x, token.y, moveRadius, 0, Math.PI * 2);
                    this.ctx.stroke();
                }

                // Draw hover glow
                if (isHovered && !isSelected) {
                    this.ctx.save();
                    this.ctx.shadowColor = token.type === 'player' ? '#3b82f6' : '#dc2626';
                    this.ctx.shadowBlur = 20;
                    this.ctx.beginPath();
                    this.ctx.arc(token.x, token.y, radius, 0, Math.PI * 2);
                    this.ctx.strokeStyle = token.type === 'player' ? '#3b82f6' : '#dc2626';
                    this.ctx.lineWidth = 1;
                    this.ctx.stroke();
                    this.ctx.restore();
                }

                // Draw token
                this.ctx.save();

                // Shadow
                this.ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                this.ctx.shadowBlur = isHovered ? 12 : 8;
                this.ctx.shadowOffsetX = 2;
                this.ctx.shadowOffsetY = 2;

                // Token circle
                this.ctx.fillStyle = token.type === 'player' ? '#3b82f6' : '#dc2626';
                this.ctx.beginPath();
                this.ctx.arc(token.x, token.y, radius, 0, Math.PI * 2);
                this.ctx.fill();

                // Border
                this.ctx.strokeStyle = isSelected ? '#d4af37' : (isHovered ? '#fff' : 'rgba(255, 255, 255, 0.8)');
                this.ctx.lineWidth = isSelected ? 4 : (isHovered ? 3 : 2);
                this.ctx.stroke();

                this.ctx.restore();

                // Icon
                this.ctx.fillStyle = 'white';
                this.ctx.font = `bold ${this.gridSize * 0.4 * (isHovered ? 1.1 : 1)}px Arial`;
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillText(token.type === 'player' ? '‚óè' : '‚ñ≤', token.x, token.y);

                // Character name label (if character token or hovered)
                if (token.character && (isHovered || isSelected)) {
                    this.ctx.save();
                    this.ctx.fillStyle = 'rgba(0, 0, 0, 0.9)';
                    this.ctx.font = 'bold 11px Arial';
                    const nameWidth = this.ctx.measureText(token.character.name).width;
                    const labelY = token.y + this.gridSize * 0.5;
                    this.ctx.fillRect(token.x - nameWidth/2 - 4, labelY, nameWidth + 8, 16);

                    this.ctx.fillStyle = token.type === 'player' ? '#3b82f6' : '#dc2626';
                    this.ctx.fillText(token.character.name, token.x, labelY + 11);
                    this.ctx.restore();
                }
            }

            loadLocationCharacters(locationKey) {
                // Auto-load character tokens for this location
                Object.values(CHARACTERS).forEach(char => {
                    if (char.location === locationKey) {
                        this.addCharacterToken(char);
                    }
                });
            }

            addCharacterToken(character) {
                // Center tokens within grid squares, not at intersections
                const centerX = (this.cols / 2) * this.gridSize + this.gridSize / 2;
                const centerY = (this.rows / 2) * this.gridSize + this.gridSize / 2;

                // Add some randomness to prevent tokens from stacking
                const randomOffsetX = Math.floor(Math.random() * 5 - 2) * this.gridSize;
                const randomOffsetY = Math.floor(Math.random() * 5 - 2) * this.gridSize;
                const finalX = centerX + randomOffsetX;
                const finalY = centerY + randomOffsetY;

                this.tokens.push({
                    type: character.type || 'player',
                    x: finalX,
                    y: finalY,
                    speed: character.speed || 30,
                    character: character,
                    name: character.name,
                    selected: false
                });

                this.addLog(`${character.name} entered battlefield`, character.type === 'enemy' ? 'combat' : 'movement');
                this.draw();
            }

            renderCharacterLibrary(locationKey) {
                const container = document.getElementById('party-list');
                if (!container) return;

                const locationCharacters = Object.values(CHARACTERS).filter(c => c.location === locationKey);

                if (locationCharacters.length === 0) {
                    container.innerHTML = `
                        <div class="character-card">
                            <div class="character-name">No characters at this location</div>
                            <div class="character-info">Use the main Characters tab to view all characters</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="section-header" style="margin-bottom: 1rem;">Available Characters</div>
                    <div class="character-list">
                        ${locationCharacters.map(char => {
                            const onMap = this.tokens.some(t => t.character && t.character.id === char.id);
                            return `
                                <div class="character-card" onclick="tactical.${onMap ? 'selectCharacterToken' : 'addCharacterFromLibrary'}('${char.id}')">
                                    <div class="character-name">${char.name}</div>
                                    <div class="character-info">${char.title || ''}</div>
                                    <div class="character-info" style="margin-top: 0.5rem; font-size: 0.75rem;">
                                        <strong>Speed:</strong> ${char.speed || 30} ft
                                        <br><strong>Faction:</strong> ${char.faction}
                                    </div>
                                    ${char.description ? `<p style="margin-top: 0.5rem; font-size: 0.75rem; opacity: 0.8;">${char.description}</p>` : ''}
                                    <div style="margin-top: 0.8rem; padding: 0.4rem; background: ${onMap ? 'rgba(22, 163, 74, 0.2)' : 'rgba(59, 130, 246, 0.2)'}; border-radius: 4px; text-align: center; font-size: 0.75rem; font-weight: bold;">
                                        ${onMap ? '‚úì On Map - Click to Select' : '+ Click to Add to Map'}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            selectCharacterToken(characterId) {
                // Find and select the token for this character
                const token = this.tokens.find(t => t.character && t.character.id === characterId);
                if (token) {
                    this.selectedToken = token;
                    this.isDragging = false;
                    this.draw();
                    this.addLog(`Selected ${token.name}`, 'info');
                    // Switch to MAPS tab to see the selected token
                    switchTacticalTab('maps');
                }
            }

            openCharacterLibrary(type) {
                // Switch to PARTY tab to show character library
                switchTacticalTab('party');
                this.addLog(`Opening character library (${type === 'player' ? 'Continental' : 'Hessian'} forces)`, 'info');
            }

            addCharacterFromLibrary(characterId) {
                // Look up character in CHARACTERS object
                const character = CHARACTERS[characterId];
                if (character) {
                    this.addCharacterToken(character);
                    // Re-render library to update status
                    this.renderCharacterLibrary(this.currentLocation);
                    // Switch to MAPS tab to see the token
                    switchTacticalTab('maps');
                }
            }

            addLog(message, type = 'info') {
                const time = new Date().toLocaleTimeString();
                this.battleLog.unshift({ time, message, type });
                if (this.battleLog.length > 50) this.battleLog.pop();
                this.renderLog();
            }

            clearLog() {
                this.battleLog = [];
                this.renderLog();
            }

            renderLog() {
                const container = document.getElementById('log-entries');
                if (!container) return;

                if (this.battleLog.length === 0) {
                    container.innerHTML = '<p style="opacity: 0.7; font-size: 0.8rem;">No combat events yet</p>';
                    return;
                }

                container.innerHTML = this.battleLog.map(entry => `
                    <div class="log-entry ${entry.type}">
                        <div class="log-time">${entry.time}</div>
                        <div>${entry.message}</div>
                    </div>
                `).join('');
            }

            cleanup() {
                this.tokens = [];
                this.selectedToken = null;
                this.backgroundImage = null;
                this.battleLog = [];
                this.renderLog();
            }
        }

        class CampaignApp {
            constructor() {
                this.map = null;
                this.tacticalMap = null;
                this.markers = {};
                this.state = { visited: [], images: {} };
                this.gridLayer = null;
                this.gridVisible = false;
                this.gridSize = 5;
                this.backgroundLayer = null;
                this.currentTactical = null;
                this.dmMode = true; // Default to DM mode

                this.layers = {
                    street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19
                    }),
                    satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        maxZoom: 22
                    }),
                    terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                        maxZoom: 17
                    })
                };

                this.currentLayer = 'satellite';
            }

            init() {
                this.load();
                this.setupMap();
                this.render();
                this.setupEventListeners();

                // Set DM mode button as active by default
                document.getElementById('dm-mode-toggle').classList.add('active');

                // Show help banner for first-time users
                if (!this.state.visited || this.state.visited.length === 0) {
                    this.showHelpBanner();
                }

                // Auto-save every 30 seconds
                setInterval(() => this.save(), 30000);
            }

            setupMap() {
                this.map = L.map('map', {
                    center: [40.2190, -74.7608],
                    zoom: 13
                });

                this.layers.satellite.addTo(this.map);

                Object.keys(CAMPAIGN).forEach(key => this.createMarker(key));
                L.control.scale({ position: 'bottomleft', imperial: true }).addTo(this.map);
            }

            setLayer(type) {
                this.map.removeLayer(this.layers[this.currentLayer]);
                this.layers[type].addTo(this.map);
                this.currentLayer = type;

                document.querySelectorAll('.layer-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`layer-${type}`).classList.add('active');
            }

            createMarker(key) {
                const loc = CAMPAIGN[key];
                const html = `<div class="marker-pin ${loc.type}"><div class="marker-icon">${loc.icon}</div></div>`;

                const marker = L.marker(loc.coords, {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: html,
                        iconSize: [40, 40],
                        iconAnchor: [20, 40]
                    })
                }).addTo(this.map);

                const popupHTML = `
                    <div class="popup-title">${loc.icon} ${loc.name}</div>
                    <div class="popup-desc">${loc.desc}</div>
                    <div class="popup-actions">
                        <button class="popup-btn" onclick="app.showInfo('${key}')">üìñ Info</button>
                        <button class="popup-btn tactical" onclick="app.openTactical('${key}')">‚Üí Enter</button>
                    </div>
                `;

                marker.bindPopup(popupHTML);
                marker.on('click', () => this.select(key));

                // Faction color for tooltip
                const factionColor = loc.faction.includes('Continental') ? '#3b82f6' :
                                   loc.faction.includes('Hessian') ? '#f59e0b' : '#06b6d4';

                marker.bindTooltip(`
                    <div style="text-align: center;">
                        <div style="font-weight: bold; margin-bottom: 0.2rem;">${loc.icon} ${loc.name}</div>
                        <div style="font-size: 0.75rem; color: ${factionColor}; font-weight: bold;">${loc.faction}</div>
                    </div>
                `, {
                    permanent: false,
                    direction: 'top',
                    offset: [0, -35],
                    className: 'custom-tooltip'
                });

                this.markers[key] = marker;
            }

            select(key) {
                const loc = CAMPAIGN[key];

                if (!this.state.visited.includes(key)) {
                    this.state.visited.push(key);
                    this.save();
                }

                this.map.flyTo(loc.coords, 16, { duration: 1.5 });
                this.markers[key].openPopup();
                this.render();
            }

            showInfo(key) {
                const loc = CAMPAIGN[key];
                document.getElementById('info-title').textContent = `${loc.icon} ${loc.name}`;
                document.getElementById('info-subtitle').textContent = `${loc.coords[0].toFixed(4)}¬∞N, ${Math.abs(loc.coords[1]).toFixed(4)}¬∞W ‚Ä¢ ${loc.faction}`;

                let dmSection = '';
                if (this.dmMode && loc.dmOnly) {
                    dmSection = `
                        <div class="info-section" style="border: 2px solid #dc2626; background: rgba(220, 38, 38, 0.1);">
                            <div class="section-title">üé≤ DM Only</div>
                            <div class="info-text">${loc.dmOnly}</div>
                        </div>
                    `;
                }

                document.getElementById('info-body').innerHTML = `
                    <div class="info-section">
                        <div class="section-title">üìú About</div>
                        <div class="info-text">${loc.info}</div>
                    </div>
                    ${dmSection}
                `;
                document.getElementById('info-modal').classList.add('active');
            }

            toggleDMMode() {
                this.dmMode = !this.dmMode;
                const btn = document.getElementById('dm-mode-toggle');
                if (this.dmMode) {
                    btn.classList.add('active');
                    btn.textContent = 'üé≤ DM Mode';
                } else {
                    btn.classList.remove('active');
                    btn.textContent = 'üë• Player Mode';
                }
            }

            openTactical(key) {
                const loc = CAMPAIGN[key];
                this.currentTactical = key;

                document.getElementById('tactical-location-name').textContent = `${loc.icon} ${loc.name}`;
                document.getElementById('tactical-overlay').classList.add('active');

                // Initialize tactical grid
                setTimeout(() => {
                    if (!window.tactical) {
                        window.tactical = new TacticalGrid();
                    }
                    tactical.init(key, loc);
                }, 50);
            }

            render() {
                this.renderLocations();
                this.renderCharacters();
                document.getElementById('stat-visited').textContent =
                    `${this.state.visited.length} / ${Object.keys(CAMPAIGN).length}`;
            }

            renderLocations() {
                let html = '';
                Object.keys(CAMPAIGN).forEach(key => {
                    const loc = CAMPAIGN[key];
                    const visited = this.state.visited.includes(key);

                    html += `
                        <div class="location-card ${loc.type}" onclick="app.select('${key}')">
                            <div class="location-name">
                                <span>${loc.icon} ${loc.name}</span>
                                <span>
                                    ${visited ? '<span class="badge visited">‚úì</span>' : ''}
                                </span>
                            </div>
                            <div class="location-desc">${loc.desc}</div>
                        </div>
                    `;
                });
                document.getElementById('locations-list').innerHTML = html;
            }

            renderCharacters() {
                const container = document.getElementById('characters-library');
                if (!container) return;

                const allCharacters = Object.values(CHARACTERS);

                if (allCharacters.length === 0) {
                    container.innerHTML = '<p style="opacity: 0.7; font-size: 0.9rem;">Loading characters...</p>';
                    return;
                }

                // Group characters by location
                const byLocation = {};
                allCharacters.forEach(char => {
                    const loc = char.location || 'unknown';
                    if (!byLocation[loc]) byLocation[loc] = [];
                    byLocation[loc].push(char);
                });

                let html = '';
                Object.keys(byLocation).forEach(locationKey => {
                    const location = CAMPAIGN[locationKey];
                    const chars = byLocation[locationKey];

                    html += `
                        <div class="info-section" style="margin-bottom: 1rem;">
                            <div class="section-title">${location ? location.icon + ' ' + location.name : locationKey}</div>
                            ${chars.map(char => `
                                <div class="stat-row" style="flex-direction: column; align-items: flex-start; cursor: default;">
                                    <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 0.3rem;">
                                        <strong>${char.name}</strong>
                                        <span style="font-size: 0.75rem; padding: 0.2rem 0.5rem; background: ${char.type === 'player' ? 'rgba(59, 130, 246, 0.3)' : 'rgba(220, 38, 38, 0.3)'}; border-radius: 3px;">
                                            ${char.faction}
                                        </span>
                                    </div>
                                    <div style="font-size: 0.8rem; opacity: 0.8;">${char.title || ''}</div>
                                    ${char.description ? `<div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.3rem;">${char.description}</div>` : ''}
                                    <div style="font-size: 0.75rem; margin-top: 0.3rem;">
                                        <strong>Speed:</strong> ${char.speed || 30} ft
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                });

                container.innerHTML = html;
            }

            showHelpBanner() {
                const banner = document.getElementById('help-banner');
                banner.classList.add('show');
                setTimeout(() => banner.classList.remove('show'), 5000);
            }

            save() {
                localStorage.setItem('trenton_campaign', JSON.stringify(this.state));
            }

            load() {
                const saved = localStorage.getItem('trenton_campaign');
                if (saved) {
                    try { this.state = JSON.parse(saved); } catch (e) {}
                }
            }

            exportSave() {
                const blob = new Blob([JSON.stringify(this.state, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `trenton_save_${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            reset() {
                if (confirm('Reset campaign? All progress will be lost.')) {
                    localStorage.removeItem('trenton_campaign');
                    location.reload();
                }
            }

            setupEventListeners() {
                document.getElementById('import-file').onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            this.state = JSON.parse(ev.target.result);
                            this.save();
                            this.render();
                            alert('Save imported successfully!');
                        } catch (err) {
                            alert('Import failed - invalid file');
                        }
                    };
                    reader.readAsText(file);
                };
            }
        }

        const app = new CampaignApp();

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('hidden');
        }

        function showTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + name).classList.add('active');
        }

        function closeInfo() {
            document.getElementById('info-modal').classList.remove('active');
        }

        function toggleHelp() {
            document.getElementById('help-overlay').classList.toggle('active');
        }

        function closeTactical() {
            document.getElementById('tactical-overlay').classList.remove('active');
            if (window.tactical) {
                tactical.cleanup();
            }
        }

        function switchTacticalTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tactical-tab').forEach(tab => tab.classList.remove('active'));

            // Find and activate the correct tab button
            const tabs = document.querySelectorAll('.tactical-tab');
            const tabIndex = ['maps', 'party', 'encounters', 'combat', 'notes', 'info'].indexOf(tabName);
            if (tabIndex >= 0 && tabs[tabIndex]) {
                tabs[tabIndex].classList.add('active');
            }

            // Update tab content
            document.querySelectorAll('.tactical-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tactical-tab-${tabName}`).classList.add('active');
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => app.init());
        } else {
            app.init();
        }
    </script>
</body>
</html>
