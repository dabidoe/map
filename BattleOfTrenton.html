<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battle of Trenton - Campaign Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=IM+Fell+English:ital@0;1&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #1e3a5f;
            --secondary: #d4af37;
            --accent: #dc2626;
            --success: #16a34a;
            --bg-dark: #0a0a0a;
            --bg-light: #1a1410;
            --text: #f4e8d0;

            /* Fantasy mode colors */
            --fantasy-parchment: #f4e4c1;
            --fantasy-shadow: #4a2511;
            --fantasy-water: #5b8fa3;
            --fantasy-ink: #2c1810;
            --fantasy-border: #8b6f47;
        }

        /* Fantasy Mode Active */
        body.fantasy-mode {
            --text: #2c1810;
        }

        body {
            font-family: Georgia, serif;
            background: var(--bg-dark);
            color: var(--text);
            overflow: hidden;
        }

        /* Map */
        #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }

        /* Quick Help Banner */
        .help-banner {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--primary), #0f1f3a);
            border: 2px solid var(--secondary);
            border-radius: 8px;
            padding: 0.8rem 1.5rem;
            z-index: 3000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.8);
            display: none;
        }

        .help-banner.show { display: block; }

        .help-text {
            font-size: 0.9rem;
            text-align: center;
        }

        /* Layer Control */
        .layer-control {
            position: fixed;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, var(--primary), #0f1f3a);
            border: 2px solid var(--secondary);
            border-radius: 6px;
            padding: 0.5rem;
            z-index: 1500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }

        .layer-btn {
            background: rgba(26, 20, 16, 0.5);
            border: 1px solid var(--secondary);
            color: var(--text);
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.75rem;
            font-family: Georgia, serif;
            transition: all 0.2s;
            display: block;
            width: 100%;
            margin-bottom: 0.3rem;
        }

        .layer-btn:last-child { margin-bottom: 0; }
        .layer-btn:hover, .layer-btn.active {
            background: var(--secondary);
            color: var(--primary);
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 350px;
            height: 100vh;
            background: linear-gradient(180deg, var(--bg-light), var(--bg-dark));
            border-right: 3px solid var(--secondary);
            transition: transform 0.3s ease;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 20px rgba(0,0,0,0.5);
        }

        .sidebar.hidden { transform: translateX(-350px); }

        .toggle-btn {
            position: fixed;
            left: 10px;
            top: 10px;
            background: linear-gradient(135deg, var(--primary), #0f1f3a);
            color: var(--secondary);
            border: 2px solid var(--secondary);
            padding: 0.6rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            z-index: 2001;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            transition: all 0.3s;
            display: none;
        }

        .sidebar.hidden ~ .toggle-btn { display: block; }
        .toggle-btn:hover {
            background: linear-gradient(135deg, var(--secondary), #b8941f);
            color: var(--primary);
            transform: scale(1.05);
        }

        .sidebar-header {
            background: linear-gradient(135deg, var(--primary), #0f1f3a);
            padding: 1.2rem;
            border-bottom: 3px solid var(--secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .campaign-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--secondary);
            margin-bottom: 0.3rem;
        }

        .campaign-meta {
            font-size: 0.8rem;
            opacity: 0.8;
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .close-btn {
            background: transparent;
            border: none;
            color: var(--secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 1;
            transition: all 0.2s;
        }

        .close-btn:hover {
            color: var(--accent);
            transform: scale(1.2);
        }

        /* Tabs */
        .sidebar-tabs {
            display: flex;
            background: rgba(30, 58, 95, 0.3);
            border-bottom: 2px solid var(--secondary);
        }

        .tab {
            flex: 1;
            padding: 0.7rem 0.3rem;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.75rem;
            transition: all 0.3s;
            border-right: 1px solid rgba(212, 175, 55, 0.3);
        }

        .tab:last-child { border-right: none; }
        .tab:hover { background: rgba(212, 175, 55, 0.2); }
        .tab.active { background: rgba(212, 175, 55, 0.3); color: var(--secondary); }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: none;
        }

        .tab-content.active { display: block; }

        /* Location Cards */
        .location-card {
            background: rgba(30, 58, 95, 0.2);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-left: 4px solid var(--primary);
            border-radius: 6px;
            padding: 0.9rem;
            margin-bottom: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .location-card:hover {
            background: rgba(30, 58, 95, 0.4);
            border-left-color: var(--secondary);
            transform: translateX(5px);
        }

        .location-card.active {
            background: rgba(212, 175, 55, 0.2);
            border-color: var(--secondary);
        }

        .location-card.quest { border-left-color: var(--accent); }
        .location-card.continental { border-left-color: #3b82f6; }
        .location-card.hessian { border-left-color: #f59e0b; }
        .location-card.crossing { border-left-color: #06b6d4; }

        .location-name {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 0.4rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .location-desc {
            font-size: 0.85rem;
            opacity: 0.8;
            line-height: 1.4;
        }

        .badge {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 0.3rem;
        }

        .badge.visited { background: var(--success); color: white; }
        .badge.tactical { background: var(--accent); color: white; }
        .badge.has-image { background: #3b82f6; color: white; }

        /* Buttons */
        .btn {
            width: 100%;
            background: linear-gradient(135deg, var(--primary), #0f1f3a);
            color: var(--secondary);
            border: 2px solid var(--secondary);
            padding: 0.7rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
            font-family: Georgia, serif;
            transition: all 0.3s;
            margin-bottom: 0.5rem;
        }

        .btn:hover {
            background: linear-gradient(135deg, var(--secondary), #b8941f);
            color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .btn.danger {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .btn.danger:hover {
            background: #b91c1c;
            border-color: #b91c1c;
        }

        /* Stats */
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.6rem;
            background: rgba(30, 58, 95, 0.2);
            border-radius: 4px;
            margin-bottom: 0.4rem;
            font-size: 0.85rem;
        }

        .stat-value {
            font-weight: bold;
            color: var(--secondary);
        }

        .save-section {
            margin-bottom: 1.5rem;
        }

        .save-label {
            font-weight: bold;
            color: var(--secondary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        /* Info Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 6000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-overlay.active { display: flex; }

        .modal-content {
            background: linear-gradient(135deg, var(--bg-light), var(--bg-dark));
            border: 4px solid var(--secondary);
            border-radius: 12px;
            padding: 2rem;
            max-width: 700px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid var(--secondary);
        }

        .modal-title {
            font-size: 1.7rem;
            color: var(--secondary);
            font-weight: bold;
        }

        .modal-subtitle {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-top: 0.3rem;
        }

        .modal-close {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-family: Georgia, serif;
        }

        .modal-close:hover { background: #b91c1c; }

        .info-section {
            background: rgba(30, 58, 95, 0.2);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 1.3rem;
            margin-bottom: 1.3rem;
        }

        .section-title {
            font-size: 1.1rem;
            color: var(--secondary);
            font-weight: bold;
            margin-bottom: 0.8rem;
        }

        .info-text {
            font-size: 0.95rem;
            line-height: 1.7;
            margin-bottom: 0.8rem;
        }

        .info-list {
            list-style: none;
            padding: 0;
        }

        .info-list li {
            padding: 0.4rem 0 0.4rem 1.3rem;
            position: relative;
            line-height: 1.6;
            font-size: 0.9rem;
        }

        .info-list li:before {
            content: "‚ñ∏";
            position: absolute;
            left: 0;
            color: var(--secondary);
        }

        .historical-fact {
            background: rgba(212, 175, 55, 0.1);
            border-left: 4px solid var(--secondary);
            padding: 0.9rem;
            margin: 0.8rem 0;
            font-style: italic;
        }

        /* Tactical Overlay */
        .tactical-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #f4e4c1; /* Parchment background */
            color: #2c1810; /* Dark ink color */
            z-index: 5000;
        }

        .tactical-overlay.active {
            display: flex;
            flex-direction: column;
        }

        .tactical-header {
            background: linear-gradient(135deg, #8b6f47, #6b5537); /* Brown leather */
            border-bottom: 3px solid var(--secondary);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tactical-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #f4e4c1; /* Light parchment text on dark header */
        }

        .tactical-close {
            background: #8b4513; /* Saddle brown */
            color: #f4e4c1;
            border: 2px solid var(--secondary);
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-family: Georgia, serif;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .tactical-close:hover {
            background: var(--secondary);
            color: #2c1810;
            transform: scale(1.05);
        }

        .tactical-tabs {
            display: flex;
            background: rgba(139, 111, 71, 0.2); /* Light brown tint */
            border-bottom: 3px solid #8b6f47;
            padding: 0 1rem;
            justify-content: space-between;
        }

        .floor-tabs {
            display: none;
            align-items: center;
            gap: 0.5rem;
        }

        .floor-tabs.active {
            display: flex;
        }

        .floor-tab {
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
            background: rgba(139, 111, 71, 0.3);
            border: 2px solid #8b6f47;
            border-radius: 6px;
            transition: all 0.2s;
            color: #2c1810;
        }

        .floor-tab:hover {
            background: rgba(212, 175, 55, 0.4);
            border-color: var(--secondary);
            color: #2c1810;
        }

        .floor-tab.active {
            background: var(--secondary);
            border-color: var(--secondary);
            color: #2c1810;
        }

        .tactical-tab {
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
            border-bottom: 3px solid transparent;
            margin-bottom: -3px;
            transition: all 0.3s;
            color: #2c1810;
        }

        .tactical-tab:hover {
            background: rgba(212, 175, 55, 0.3);
            color: #2c1810;
        }

        .tactical-tab.active {
            background: rgba(212, 175, 55, 0.4);
            border-bottom-color: #8b6f47;
            color: #2c1810;
        }

        .tactical-body {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
        }

        .tactical-content {
            display: none;
            flex: 1;
            position: relative;
        }

        .tactical-content.active {
            display: flex;
            flex-direction: column;
        }

        #tactical-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }

        .tactical-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(244, 228, 193, 0.95); /* Light parchment */
            border: 3px solid #8b6f47;
            border-radius: 8px;
            padding: 1rem;
            max-width: 250px;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(74, 37, 17, 0.3);
        }

        .control-title {
            font-weight: bold;
            color: #2c1810;
            margin-bottom: 0.8rem;
            font-size: 0.9rem;
            border-bottom: 2px solid #8b6f47;
            padding-bottom: 0.5rem;
        }

        .control-btn {
            width: 100%;
            background: rgba(139, 111, 71, 0.3);
            border: 2px solid #8b6f47;
            color: #2c1810;
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-family: Georgia, serif;
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: rgba(212, 175, 55, 0.3);
        }

        .control-btn.active {
            background: var(--secondary);
            color: var(--primary);
        }

        .token-controls {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(26, 20, 16, 0.95);
            border: 2px solid var(--secondary);
            border-radius: 8px;
            padding: 0.8rem 1.5rem;
            display: flex;
            gap: 1rem;
            z-index: 100;
        }

        .token-btn {
            background: linear-gradient(135deg, var(--primary), #0f1f3a);
            border: 2px solid var(--secondary);
            color: var(--secondary);
            padding: 0.6rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .token-btn:hover {
            background: var(--secondary);
            color: var(--primary);
            transform: translateY(-2px);
        }

        .token-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* Battle Log */
        .battle-log {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 350px;
            max-height: 300px;
            background: rgba(26, 20, 16, 0.95);
            border: 2px solid var(--secondary);
            border-radius: 8px;
            padding: 1rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--secondary);
        }

        .log-title {
            font-weight: bold;
            color: var(--secondary);
            font-size: 0.9rem;
        }

        .log-clear {
            background: var(--accent);
            border: none;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            font-family: Georgia, serif;
        }

        .log-entries {
            flex: 1;
            overflow-y: auto;
            max-height: 220px;
        }

        .log-entry {
            background: rgba(30, 58, 95, 0.2);
            border-left: 3px solid var(--secondary);
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .log-entry.combat { border-left-color: var(--accent); }
        .log-entry.movement { border-left-color: #3b82f6; }
        .log-entry.info { border-left-color: var(--secondary); }

        .log-time {
            font-size: 0.7rem;
            opacity: 0.6;
            font-family: 'Courier New', monospace;
        }

        .tab-panel {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .section-header {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--secondary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--secondary);
        }

        .character-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .character-card {
            background: rgba(30, 58, 95, 0.2);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .character-card:hover {
            background: rgba(30, 58, 95, 0.4);
            border-color: var(--secondary);
            transform: translateY(-3px);
        }

        .character-name {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 0.3rem;
            color: var(--secondary);
        }

        .character-info {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Markers */
        .custom-marker {
            background: none;
            border: none;
        }

        /* New Fantasy Marker Containers */
        .marker-container {
            cursor: pointer;
            transition: all 0.3s ease;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
        }

        .marker-container:hover {
            transform: scale(1.15);
            filter: drop-shadow(0 6px 12px rgba(0,0,0,0.5));
        }

        .marker-container.quest {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% {
                filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
                transform: scale(1);
            }
            50% {
                filter: drop-shadow(0 6px 16px rgba(220, 38, 38, 0.6));
                transform: scale(1.08);
            }
        }

        .marker-container svg {
            display: block;
        }

        /* Leaflet Popup */
        .leaflet-popup-content-wrapper {
            background: rgba(26, 20, 16, 0.98);
            color: var(--text);
            border: 3px solid var(--secondary);
            border-radius: 8px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.7);
        }

        .leaflet-popup-content {
            font-family: Georgia, serif;
            margin: 1.2rem;
            min-width: 220px;
        }

        .leaflet-popup-tip { background: rgba(26, 20, 16, 0.98); }

        .popup-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--secondary);
            margin-bottom: 0.5rem;
        }

        .popup-desc {
            font-size: 0.9rem;
            margin-bottom: 0.8rem;
            line-height: 1.5;
        }

        .popup-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .popup-btn {
            background: var(--primary);
            color: var(--secondary);
            border: 1px solid var(--secondary);
            padding: 0.6rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-family: Georgia, serif;
            font-size: 0.8rem;
            transition: all 0.3s;
        }

        .popup-btn:hover {
            background: var(--secondary);
            color: var(--primary);
        }

        .popup-btn.tactical {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
            grid-column: 1 / -1;
        }

        .popup-btn.tactical:hover { background: #b91c1c; }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 4px;
            margin: 0.5rem 0;
        }

        .grid-overlay {
            pointer-events: none;
            z-index: 600;
        }

        .grid-line {
            fill: none;
            stroke: rgba(212, 175, 55, 0.4);
            stroke-width: 1.5;
        }

        .grid-line.major {
            stroke: rgba(212, 175, 55, 0.6);
            stroke-width: 2;
        }

        .grid-label {
            fill: var(--secondary);
            font-size: 12px;
            font-weight: bold;
            text-anchor: middle;
            paint-order: stroke;
            stroke: rgba(0, 0, 0, 0.9);
            stroke-width: 3px;
            font-family: 'Courier New', monospace;
        }

        /* Contextual Help Icon */
        .help-icon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), #0f1f3a);
            border: 2px solid var(--secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--secondary);
            cursor: pointer;
            z-index: 3000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            transition: all 0.3s;
        }

        .help-icon:hover {
            background: linear-gradient(135deg, var(--secondary), #b8941f);
            color: var(--primary);
            transform: scale(1.1);
        }

        .help-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 4000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .help-overlay.active { display: flex; }

        .help-content {
            background: linear-gradient(135deg, var(--bg-light), var(--bg-dark));
            border: 4px solid var(--secondary);
            border-radius: 12px;
            padding: 2rem;
            max-width: 700px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
        }

        /* FANTASY MODE STYLES */

        /* Parchment Overlay */
        .parchment-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 2;
            background-image:
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(74, 37, 17, 0.03) 2px, rgba(74, 37, 17, 0.03) 4px),
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(74, 37, 17, 0.03) 2px, rgba(74, 37, 17, 0.03) 4px);
            mix-blend-mode: multiply;
            opacity: 0.4;
        }

        body.fantasy-mode .parchment-overlay {
            display: block;
        }

        /* Hide parchment overlay when tactical map is open */
        body.fantasy-mode .tactical-overlay.active ~ .parchment-overlay {
            display: none;
        }

        /* Fantasy Map Styling */
        body.fantasy-mode #map {
            filter: sepia(0.6) contrast(1.15) brightness(1.1) saturate(0.7) hue-rotate(10deg);
        }

        /* Enhanced styling for fantasy tiles */
        body.fantasy-mode .leaflet-tile-container {
            filter: grayscale(0.2);
        }

        /* Hide fantasy layer button - use Fantasy Mode toggle instead */
        #layer-fantasy {
            display: none;
        }

        /* Exclude tactical overlay from fantasy styling - KEEP TACTICAL MAP NORMAL */
        body.fantasy-mode .tactical-overlay {
            filter: none !important;
            background: #1a1410 !important;
            font-family: Georgia, serif !important;
        }

        body.fantasy-mode .tactical-overlay * {
            filter: none !important;
            font-family: inherit !important;
        }

        /* Keep tactical overlay dark and readable */
        body.fantasy-mode .tactical-overlay .combat-log,
        body.fantasy-mode .tactical-overlay textarea,
        body.fantasy-mode .tactical-overlay input {
            background: rgba(26, 20, 16, 0.95) !important;
            color: #f4e8d0 !important;
        }

        /* Override fantasy fonts for tactical elements */
        body.fantasy-mode .tactical-title,
        body.fantasy-mode .tactical-tab,
        body.fantasy-mode .tactical-overlay h1,
        body.fantasy-mode .tactical-overlay h2,
        body.fantasy-mode .tactical-overlay h3,
        body.fantasy-mode .tactical-overlay button {
            font-family: Georgia, serif !important;
        }

        /* Decorative Corners */
        .fantasy-corner {
            display: none;
            position: fixed;
            width: 120px;
            height: 120px;
            pointer-events: none;
            z-index: 2500;
            opacity: 0.6;
        }

        body.fantasy-mode .fantasy-corner {
            display: block;
        }

        /* Hide fantasy decorations when tactical map is open */
        body.fantasy-mode .tactical-overlay.active ~ .fantasy-corner,
        body.fantasy-mode .tactical-overlay.active ~ .compass-rose,
        body.fantasy-mode .tactical-overlay.active ~ .fantasy-legend {
            display: none !important;
        }

        .fantasy-corner.top-left {
            top: 0;
            left: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M0,0 L100,0 L100,5 L5,5 L5,100 L0,100 Z M10,10 L90,10 L90,15 L15,15 L15,90 L10,90 Z" fill="%238b6f47" opacity="0.8"/><circle cx="50" cy="50" r="3" fill="%23d4af37"/></svg>') no-repeat;
            background-size: contain;
        }

        .fantasy-corner.top-right {
            top: 0;
            right: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M100,0 L0,0 L0,5 L95,5 L95,100 L100,100 Z M90,10 L10,10 L10,15 L85,15 L85,90 L90,90 Z" fill="%238b6f47" opacity="0.8"/><circle cx="50" cy="50" r="3" fill="%23d4af37"/></svg>') no-repeat;
            background-size: contain;
        }

        .fantasy-corner.bottom-left {
            bottom: 0;
            left: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M0,100 L100,100 L100,95 L5,95 L5,0 L0,0 Z M10,90 L90,90 L90,85 L15,85 L15,10 L10,10 Z" fill="%238b6f47" opacity="0.8"/><circle cx="50" cy="50" r="3" fill="%23d4af37"/></svg>') no-repeat;
            background-size: contain;
        }

        .fantasy-corner.bottom-right {
            bottom: 0;
            right: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M100,100 L0,100 L0,95 L95,95 L95,0 L100,0 Z M90,90 L10,90 L10,85 L85,85 L85,10 L90,10 Z" fill="%238b6f47" opacity="0.8"/><circle cx="50" cy="50" r="3" fill="%23d4af37"/></svg>') no-repeat;
            background-size: contain;
        }

        /* Compass Rose */
        .compass-rose {
            display: none;
            position: fixed;
            bottom: 60px;
            right: 20px;
            width: 100px;
            height: 100px;
            z-index: 2500;
            pointer-events: none;
            opacity: 0.7;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
        }

        body.fantasy-mode .compass-rose {
            display: block;
        }

        /* Fantasy Mode Toggle Button */
        .fantasy-toggle {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: linear-gradient(135deg, var(--primary), #0f1f3a);
            color: var(--secondary);
            border: 2px solid var(--secondary);
            padding: 0.7rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
            font-family: Georgia, serif;
            z-index: 1500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            transition: all 0.3s;
        }

        .fantasy-toggle:hover {
            background: linear-gradient(135deg, var(--secondary), #b8941f);
            color: var(--primary);
            transform: scale(1.05);
        }

        body.fantasy-mode .fantasy-toggle {
            font-family: 'Cinzel', serif;
            background: linear-gradient(135deg, #8b6f47, #6b5537);
            border-color: var(--fantasy-border);
        }

        /* Fantasy Mode Font Changes */
        body.fantasy-mode {
            font-family: 'IM Fell English', serif;
        }

        body.fantasy-mode .campaign-title,
        body.fantasy-mode .modal-title,
        body.fantasy-mode .tactical-title,
        body.fantasy-mode .section-title {
            font-family: 'Cinzel', serif;
        }

        /* Fantasy Marker Styles - Enhanced for SVG icons */
        body.fantasy-mode .marker-container {
            filter: drop-shadow(0 5px 8px rgba(74, 37, 17, 0.5));
        }

        body.fantasy-mode .marker-container:hover {
            transform: scale(1.2);
            filter: drop-shadow(0 7px 15px rgba(139, 111, 71, 0.7));
        }

        /* Fantasy Popup Styling */
        body.fantasy-mode .leaflet-popup-content-wrapper {
            background: var(--fantasy-parchment);
            color: var(--fantasy-ink);
            border: 3px solid var(--fantasy-border);
            box-shadow: 0 8px 30px rgba(74, 37, 17, 0.6), inset 0 0 40px rgba(139, 111, 71, 0.1);
            font-family: 'IM Fell English', serif;
        }

        body.fantasy-mode .leaflet-popup-tip {
            background: var(--fantasy-parchment);
        }

        body.fantasy-mode .popup-title {
            font-family: 'Cinzel', serif;
            color: var(--fantasy-shadow);
            border-bottom: 2px solid var(--fantasy-border);
        }

        body.fantasy-mode .popup-btn {
            background: linear-gradient(135deg, #8b6f47, #6b5537);
            border-color: var(--fantasy-border);
            color: var(--fantasy-parchment);
        }

        body.fantasy-mode .popup-btn:hover {
            background: linear-gradient(135deg, var(--secondary), #b8941f);
            color: var(--fantasy-shadow);
        }

        /* Fantasy Tooltip Styling */
        body.fantasy-mode .leaflet-tooltip {
            background: var(--fantasy-parchment);
            color: var(--fantasy-ink);
            border: 2px solid var(--fantasy-border);
            box-shadow: 0 4px 15px rgba(74, 37, 17, 0.5);
            font-family: 'IM Fell English', serif;
        }

        body.fantasy-mode .leaflet-tooltip::before {
            border-top-color: var(--fantasy-border);
        }

        /* Fantasy Legend */
        .fantasy-legend {
            display: none;
            position: fixed;
            bottom: 130px;
            right: 20px;
            background: var(--fantasy-parchment);
            border: 3px solid var(--fantasy-border);
            border-radius: 8px;
            padding: 1rem;
            z-index: 2500;
            box-shadow: 0 6px 20px rgba(74, 37, 17, 0.6);
            font-family: 'IM Fell English', serif;
            color: var(--fantasy-ink);
            min-width: 180px;
        }

        body.fantasy-mode .fantasy-legend {
            display: block;
        }

        .fantasy-legend-title {
            font-family: 'Cinzel', serif;
            font-weight: bold;
            font-size: 0.95rem;
            margin-bottom: 0.7rem;
            text-align: center;
            color: var(--fantasy-shadow);
            border-bottom: 2px solid var(--fantasy-border);
            padding-bottom: 0.4rem;
        }

        .fantasy-legend-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
        }

        .fantasy-legend-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--fantasy-border);
            background: white;
        }

        .fantasy-legend-icon.quest { background: #dc2626; }
        .fantasy-legend-icon.continental { background: #3b82f6; }
        .fantasy-legend-icon.hessian { background: #f59e0b; }
        .fantasy-legend-icon.crossing { background: #06b6d4; }

        /* Fantasy Mode Sidebar Styling */
        body.fantasy-mode .sidebar {
            background: linear-gradient(180deg, #e8d4a8, #d4c4a0);
            border-right: 4px solid var(--fantasy-border);
            box-shadow: 4px 0 20px rgba(74, 37, 17, 0.5);
        }

        body.fantasy-mode .sidebar-header {
            background: linear-gradient(135deg, #8b6f47, #6b5537);
            border-bottom: 3px solid var(--fantasy-border);
        }

        body.fantasy-mode .campaign-title {
            color: var(--fantasy-parchment);
        }

        body.fantasy-mode .campaign-meta {
            color: rgba(244, 228, 193, 0.8);
        }

        body.fantasy-mode .sidebar-tabs {
            background: rgba(139, 111, 71, 0.3);
            border-bottom: 2px solid var(--fantasy-border);
        }

        body.fantasy-mode .tab {
            color: var(--fantasy-ink);
            border-right: 1px solid rgba(139, 111, 71, 0.5);
        }

        body.fantasy-mode .tab:hover {
            background: rgba(212, 175, 55, 0.3);
        }

        body.fantasy-mode .tab.active {
            background: rgba(212, 175, 55, 0.4);
            color: var(--fantasy-shadow);
        }

        body.fantasy-mode .location-card {
            background: rgba(139, 111, 71, 0.1);
            border: 2px solid rgba(139, 111, 71, 0.3);
            color: var(--fantasy-ink);
        }

        body.fantasy-mode .location-card:hover {
            background: rgba(139, 111, 71, 0.2);
            border-left-color: var(--secondary);
        }

        body.fantasy-mode .location-card.active {
            background: rgba(212, 175, 55, 0.3);
            border-color: var(--secondary);
        }

        body.fantasy-mode .btn {
            background: linear-gradient(135deg, #8b6f47, #6b5537);
            color: var(--fantasy-parchment);
            border-color: var(--fantasy-border);
        }

        body.fantasy-mode .btn:hover {
            background: linear-gradient(135deg, var(--secondary), #b8941f);
            color: var(--fantasy-shadow);
        }

        body.fantasy-mode .layer-control {
            background: linear-gradient(135deg, #8b6f47, #6b5537);
            border-color: var(--fantasy-border);
        }

        body.fantasy-mode .layer-btn {
            background: rgba(244, 228, 193, 0.3);
            border-color: var(--fantasy-border);
            color: var(--fantasy-ink);
        }

        body.fantasy-mode .layer-btn:hover,
        body.fantasy-mode .layer-btn.active {
            background: var(--secondary);
            color: var(--fantasy-shadow);
        }

        body.fantasy-mode .toggle-btn {
            background: linear-gradient(135deg, #8b6f47, #6b5537);
            border-color: var(--fantasy-border);
            color: var(--fantasy-parchment);
        }

        body.fantasy-mode .toggle-btn:hover {
            background: linear-gradient(135deg, var(--secondary), #b8941f);
            color: var(--fantasy-shadow);
        }

        /* Fantasy Mode Modal Styling */
        body.fantasy-mode .modal-content {
            background: var(--fantasy-parchment);
            border-color: var(--fantasy-border);
            box-shadow: 0 8px 40px rgba(74, 37, 17, 0.7);
        }

        body.fantasy-mode .modal-header {
            border-bottom-color: var(--fantasy-border);
        }

        body.fantasy-mode .modal-title {
            color: var(--fantasy-shadow);
        }

        body.fantasy-mode .modal-subtitle {
            color: var(--fantasy-ink);
        }

        body.fantasy-mode .info-section {
            background: rgba(139, 111, 71, 0.1);
            border-color: var(--fantasy-border);
        }

        body.fantasy-mode .section-title {
            color: var(--fantasy-shadow);
        }

        body.fantasy-mode .info-text {
            color: var(--fantasy-ink);
        }

        body.fantasy-mode .info-list li {
            color: var(--fantasy-ink);
        }

        body.fantasy-mode .info-list li:before {
            color: var(--fantasy-shadow);
        }

        body.fantasy-mode .historical-fact {
            background: rgba(212, 175, 55, 0.15);
            border-left-color: var(--fantasy-shadow);
            color: var(--fantasy-ink);
        }

        /* Fantasy Mode Tactical Overlay - Keep Dark Theme */
        /* Tactical overlay stays in dark mode for readability - fantasy only affects main map */
    </style>
</head>
<body>
    <!-- Map -->
    <div id="map"></div>

    <!-- Help Banner -->
    <div class="help-banner" id="help-banner">
        <div class="help-text">üí° Click any location on the map or sidebar to explore!</div>
    </div>

    <!-- Layer Control -->
    <div class="layer-control">
        <button class="layer-btn" id="layer-street" onclick="app.setLayer('street')">Street</button>
        <button class="layer-btn active" id="layer-satellite" onclick="app.setLayer('satellite')">Satellite</button>
        <button class="layer-btn" id="layer-terrain" onclick="app.setLayer('terrain')">Terrain</button>
        <button class="layer-btn" id="layer-fantasy" onclick="app.setLayer('fantasy')">üó∫Ô∏è Fantasy</button>
        <div style="border-top: 1px solid rgba(212, 175, 55, 0.3); margin: 0.5rem 0;"></div>
        <button class="layer-btn" id="dm-mode-toggle" onclick="app.toggleDMMode()">üé≤ DM Mode</button>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div>
                <div class="campaign-title">‚öîÔ∏è Battle of Trenton</div>
                <div class="campaign-meta">
                    <span>üìÖ Dec 25-26, 1776</span>
                    <span>üå°Ô∏è 28¬∞F</span>
                </div>
            </div>
            <button class="close-btn" onclick="toggleSidebar()">√ó</button>
        </div>

        <div class="sidebar-tabs">
            <div class="tab active" onclick="showTab('locations')">üìç Locations</div>
            <div class="tab" onclick="showTab('characters')">üë§ Characters</div>
            <div class="tab" onclick="showTab('save')">üíæ Save</div>
        </div>

        <div class="tab-content active" id="tab-locations">
            <div id="locations-list"></div>
        </div>

        <div class="tab-content" id="tab-characters">
            <div class="save-label">üë§ Character Library</div>
            <p style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 1rem; line-height: 1.5;">
                View all characters in the campaign. Click any location's tactical map to add them to the battlefield.
            </p>
            <div id="characters-library"></div>
        </div>

        <div class="tab-content" id="tab-save">
            <div class="save-section">
                <div class="save-label">üíæ Save Game</div>
                <button class="btn" onclick="app.save()">Save Progress Now</button>
                <button class="btn" onclick="app.exportSave()">üì§ Export Save</button>
                <button class="btn" onclick="document.getElementById('import-file').click()">üì• Import Save</button>
                <input type="file" id="import-file" accept=".json" style="display:none">
            </div>

            <div class="save-section">
                <div class="save-label">üìä Statistics</div>
                <div class="stat-row">
                    <span>Locations Visited</span>
                    <span class="stat-value" id="stat-visited">0 / 7</span>
                </div>
            </div>

            <div class="save-section">
                <div class="save-label">‚ö†Ô∏è Reset</div>
                <button class="btn danger" onclick="app.reset()">Reset Campaign</button>
            </div>
        </div>
    </div>

    <button class="toggle-btn" onclick="toggleSidebar()">üó∫Ô∏è Map</button>

    <!-- Info Modal -->
    <div class="modal-overlay" id="info-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <div class="modal-title" id="info-title">Location</div>
                    <div class="modal-subtitle" id="info-subtitle">Coordinates</div>
                </div>
                <button class="modal-close" onclick="closeInfo()">‚úï</button>
            </div>
            <div id="info-body"></div>
        </div>
    </div>

    <!-- Contextual Help Icon -->
    <div class="help-icon" onclick="toggleHelp()" title="Help">‚ùì</div>

    <!-- Help Overlay -->
    <div class="help-overlay" id="help-overlay">
        <div class="help-content">
            <div class="modal-header">
                <div class="modal-title">üìñ Quick Start Guide</div>
                <button class="modal-close" onclick="toggleHelp()">‚úï</button>
            </div>

            <div class="info-section">
                <div class="section-title">üó∫Ô∏è Using the Map</div>
                <ul class="info-list">
                    <li>Click markers or sidebar cards to visit locations</li>
                    <li>Click "‚Üí Enter" to zoom into location</li>
                    <li>Use layer buttons (Street/Satellite) to change view</li>
                </ul>
            </div>

            <div class="info-section">
                <div class="section-title">üë§ Character System</div>
                <ul class="info-list">
                    <li>View all characters in the Characters tab</li>
                    <li>Enter a location's tactical map to add characters</li>
                    <li>Click character cards to add them to the battlefield</li>
                    <li>Click tokens to select, click again to drag</li>
                </ul>
            </div>

            <div class="info-section">
                <div class="section-title">‚öîÔ∏è Tactical Maps</div>
                <ul class="info-list">
                    <li>Toggle 5ft grid for tactical view</li>
                    <li>Use "Add Player/Enemy" to open character library</li>
                    <li>Click tokens to select and see movement range</li>
                    <li>Drag tokens to move (snap-to-grid enabled by default)</li>
                    <li>Hover over tokens to see character names</li>
                </ul>
            </div>

            <div class="info-section">
                <div class="section-title">üíæ Saving</div>
                <ul class="info-list">
                    <li>Auto-saves every 30 seconds</li>
                    <li>Export/Import to backup or share</li>
                    <li>Saves track visited locations</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Character Add/Edit Modal -->
    <div class="modal-overlay" id="character-modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title" id="character-modal-title">Add Character</div>
                <button class="modal-close" onclick="closeCharacterModal()">‚úï</button>
            </div>
            <div style="padding: 1.5rem;">
                <form id="character-form" onsubmit="saveCharacter(event)">
                    <div style="display: grid; grid-template-columns: 200px 1fr; gap: 1.5rem;">
                        <!-- Left: Image -->
                        <div>
                            <div style="width: 200px; height: 200px; background: rgba(0,0,0,0.3); border: 2px dashed var(--secondary); border-radius: 8px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;">
                                <img id="char-preview" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                <div id="char-placeholder" style="font-size: 4rem; opacity: 0.5;">üë§</div>
                            </div>
                            <input type="text" id="char-image-url" placeholder="Image URL" style="width: 100%; margin-top: 0.5rem; padding: 0.5rem; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary); color: white; border-radius: 4px;" onchange="previewImage(this.value)">
                            <input type="file" id="char-image-upload" accept="image/*" style="width: 100%; margin-top: 0.5rem;" onchange="uploadImage(this)">
                        </div>

                        <!-- Right: Stats -->
                        <div style="display: grid; gap: 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.3rem; opacity: 0.8; font-size: 0.9rem;">Name *</label>
                                    <input type="text" id="char-name" required style="width: 100%; padding: 0.6rem; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary); color: white; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.3rem; opacity: 0.8; font-size: 0.9rem;">Class/Type</label>
                                    <input type="text" id="char-class" placeholder="Fighter, Guard, etc." style="width: 100%; padding: 0.6rem; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary); color: white; border-radius: 4px;">
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.3rem; opacity: 0.8; font-size: 0.9rem;">HP *</label>
                                    <input type="number" id="char-hp" required value="30" style="width: 100%; padding: 0.6rem; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary); color: white; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.3rem; opacity: 0.8; font-size: 0.9rem;">AC *</label>
                                    <input type="number" id="char-ac" required value="15" style="width: 100%; padding: 0.6rem; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary); color: white; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.3rem; opacity: 0.8; font-size: 0.9rem;">Speed</label>
                                    <input type="number" id="char-speed" value="30" style="width: 100%; padding: 0.6rem; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary); color: white; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.3rem; opacity: 0.8; font-size: 0.9rem;">Initiative</label>
                                    <input type="text" id="char-initiative" value="+0" placeholder="+2" style="width: 100%; padding: 0.6rem; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary); color: white; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.3rem; opacity: 0.8; font-size: 0.9rem;">Prof Bonus</label>
                                    <input type="number" id="char-proficiency" value="2" style="width: 100%; padding: 0.6rem; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary); color: white; border-radius: 4px;">
                                </div>
                            </div>

                            <!-- Ability Scores -->
                            <div>
                                <div style="font-weight: bold; margin-bottom: 0.5rem; color: var(--secondary);">Ability Scores</div>
                                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.5rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.3rem; opacity: 0.8; font-size: 0.75rem; text-align: center;">STR</label>
                                        <input type="number" id="char-str" value="10" min="1" max="30" style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary); color: white; border-radius: 4px; text-align: center;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.3rem; opacity: 0.8; font-size: 0.75rem; text-align: center;">DEX</label>
                                        <input type="number" id="char-dex" value="10" min="1" max="30" style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary); color: white; border-radius: 4px; text-align: center;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.3rem; opacity: 0.8; font-size: 0.75rem; text-align: center;">CON</label>
                                        <input type="number" id="char-con" value="10" min="1" max="30" style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary); color: white; border-radius: 4px; text-align: center;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.3rem; opacity: 0.8; font-size: 0.75rem; text-align: center;">INT</label>
                                        <input type="number" id="char-int" value="10" min="1" max="30" style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary); color: white; border-radius: 4px; text-align: center;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.3rem; opacity: 0.8; font-size: 0.75rem; text-align: center;">WIS</label>
                                        <input type="number" id="char-wis" value="10" min="1" max="30" style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary); color: white; border-radius: 4px; text-align: center;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.3rem; opacity: 0.8; font-size: 0.75rem; text-align: center;">CHA</label>
                                        <input type="number" id="char-cha" value="10" min="1" max="30" style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary); color: white; border-radius: 4px; text-align: center;">
                                    </div>
                                </div>
                            </div>

                            <!-- Saving Throws -->
                            <div>
                                <div style="font-weight: bold; margin-bottom: 0.5rem; color: var(--secondary);">Saving Throws (e.g., "+3" or "-1")</div>
                                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.5rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.3rem; opacity: 0.8; font-size: 0.75rem; text-align: center;">STR</label>
                                        <input type="text" id="char-str-save" value="+0" placeholder="+2" style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary); color: white; border-radius: 4px; text-align: center;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.3rem; opacity: 0.8; font-size: 0.75rem; text-align: center;">DEX</label>
                                        <input type="text" id="char-dex-save" value="+0" placeholder="+2" style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary); color: white; border-radius: 4px; text-align: center;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.3rem; opacity: 0.8; font-size: 0.75rem; text-align: center;">CON</label>
                                        <input type="text" id="char-con-save" value="+0" placeholder="+2" style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary); color: white; border-radius: 4px; text-align: center;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.3rem; opacity: 0.8; font-size: 0.75rem; text-align: center;">INT</label>
                                        <input type="text" id="char-int-save" value="+0" placeholder="+2" style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary); color: white; border-radius: 4px; text-align: center;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.3rem; opacity: 0.8; font-size: 0.75rem; text-align: center;">WIS</label>
                                        <input type="text" id="char-wis-save" value="+0" placeholder="+2" style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary); color: white; border-radius: 4px; text-align: center;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.3rem; opacity: 0.8; font-size: 0.75rem; text-align: center;">CHA</label>
                                        <input type="text" id="char-cha-save" value="+0" placeholder="+2" style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary); color: white; border-radius: 4px; text-align: center;">
                                    </div>
                                </div>
                            </div>

                            <!-- Skills -->
                            <div>
                                <div style="font-weight: bold; margin-bottom: 0.5rem; color: var(--secondary);">Skills (JSON format)</div>
                                <textarea id="char-skills" rows="3" placeholder='{"Athletics": "+5", "Perception": "+3", "Stealth": "+4"}' style="width: 100%; padding: 0.6rem; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary); color: white; border-radius: 4px; font-family: monospace; font-size: 0.85rem;"></textarea>
                                <div style="font-size: 0.75rem; opacity: 0.6; margin-top: 0.3rem;">Enter skills as JSON. Common skills: Athletics, Acrobatics, Sleight of Hand, Stealth, Arcana, History, Investigation, Nature, Religion, Animal Handling, Insight, Medicine, Perception, Survival, Deception, Intimidation, Performance, Persuasion</div>
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 0.3rem; opacity: 0.8; font-size: 0.9rem;">Attacks (one per line: "Longsword +5 to hit, 1d8+3 damage")</label>
                                <textarea id="char-attacks" rows="3" placeholder="Longsword +5 to hit, 1d8+3 slashing&#10;Shortbow +4 to hit, 1d6+2 piercing" style="width: 100%; padding: 0.6rem; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary); color: white; border-radius: 4px; font-family: monospace;"></textarea>
                            </div>

                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <button type="submit" style="flex: 1; padding: 0.8rem; background: #16a34a; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">Save Character</button>
                                <button type="button" onclick="closeCharacterModal()" style="flex: 1; padding: 0.8rem; background: #dc2626; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">Cancel</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Combatant Actions Modal -->
    <div class="modal-overlay" id="combatant-actions-modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--secondary);">
                <h2 style="margin: 0; color: var(--secondary);" id="combatant-modal-name">Character Actions</h2>
                <button onclick="closeCombatantModal()" style="background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: bold;">Close</button>
            </div>

            <div id="combatant-modal-content" style="display: grid; gap: 1.5rem;">
                <!-- Stats Overview -->
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem;">
                    <div style="text-align: center; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                        <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 0.3rem;">HP</div>
                        <div style="font-size: 1.8rem; font-weight: bold; color: #16a34a;" id="modal-hp">‚Äî</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                        <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 0.3rem;">AC</div>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="modal-ac">‚Äî</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                        <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 0.3rem;">Speed</div>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="modal-speed">‚Äî</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                        <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 0.3rem;">Initiative</div>
                        <div style="font-size: 1.8rem; font-weight: bold; color: var(--secondary);" id="modal-initiative">‚Äî</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                        <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 0.3rem;">Type</div>
                        <div style="font-size: 1.2rem; font-weight: bold;" id="modal-type">‚Äî</div>
                    </div>
                </div>

                <!-- Attacks Section -->
                <div>
                    <div style="font-weight: bold; font-size: 1.2rem; margin-bottom: 1rem; color: var(--secondary);">‚öîÔ∏è Attacks</div>
                    <div id="modal-attacks" style="display: grid; gap: 0.8rem;">
                        <!-- Attacks rendered here -->
                    </div>
                </div>

                <!-- Quick Actions -->
                <div>
                    <div style="font-weight: bold; font-size: 1.2rem; margin-bottom: 1rem; color: var(--secondary);">üé≤ Quick Actions</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.8rem;">
                        <button onclick="rollSavingThrow('STR')" style="padding: 0.8rem; background: rgba(59, 130, 246, 0.3); border: 2px solid #3b82f6; color: white; border-radius: 6px; cursor: pointer; font-weight: bold;">üí™ STR Save</button>
                        <button onclick="rollSavingThrow('DEX')" style="padding: 0.8rem; background: rgba(59, 130, 246, 0.3); border: 2px solid #3b82f6; color: white; border-radius: 6px; cursor: pointer; font-weight: bold;">üèÉ DEX Save</button>
                        <button onclick="rollSavingThrow('CON')" style="padding: 0.8rem; background: rgba(59, 130, 246, 0.3); border: 2px solid #3b82f6; color: white; border-radius: 6px; cursor: pointer; font-weight: bold;">‚ù§Ô∏è CON Save</button>
                        <button onclick="rollSavingThrow('INT')" style="padding: 0.8rem; background: rgba(59, 130, 246, 0.3); border: 2px solid #3b82f6; color: white; border-radius: 6px; cursor: pointer; font-weight: bold;">üß† INT Save</button>
                        <button onclick="rollSavingThrow('WIS')" style="padding: 0.8rem; background: rgba(59, 130, 246, 0.3); border: 2px solid #3b82f6; color: white; border-radius: 6px; cursor: pointer; font-weight: bold;">üëÅÔ∏è WIS Save</button>
                        <button onclick="rollSavingThrow('CHA')" style="padding: 0.8rem; background: rgba(59, 130, 246, 0.3); border: 2px solid #3b82f6; color: white; border-radius: 6px; cursor: pointer; font-weight: bold;">üó£Ô∏è CHA Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Character Detail Modal -->
    <div class="modal-overlay" id="character-detail-modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--secondary);">
                <h2 style="margin: 0; color: var(--secondary);" id="char-detail-name">Character</h2>
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick="editCharacterFromDetail()" style="background: var(--secondary); color: var(--primary); border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: bold;">‚úèÔ∏è Edit</button>
                    <button onclick="closeCharacterDetail()" style="background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: bold;">Close</button>
                </div>
            </div>
            <div id="char-detail-content"></div>
        </div>
    </div>

    <!-- Tactical Overlay -->
    <div class="tactical-overlay" id="tactical-overlay">
        <div class="tactical-header">
            <div class="tactical-title" id="tactical-location-name">‚öîÔ∏è Tactical Map</div>
            <button class="tactical-close" onclick="closeTactical()">‚Üê Back to Map</button>
        </div>

        <div class="tactical-tabs">
            <div style="display: flex;">
                <div class="tactical-tab active" onclick="switchTacticalTab('maps')">üó∫Ô∏è MAPS</div>
                <div class="tactical-tab" onclick="switchTacticalTab('party')">üë• PARTY</div>
                <div class="tactical-tab" onclick="switchTacticalTab('encounters')">üé≠ CHARACTERS</div>
                <div class="tactical-tab" onclick="switchTacticalTab('combat')">‚öîÔ∏è COMBAT</div>
                <div class="tactical-tab" onclick="switchTacticalTab('notes')">üìù NOTES</div>
                <div class="tactical-tab" onclick="switchTacticalTab('info')">‚ÑπÔ∏è INFO</div>
            </div>
            <div class="floor-tabs" id="floor-tabs">
                <div class="floor-tab active" onclick="switchFloor('old-barracks-floor1')">üèõÔ∏è Ground Floor</div>
                <div class="floor-tab" onclick="switchFloor('old-barracks-floor2')">‚õìÔ∏è Cell Block</div>
                <div class="floor-tab" onclick="switchFloor('old-barracks-floor3')">üëë Officers</div>
            </div>
        </div>

        <div class="tactical-body">
            <!-- MAPS Tab -->
            <div class="tactical-content active" id="tactical-tab-maps">
                <canvas id="tactical-canvas"></canvas>
                <div class="tactical-controls">
                    <div class="control-title">Grid Controls</div>
                    <button class="control-btn active" id="grid-toggle-btn" onclick="tactical.toggleGrid()">Hide Grid</button>
                    <button class="control-btn" id="snap-toggle-btn" onclick="tactical.toggleSnap()">Snap: ON</button>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; opacity: 0.7;">Grid: <span id="grid-info">5ft ‚Ä¢ 30√ó20</span></div>

                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(251, 191, 36, 0.3);">
                        <div class="control-title">Background Image</div>
                        <input type="text" id="bg-image-url" placeholder="Image URL" style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary); color: white; border-radius: 4px; margin-bottom: 0.5rem; font-size: 0.8rem;">
                        <button class="control-btn" onclick="document.getElementById('bg-image-file').click()">üìÅ Upload</button>
                        <input type="file" id="bg-image-file" accept="image/*" style="display: none;" onchange="tactical.uploadBackgroundImage(this)">
                        <button class="control-btn" onclick="tactical.setBackgroundFromURL()">Set URL</button>
                        <button class="control-btn" onclick="tactical.clearBackground()">Clear BG</button>
                    </div>
                </div>
                <div class="token-controls">
                    <button class="token-btn" onclick="tactical.loadAllPartyMembers()">üë• Load Party</button>
                    <button class="token-btn" onclick="tactical.openCharacterLibrary('player')">Add Player</button>
                    <button class="token-btn" onclick="tactical.openCharacterLibrary('enemy')">Add Enemy</button>
                </div>
                <div class="battle-log" id="battle-log">
                    <div class="log-header">
                        <div class="log-title">‚öîÔ∏è Combat Log</div>
                        <button class="log-clear" onclick="tactical.clearLog()">Clear</button>
                    </div>
                    <div class="log-entries" id="log-entries"></div>
                </div>
            </div>

            <!-- PARTY Tab -->
            <div class="tactical-content" id="tactical-tab-party">
                <div class="tab-panel" id="party-content">
                    <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem;">
                        <button onclick="showAddCharacterModal('player')" style="flex: 1; padding: 0.8rem; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">+ Add Player</button>
                        <button onclick="importCharacterJSON()" style="flex: 1; padding: 0.8rem; background: var(--secondary); color: var(--primary); border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">üì• Import JSON</button>
                        <button onclick="importDNDBeyond()" style="flex: 1; padding: 0.8rem; background: #dc2626; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">D&D Beyond</button>
                    </div>
                    <div id="party-list">
                        <p style="opacity: 0.7; text-align: center; padding: 2rem;">No party members yet. Add players above.</p>
                    </div>
                </div>
            </div>

            <!-- CHARACTERS Tab -->
            <div class="tactical-content" id="tactical-tab-encounters">
                <div class="tab-panel" id="encounters-content" style="max-width: 1200px;">
                    <!-- Character Type Subtabs -->
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--secondary); padding-bottom: 0.5rem;">
                        <button id="enemies-subtab" class="subtab-btn active" onclick="switchCharacterSubtab('enemies')" style="flex: 1; padding: 0.8rem; background: #dc2626; color: white; border: none; border-radius: 6px 6px 0 0; font-weight: bold; cursor: pointer;">üëπ Enemies</button>
                        <button id="npcs-subtab" class="subtab-btn" onclick="switchCharacterSubtab('npcs')" style="flex: 1; padding: 0.8rem; background: rgba(251, 191, 36, 0.2); color: var(--secondary); border: none; border-radius: 6px 6px 0 0; font-weight: bold; cursor: pointer;">ü§ù NPCs / Allies</button>
                    </div>

                    <!-- Enemies Content -->
                    <div id="enemies-list" class="character-subtab-content">
                        <div style="margin-bottom: 1rem;">
                            <button onclick="showAddCharacterModal('enemy')" style="padding: 0.8rem 1.5rem; background: #dc2626; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">+ Add Enemy</button>
                        </div>
                        <div id="enemies-cards"></div>
                    </div>

                    <!-- NPCs Content -->
                    <div id="npcs-list" class="character-subtab-content" style="display: none;">
                        <div style="margin-bottom: 1rem;">
                            <button onclick="showAddCharacterModal('npc')" style="padding: 0.8rem 1.5rem; background: var(--secondary); color: var(--primary); border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">+ Add NPC</button>
                        </div>
                        <div id="npcs-cards"></div>
                    </div>
                </div>
            </div>

            <!-- COMBAT Tab -->
            <div class="tactical-content" id="tactical-tab-combat">
                <div class="tab-panel" id="combat-content" style="max-width: 1200px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--secondary);">
                        <div class="section-header" style="margin: 0;">‚öîÔ∏è Initiative Tracker</div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="rollAllCombatInitiative()" style="padding: 0.8rem 1.5rem; background: #dc2626; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">üé≤ Roll All Initiative</button>
                            <button onclick="clearCombatTracker()" style="padding: 0.8rem 1.5rem; background: rgba(100, 100, 100, 0.3); color: var(--text); border: none; border-radius: 6px; cursor: pointer;">Clear Combat</button>
                        </div>
                    </div>

                    <!-- Add Combatants -->
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(30, 58, 95, 0.2); border-radius: 8px;">
                        <div style="font-weight: bold; margin-bottom: 0.8rem; opacity: 0.9;">Add to Combat:</div>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.8rem;">
                            <button onclick="addAllCombatantsToCombat()" style="flex: 1; padding: 0.8rem; background: #16a34a; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">‚ûï Add ALL Combatants</button>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="addPartyToCombat()" style="flex: 1; padding: 0.6rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">+ All Party Members</button>
                            <button onclick="addEnemyToCombat()" style="flex: 1; padding: 0.6rem; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer;">+ Select Enemy</button>
                        </div>
                    </div>

                    <!-- Turn Tracker -->
                    <div id="turn-tracker" style="display: none; margin-bottom: 1.5rem; padding: 1rem; background: rgba(251, 191, 36, 0.2); border: 3px solid var(--secondary); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 0.3rem;">Current Turn:</div>
                                <div id="current-turn-name" style="font-size: 1.5rem; font-weight: bold; color: var(--secondary);">‚Äî</div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="previousTurn()" style="padding: 0.8rem 1.2rem; background: rgba(100, 100, 100, 0.3); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">‚Üê Prev</button>
                                <button onclick="nextTurn()" style="padding: 0.8rem 1.2rem; background: var(--secondary); color: var(--primary); border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">Next ‚Üí</button>
                            </div>
                        </div>
                    </div>

                    <!-- Initiative Order List -->
                    <div id="initiative-list">
                        <p style="opacity: 0.7; text-align: center; padding: 3rem;">No combatants in initiative. Add characters and roll initiative to begin.</p>
                    </div>
                </div>
            </div>

            <!-- NOTES Tab -->
            <div class="tactical-content" id="tactical-tab-notes">
                <div class="tab-panel">
                    <div class="section-header">üìù Notes</div>
                    <textarea id="tactical-notes" style="width: 100%; height: 400px; background: rgba(26, 20, 16, 0.5); border: 2px solid var(--secondary); color: var(--text); padding: 1rem; border-radius: 6px; font-family: Georgia, serif; font-size: 0.9rem;" placeholder="Campaign notes..."></textarea>
                </div>
            </div>

            <!-- INFO Tab -->
            <div class="tactical-content" id="tactical-tab-info">
                <div class="tab-panel">
                    <div class="section-header">‚ÑπÔ∏è Location Information</div>
                    <div id="location-info-detail"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CAMPAIGN DATA - Embedded for simplicity
        const CAMPAIGN = {
            "washington-camp": {
                name: "Washington's Encampment",
                coords: [40.2976, -74.8900],
                type: "continental",
                icon: "‚õ∫",
                faction: "Continental Army",
                desc: "General Washington's command tent on the Pennsylvania side.",
                info: "On Christmas night 1776, approximately 2,400 Continental Army troops assembled here. The password: 'Victory or Death'.",
                dmOnly: "Cell #4 holds prisoner A.G. Achilles - rescued during the Old Barracks raid.",
                placeholderImage: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Continental_Army_camp_-_Valley_Forge.jpg/1280px-Continental_Army_camp_-_Valley_Forge.jpg"
            },
            "river-crossing": {
                name: "Delaware River Crossing",
                coords: [40.2950, -74.8650],
                type: "crossing",
                icon: "üö£",
                faction: "Continental Army",
                desc: "McConkey's Ferry. 2,400 troops crossed Christmas night.",
                info: "Durham boats ferried troops across ice floes for 9 hours. One of the most iconic moments in American history.",
                dmOnly: null,
                placeholderImage: "https://upload.wikimedia.org/wikipedia/commons/thumb/9/95/Washington_Crossing_the_Delaware_by_Emanuel_Leutze%2C_MMA-NYC%2C_1851.jpg/1280px-Washington_Crossing_the_Delaware_by_Emanuel_Leutze%2C_MMA-NYC%2C_1851.jpg"
            },
            "old-barracks": {
                name: "The Old Barracks",
                coords: [40.2190, -74.7608],
                type: "quest",
                icon: "‚öîÔ∏è",
                faction: "Hessian / British",
                desc: "Hessian garrison.",
                playerDesc: "Hessian garrison. Important objective.",
                info: "Built in 1758, still standing today! Approximately 40-50 Hessian soldiers were quartered here. Some were captured in their bunks.",
                dmOnly: "A.G. Achilles imprisoned in Cell #4. Rescue mission objective. 4 guards outside, 2 inside near cell.",
                placeholderImage: "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/Old_Barracks_Trenton_NJ.jpg/1280px-Old_Barracks_Trenton_NJ.jpg"
            },
            "rall-hq": {
                name: "Rall's Headquarters",
                coords: [40.2195, -74.7592],
                type: "hessian",
                icon: "üèõÔ∏è",
                faction: "Hessian / British",
                desc: "Colonel Rall's command at Stacy's Tavern.",
                info: "Colonel Rall was playing cards when the attack began. An unread warning note was found in his pocket after he died.",
                dmOnly: "Contains intelligence documents about troop movements.",
                placeholderImage: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/df/Colonial_tavern_interior.jpg/1024px-Colonial_tavern_interior.jpg"
            },
            "king-street": {
                name: "King Street Battery",
                coords: [40.2210, -74.7615],
                type: "hessian",
                icon: "üõ°Ô∏è",
                faction: "Hessian / British",
                desc: "Northern artillery with 6-pounder cannon.",
                info: "Main northern defense. Artillery pieces were captured early in the battle when crews were caught off-guard.",
                dmOnly: null,
                placeholderImage: "https://upload.wikimedia.org/wikipedia/commons/thumb/1/1f/Revolutionary_War_Cannon.jpg/1280px-Revolutionary_War_Cannon.jpg"
            },
            "queen-street": {
                name: "Queen Street Battery",
                coords: [40.2175, -74.7600],
                type: "hessian",
                icon: "üõ°Ô∏è",
                faction: "Hessian / British",
                desc: "Southern artillery position.",
                info: "Crews struggled to serve their pieces in the sleet and snow. Position was abandoned as Hessians attempted to retreat.",
                dmOnly: null,
                placeholderImage: "https://upload.wikimedia.org/wikipedia/commons/thumb/2/2c/18th_century_artillery_position.jpg/1280px-18th_century_artillery_position.jpg"
            },
            "assunpink": {
                name: "Assunpink Creek Bridge",
                coords: [40.2145, -74.7598],
                type: "continental",
                icon: "üåâ",
                faction: "Continental Army",
                desc: "Continental fallback position.",
                info: "Washington's planned escape route became a trap for the Hessians. Americans blocked the bridge, forcing surrender.",
                dmOnly: null,
                placeholderImage: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6a/Old_stone_bridge_winter.jpg/1280px-Old_stone_bridge_winter.jpg"
            }
        };

        // CHARACTER LIBRARY - Embedded directly for file:// compatibility
        const CHARACTERS = {
            "washington": {
                "id": "washington",
                "name": "George Washington",
                "title": "Commander-in-Chief",
                "faction": "Continental",
                "location": "washington-camp",
                "type": "player",
                "speed": 30,
                "hp": 95,
                "maxHp": 95,
                "ac": 18,
                "initiative": "+2",
                "proficiency": 4,
                "str": 16,
                "dex": 14,
                "con": 16,
                "int": 14,
                "wis": 16,
                "cha": 18,
                "strSave": "+7",
                "dexSave": "+2",
                "conSave": "+7",
                "intSave": "+2",
                "wisSave": "+7",
                "chaSave": "+8",
                "skills": {
                    "Athletics": "+7",
                    "History": "+6",
                    "Insight": "+7",
                    "Intimidation": "+8",
                    "Perception": "+7",
                    "Persuasion": "+8"
                },
                "attacks": ["Saber +7 to hit, 1d8+4 slashing", "Pistol +5 to hit, 1d10+2 piercing"],
                "description": "Commander-in-Chief of the Continental Army. Led the daring Christmas night attack on Trenton."
            },
            "greene": {
                "id": "greene",
                "name": "Nathanael Greene",
                "title": "Major General (#2)",
                "faction": "Continental",
                "location": "washington-camp",
                "type": "player",
                "speed": 30,
                "hp": 85,
                "maxHp": 85,
                "ac": 17,
                "initiative": "+3",
                "proficiency": 4,
                "str": 15,
                "dex": 16,
                "con": 14,
                "int": 16,
                "wis": 15,
                "cha": 14,
                "strSave": "+6",
                "dexSave": "+3",
                "conSave": "+6",
                "intSave": "+7",
                "wisSave": "+6",
                "chaSave": "+2",
                "skills": {
                    "Athletics": "+6",
                    "History": "+7",
                    "Investigation": "+7",
                    "Perception": "+6",
                    "Persuasion": "+6",
                    "Survival": "+6"
                },
                "attacks": ["Sword +6 to hit, 1d8+3 slashing", "Pistol +5 to hit, 1d10+2 piercing"],
                "description": "Washington's most trusted general. Commanded the southern division during the attack."
            },
            "sullivan": {
                "id": "sullivan",
                "name": "John Sullivan",
                "title": "Major General (#3)",
                "faction": "Continental",
                "location": "washington-camp",
                "type": "player",
                "speed": 30,
                "hp": 80,
                "maxHp": 80,
                "ac": 16,
                "initiative": "+2",
                "proficiency": 4,
                "str": 16,
                "dex": 14,
                "con": 15,
                "int": 12,
                "wis": 14,
                "cha": 13,
                "strSave": "+7",
                "dexSave": "+2",
                "conSave": "+6",
                "intSave": "+1",
                "wisSave": "+6",
                "chaSave": "+1",
                "skills": {
                    "Athletics": "+7",
                    "Intimidation": "+5",
                    "Perception": "+6",
                    "Survival": "+6"
                },
                "attacks": ["Sword +6 to hit, 1d8+3 slashing", "Musket +4 to hit, 1d12+1 piercing"],
                "description": "Led the northern division during the Trenton attack."
            },
            "knox": {
                "id": "knox",
                "name": "Henry Knox",
                "title": "Colonel, Chief of Artillery",
                "faction": "Continental",
                "location": "washington-camp",
                "type": "player",
                "speed": 25,
                "hp": 75,
                "maxHp": 75,
                "ac": 15,
                "initiative": "+1",
                "proficiency": 3,
                "str": 14,
                "dex": 12,
                "con": 14,
                "int": 16,
                "wis": 13,
                "cha": 14,
                "strSave": "+5",
                "dexSave": "+1",
                "conSave": "+2",
                "intSave": "+6",
                "wisSave": "+4",
                "chaSave": "+2",
                "skills": {
                    "Arcana": "+6",
                    "History": "+6",
                    "Investigation": "+6",
                    "Perception": "+4"
                },
                "attacks": ["Sword +4 to hit, 1d8+2 slashing", "Pistol +3 to hit, 1d10+1 piercing"],
                "description": "Former bookseller who became Washington's artillery chief."
            },
            "achilles": {
                "id": "achilles",
                "name": "A.G. Achilles",
                "title": "Prisoner of War",
                "faction": "Continental",
                "location": "old-barracks-floor2",
                "type": "player",
                "speed": 30,
                "hp": 30,
                "maxHp": 45,
                "ac": 12,
                "initiative": "+2",
                "proficiency": 2,
                "str": 12,
                "dex": 14,
                "con": 11,
                "int": 10,
                "wis": 12,
                "cha": 10,
                "strSave": "+1",
                "dexSave": "+2",
                "conSave": "+0",
                "intSave": "+0",
                "wisSave": "+1",
                "chaSave": "+0",
                "skills": {
                    "Athletics": "+3",
                    "Perception": "+3",
                    "Stealth": "+4",
                    "Survival": "+3"
                },
                "attacks": ["Unarmed Strike +3 to hit, 1d4+1 bludgeoning"],
                "description": "Continental soldier imprisoned in Cell #4 on the second floor"
            },
            "rall": {
                "id": "rall",
                "name": "Colonel Johann Rall",
                "title": "Hessian Commander",
                "faction": "Hessian",
                "location": "old-barracks-floor3",
                "type": "enemy",
                "speed": 30,
                "hp": 75,
                "maxHp": 75,
                "ac": 18,
                "initiative": "+3",
                "proficiency": 4,
                "str": 18,
                "dex": 16,
                "con": 16,
                "int": 14,
                "wis": 13,
                "cha": 16,
                "strSave": "+8",
                "dexSave": "+3",
                "conSave": "+7",
                "intSave": "+2",
                "wisSave": "+5",
                "chaSave": "+7",
                "skills": {
                    "Athletics": "+8",
                    "History": "+6",
                    "Intimidation": "+7",
                    "Perception": "+5",
                    "Persuasion": "+7"
                },
                "attacks": ["Greatsword +8 to hit, 2d6+5 slashing", "Command: Rally troops (allies gain +2 AC for 1 round)"],
                "description": "Commander of Hessian forces. In the officers' quarters on third floor."
            },
            "gus": {
                "id": "gus",
                "name": "Unteroffizier Gus",
                "title": "Guard",
                "faction": "Hessian",
                "location": "old-barracks-floor1",
                "type": "enemy",
                "speed": 30,
                "hp": 58,
                "maxHp": 58,
                "ac": 17,
                "initiative": "+1",
                "proficiency": 3,
                "str": 15,
                "dex": 13,
                "con": 14,
                "int": 10,
                "wis": 12,
                "cha": 11,
                "strSave": "+2",
                "dexSave": "+4",
                "conSave": "+5",
                "intSave": "+0",
                "wisSave": "+1",
                "chaSave": "+0",
                "skills": {
                    "Athletics": "+5",
                    "Intimidation": "+3",
                    "Perception": "+4"
                },
                "attacks": ["Musket +5 to hit, 1d12+2 piercing (range 80/240)", "Bayonet +4 to hit, 1d8+2 piercing"],
                "description": "Hessian guard stationed outside the Old Barracks main entrance."
            },
            "hessian_guard_1": {
                "id": "hessian_guard_1",
                "name": "Hessian Guard (Patrol)",
                "title": "Guard",
                "faction": "Hessian",
                "location": "old-barracks-floor1",
                "type": "enemy",
                "speed": 30,
                "hp": 45,
                "maxHp": 45,
                "ac": 15,
                "initiative": "+1",
                "proficiency": 2,
                "str": 13,
                "dex": 12,
                "con": 14,
                "int": 9,
                "wis": 11,
                "cha": 10,
                "strSave": "+3",
                "dexSave": "+1",
                "conSave": "+4",
                "intSave": "-1",
                "wisSave": "+0",
                "chaSave": "+0",
                "skills": {
                    "Athletics": "+3",
                    "Perception": "+2"
                },
                "attacks": ["Musket +4 to hit, 1d12+1 piercing (range 80/240)", "Bayonet +3 to hit, 1d8+1 piercing"],
                "description": "Hessian guard on patrol duty, first floor."
            },
            "hessian_guard_3": {
                "id": "hessian_guard_3",
                "name": "Hessian Guard (Cell Block)",
                "title": "Guard",
                "faction": "Hessian",
                "location": "old-barracks-floor2",
                "type": "enemy",
                "speed": 30,
                "hp": 45,
                "maxHp": 45,
                "ac": 15,
                "initiative": "+1",
                "proficiency": 2,
                "str": 13,
                "dex": 12,
                "con": 14,
                "int": 9,
                "wis": 11,
                "cha": 10,
                "strSave": "+3",
                "dexSave": "+1",
                "conSave": "+4",
                "intSave": "-1",
                "wisSave": "+0",
                "chaSave": "+0",
                "skills": {
                    "Athletics": "+3",
                    "Perception": "+2"
                },
                "attacks": ["Musket +4 to hit, 1d12+1 piercing (range 80/240)", "Bayonet +3 to hit, 1d8+1 piercing"],
                "description": "Hessian guard stationed near Cell #4, second floor."
            },
            "hessian_guard_4": {
                "id": "hessian_guard_4",
                "name": "Hessian Sergeant",
                "title": "Sergeant",
                "faction": "Hessian",
                "location": "old-barracks-floor3",
                "type": "enemy",
                "speed": 30,
                "hp": 52,
                "maxHp": 52,
                "ac": 16,
                "initiative": "+2",
                "proficiency": 3,
                "str": 14,
                "dex": 14,
                "con": 14,
                "int": 10,
                "wis": 12,
                "cha": 11,
                "strSave": "+4",
                "dexSave": "+2",
                "conSave": "+5",
                "intSave": "+0",
                "wisSave": "+1",
                "chaSave": "+0",
                "skills": {
                    "Athletics": "+4",
                    "Intimidation": "+4",
                    "Perception": "+4"
                },
                "attacks": ["Musket +5 to hit, 1d12+2 piercing (range 80/240)", "Saber +4 to hit, 1d8+2 slashing"],
                "description": "Hessian sergeant in the officers' quarters, third floor."
            }
        };

        console.log('Characters loaded:', Object.keys(CHARACTERS).length);

        // LOCATION NOTES - Auto-populated in NOTES tab for each location
        const LOCATION_NOTES = {
            "washington-camp": `WASHINGTON'S ENCAMPMENT - December 25, 1776

READ ALOUD:
"The password tonight is 'Victory or Death.' General Washington stands before his officers in the command tent. Maps of Trenton spread across a makeshift table. His weathered face catches candlelight: 'Gentlemen, we strike at dawn. The Hessians celebrate Christmas - they will not expect us.'"

KEY NPCS: Washington (Commander), Greene (tactical genius), Sullivan (aggressive), Knox (artillery chief)

OBJECTIVES:
1. Meet Washington for mission briefing
2. Choose division (Greene south / Sullivan north)
3. Prepare for river crossing
4. Optional: Scout / gather intelligence

NOTES: Players can request supplies. Mood is desperate but determined.`,

            "old-barracks-floor1": `OLD BARRACKS - GROUND FLOOR

READ ALOUD:
"Oil lamp flickers. Middle-aged Hessian (Gus) reads a letter at wooden table, blue coat unbuttoned, musket against wall. Four iron cell doors. Half-empty schnapps. He looks tired, melancholy."

GUS (age 47, daughter Elisabeth age 12):
‚Ä¢ BRIBE 10gp DC 14 - turns away 10min
‚Ä¢ LETTER DC 12 - becomes ally
‚Ä¢ STEALTH DC 16 - knockout
‚Ä¢ COMBAT - alerts upstairs

PRISONER: A.G. Achilles in Cell #4, weak but conscious
LOCK: DC 15, keys on Gus's belt
NOISE carries upstairs`,

            "old-barracks-floor2": `OLD BARRACKS - SECOND FLOOR

READ ALOUD:
"Corridor reeks of damp stone. Four cells, mostly empty. Cell #4 has figure huddled against wall. Hessian guard patrols, musket shouldered."

A.G. ACHILLES (Continental, age 23, beaten but resilient):
‚Ä¢ Intel: "Guard rotation at dawn"
‚Ä¢ Injured - movement halved

CHALLENGES:
‚Ä¢ Pick lock DC 15 (1 min, noisy)
‚Ä¢ Distract guard DC 14
‚Ä¢ Alarm brings floor 3 reinforcements`,

            "old-barracks-floor3": `OLD BARRACKS - THIRD FLOOR

READ ALOUD:
"Warmer, well-furnished. Officers' bunks. Ornate door: 'Oberst Rall.' Light beneath. German voices laughing. Glass clinking. Christmas celebration."

COLONEL RALL (Hessian commander, DANGEROUS):
‚Ä¢ Drinking with officers
‚Ä¢ Elite fighter
‚Ä¢ History: dies tomorrow with unread warning

OPTIONS:
1. ASSASSINATION (HIGH RISK) - changes history
2. INTEL - steal maps/schedules DC 18
3. SABOTAGE - poison/false orders

LOOT: Rall's saber (+1), maps, 150gp
ESCAPE: Window 10ft drop`
        };

        // ENCOUNTER DATA
        const ENCOUNTERS = {
            'old-barracks-floor1': {
                name: 'Guard Post - Unteroffizier Gus',
                subtitle: 'Cellar - Central Guard Station',
                readAloud: `A single oil lamp casts flickering shadows across the stone cellar. At a rough wooden table sits a middle-aged Hessian soldier, his blue coat unbuttoned, musket leaning against the wall. He's reading a letter, lips moving slightly. Four heavy iron doors line the far wall‚Äîthe prison cells. The guard looks tired, melancholy. A half-empty schnapps bottle sits beside the lamp.`,
                dmNotes: `Gus can be: (1) bribed (10gp, DC 14), (2) persuaded with daughter's letter (DC 12), (3) knocked out (DC 16 Stealth), or (4) fought. NOT fanatically loyal. His daughter Elisabeth is 12 years old. If bribed, he'll turn away for 10 minutes. If letter used, he becomes ally.`,
                skillChallenges: [
                    {
                        name: 'Bribe Gus',
                        dc: 14,
                        skill: 'Persuasion',
                        success: 'He takes gold, turns away for 10 minutes',
                        failure: 'Insulted, draws weapon'
                    },
                    {
                        name: 'Use Daughter Letter',
                        dc: 12,
                        skill: 'Persuasion',
                        success: 'Becomes ally, unlocks cells',
                        failure: 'Becomes emotional but stays at post'
                    }
                ],
                enemies: ['gus']
            },
            'old-barracks-floor2': {
                name: 'Cell Block - Prisoner Rescue',
                subtitle: 'Second Floor - Prison Cells',
                readAloud: `The narrow corridor reeks of damp stone and unwashed bodies. Four iron-barred cells line the left wall. Most are empty, straw-covered floors visible through the bars. In the far cell‚Äîmarked with a crude "4" scratched into the frame‚Äîyou see a figure huddled against the wall. A Hessian guard patrols the corridor, musket shouldered.`,
                dmNotes: `Cell #4 holds A.G. Achilles (Continental soldier). Lock is DC 15 Thieves' Tools. Achilles is weak but conscious. Guard is alert (passive Perception 13). Noise attracts more guards.`,
                skillChallenges: [
                    {
                        name: 'Pick Cell Lock',
                        dc: 15,
                        skill: 'Thieves\' Tools',
                        success: 'Cell opens silently',
                        failure: 'Lock jams, makes noise - guard investigates'
                    },
                    {
                        name: 'Distract Guard',
                        dc: 14,
                        skill: 'Deception',
                        success: 'Guard moves away for 1 minute',
                        failure: 'Guard becomes suspicious, calls backup'
                    }
                ],
                enemies: ['hessian_guard_3']
            },
            'old-barracks-floor3': {
                name: 'Officers\' Quarters - Colonel Rall',
                subtitle: 'Third Floor - Command',
                readAloud: `Rich mahogany furniture fills this well-appointed room. Maps cover a large oak desk, weighted down with an ornate Hessian helmet. A portrait of King George III hangs above a fireplace where logs crackle warmly. Colonel Johann Rall sits at the desk, a glass of wine in hand, reviewing troop dispositions. His aide stands at attention nearby.`,
                dmNotes: `Rall is overconfident, slightly drunk. Won't believe Americans would attack on Christmas. Documents on desk include patrol schedules. Rall carries armory key. Window provides escape (15ft drop, DC 12 Acrobatics to avoid damage).`,
                skillChallenges: [
                    {
                        name: 'Steal Documents',
                        dc: 18,
                        skill: 'Sleight of Hand',
                        success: 'Documents obtained unnoticed',
                        failure: 'Rall notices, calls guards'
                    }
                ],
                enemies: ['rall', 'hessian_guard_4']
            }
        };

        // TACTICAL GRID SYSTEM
        class TacticalGrid {
            constructor() {
                this.canvas = null;
                this.ctx = null;
                this.gridSize = 40; // pixels per square
                this.gridFeet = 5; // feet per square
                this.cols = 30;
                this.rows = 20;
                this.showGrid = true;
                this.snapToGrid = true;
                this.backgroundImage = null;
                this.tokens = [];
                this.selectedToken = null;
                this.hoveredToken = null;
                this.isDragging = false;
                this.dragOffset = { x: 0, y: 0 };
                this.battleLog = [];
                this.currentLocation = null;
                this.portraitImages = {}; // Cache for loaded portrait images
                this.spawnPoint = null; // Spawn point for this floor
                this.isDraggingSpawn = false; // Track if dragging spawn point
                this.spawnPoints = {}; // Store spawn points per location
            }

            init(locationKey, location) {
                this.canvas = document.getElementById('tactical-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.currentLocation = locationKey;

                // Set canvas size
                this.canvas.width = this.cols * this.gridSize;
                this.canvas.height = this.rows * this.gridSize;

                document.getElementById('grid-info').textContent = `${this.gridFeet}ft ‚Ä¢ ${this.cols}√ó${this.rows}`;

                // Initialize spawn point (load saved or create default at bottom-center)
                if (!this.spawnPoints[locationKey]) {
                    this.spawnPoints[locationKey] = {
                        x: (this.cols / 2) * this.gridSize,
                        y: (this.rows - 2) * this.gridSize, // 2 squares from bottom
                        type: 'door'
                    };
                }
                this.spawnPoint = this.spawnPoints[locationKey];

                // Try to load background image
                this.loadBackground(locationKey, location);

                // Setup event listeners
                this.setupEventListeners();

                // Initial draw
                this.draw();

                // Add log entry
                this.addLog(`Entered ${location.name}`, 'info');

                // Update INFO tab with location details
                this.updateLocationInfo(location);

                // Auto-load all characters for this location
                this.loadLocationCharacters(locationKey);

                // Update PARTY tab to show character library
                this.renderCharacterLibrary(locationKey);

                // Show/hide floor tabs based on location
                const floorTabs = document.getElementById('floor-tabs');
                if (locationKey.startsWith('old-barracks-floor')) {
                    floorTabs.classList.add('active');
                    // Update active floor tab
                    document.querySelectorAll('.floor-tab').forEach((tab, i) => {
                        const floors = ['old-barracks-floor1', 'old-barracks-floor2', 'old-barracks-floor3'];
                        tab.classList.toggle('active', floors[i] === locationKey);
                    });
                } else {
                    floorTabs.classList.remove('active');
                }

                // DON'T render encounter data - it overwrites CHARACTERS tab
                // Move encounter data to INFO tab instead
                // this.renderEncounter(locationKey);

                // Load combat tracker
                this.renderCombatTracker(locationKey);
            }

            renderEncounter(locationKey) {
                const container = document.getElementById('encounters-content');
                if (!container) return;

                const encounter = ENCOUNTERS[locationKey];
                if (!encounter) {
                    container.innerHTML = '<p style="opacity: 0.7; font-size: 0.9rem; padding: 2rem;">No encounter data for this location</p>';
                    return;
                }

                container.innerHTML = `
                    <div style="margin-bottom: 1.5rem;">
                        <h2 style="color: var(--secondary); margin: 0;">${encounter.name}</h2>
                        <p style="font-style: italic; opacity: 0.8; margin: 0.3rem 0 0 0;">${encounter.subtitle}</p>
                    </div>

                    <div style="background: #f4e8c8; border: 3px solid var(--secondary); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                            <span style="font-size: 1.2rem;">üìñ</span>
                            <strong style="color: #1e3a5f; font-size: 1.1rem;">READ ALOUD TO PLAYERS</strong>
                        </div>
                        <p style="color: #1e3a5f; line-height: 1.6; margin: 0;">${encounter.readAloud}</p>
                    </div>

                    <div style="background: rgba(200, 200, 220, 0.3); border: 2px solid rgba(100, 100, 150, 0.5); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                            <span style="font-size: 1.2rem;">üîí</span>
                            <strong style="color: var(--text); font-size: 1.1rem;">DM Notes (Hidden Info)</strong>
                        </div>
                        <p style="line-height: 1.6; margin: 0; opacity: 0.9;">${encounter.dmNotes}</p>
                    </div>

                    ${encounter.skillChallenges && encounter.skillChallenges.length > 0 ? `
                        <div style="background: rgba(59, 130, 246, 0.1); border: 2px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                <span style="font-size: 1.2rem;">üéØ</span>
                                <strong style="font-size: 1.1rem;">Skill Challenges</strong>
                            </div>
                            ${encounter.skillChallenges.map(challenge => `
                                <div style="background: rgba(22, 163, 74, 0.1); border-left: 4px solid #16a34a; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                                    <div style="font-weight: bold; margin-bottom: 0.5rem;">${challenge.name}</div>
                                    <div style="margin-bottom: 0.5rem;">
                                        <strong>DC:</strong> <span style="background: #dc2626; color: white; padding: 0.2rem 0.6rem; border-radius: 4px; font-weight: bold;">${challenge.dc}</span>
                                        <strong style="margin-left: 1rem;">${challenge.skill}</strong>
                                    </div>
                                    <div style="font-size: 0.9rem; opacity: 0.9;">
                                        <strong style="color: #16a34a;">Success:</strong> ${challenge.success}<br>
                                        <strong style="color: #dc2626;">Failure:</strong> ${challenge.failure}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;
            }

            renderCombatTracker(locationKey) {
                const container = document.getElementById('combat-content');
                if (!container) return;

                const encounter = ENCOUNTERS[locationKey];
                if (!encounter || !encounter.enemies) {
                    container.innerHTML = '<p style="opacity: 0.7; font-size: 0.9rem; padding: 2rem;">No combat encounter</p>';
                    return;
                }

                const enemyIds = encounter.enemies;
                const enemies = enemyIds.map(id => CHARACTERS[id]).filter(e => e);

                container.innerHTML = `
                    <div style="background: #dc2626; padding: 1rem; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; color: white;">‚öîÔ∏è Combat Tracker - ${encounter.name}</h3>
                        <button onclick="rollAllInitiative()" style="background: var(--secondary); color: var(--primary); border: none; padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 0.9rem;">Roll All Initiative</button>
                    </div>

                    <div style="background: rgba(0,0,0,0.2); padding: 1.5rem;">
                        ${enemies.map(enemy => {
                            const hp = enemy.hp || 58;
                            const maxHp = enemy.maxHp || hp;
                            const ac = enemy.ac || 15;
                            return `
                                <div style="background: rgba(30, 30, 30, 0.6); border: 3px solid var(--secondary); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <div style="font-size: 2rem;">‚ñ≤</div>
                                            <strong style="font-size: 1.3rem;">${enemy.name}</strong>
                                        </div>
                                        <div style="display: flex; gap: 1rem; align-items: center;">
                                            <div style="text-align: center;">
                                                <div style="font-size: 0.8rem; opacity: 0.7;">HP</div>
                                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                                    <input type="number" value="${hp}" max="${maxHp}"
                                                           style="width: 60px; padding: 0.4rem; background: rgba(0,0,0,0.5); border: 2px solid var(--secondary); color: white; text-align: center; font-size: 1.2rem; font-weight: bold; border-radius: 4px;"
                                                           onchange="updateHP('${enemy.id}', this.value)">
                                                    <span style="font-size: 1.2rem; font-weight: bold;">/ ${maxHp}</span>
                                                </div>
                                            </div>
                                            <div style="text-align: center; padding: 0 1rem;">
                                                <div style="font-size: 0.8rem; opacity: 0.7;">AC</div>
                                                <div style="font-size: 1.5rem; font-weight: bold;">${ac}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button onclick="attackRoll('${enemy.id}', '${enemy.name}')" style="flex: 1; background: #dc2626; color: white; border: none; padding: 0.6rem; border-radius: 6px; font-weight: bold; cursor: pointer;">Attack</button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            loadBackground(key, location) {
                const possiblePaths = [
                    `campaign-images/${key}/background.jpg`,
                    `campaign-images/${key}/background.png`,
                    `campaign-images/${key}/background.webp`,
                    location.placeholderImage
                ];

                const tryLoad = (index = 0) => {
                    if (index >= possiblePaths.length || !possiblePaths[index]) {
                        this.draw();
                        return;
                    }

                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = () => {
                        this.backgroundImage = img;
                        this.draw();
                    };
                    img.onerror = () => tryLoad(index + 1);
                    img.src = possiblePaths[index];
                };

                tryLoad();
            }

            setupEventListeners() {
                this.canvas.addEventListener('mousedown', (e) => this.onMouseDown(e));
                this.canvas.addEventListener('mousemove', (e) => this.onMouseMove(e));
                this.canvas.addEventListener('mouseup', () => this.onMouseUp());
                this.canvas.addEventListener('mouseleave', () => this.onMouseUp());
            }

            onMouseDown(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                // Check if clicking on spawn point
                if (this.spawnPoint) {
                    const dx = x - this.spawnPoint.x;
                    const dy = y - this.spawnPoint.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < this.gridSize * 0.5) {
                        this.isDraggingSpawn = true;
                        this.dragOffset = { x: dx, y: dy };
                        this.selectedToken = null; // Deselect any token
                        this.draw();
                        return;
                    }
                }

                // Check if clicking on a token
                for (let i = this.tokens.length - 1; i >= 0; i--) {
                    const token = this.tokens[i];
                    const dx = x - token.x;
                    const dy = y - token.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < this.gridSize * 0.4) {
                        if (this.selectedToken === token) {
                            // Already selected - start dragging
                            this.isDragging = true;
                            this.dragOffset = { x: dx, y: dy };
                        } else {
                            // Select this token
                            this.selectedToken = token;
                            this.isDragging = false;
                            this.draw();
                        }
                        return;
                    }
                }

                // Clicked empty space - deselect
                this.selectedToken = null;
                this.isDragging = false;
                this.draw();
            }

            onMouseMove(e) {
                const rect = this.canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                // Handle spawn point dragging
                if (this.isDraggingSpawn && this.spawnPoint) {
                    let x = mouseX - this.dragOffset.x;
                    let y = mouseY - this.dragOffset.y;

                    if (this.snapToGrid) {
                        // Snap to center of grid squares
                        x = Math.round(x / this.gridSize) * this.gridSize;
                        y = Math.round(y / this.gridSize) * this.gridSize;
                    }

                    this.spawnPoint.x = x;
                    this.spawnPoint.y = y;
                    this.draw();
                    return;
                }

                // Handle token dragging
                if (this.selectedToken && this.isDragging) {
                    let x = mouseX - this.dragOffset.x;
                    let y = mouseY - this.dragOffset.y;

                    if (this.snapToGrid) {
                        // Snap to center of grid squares, not intersections
                        x = Math.round(x / this.gridSize) * this.gridSize + this.gridSize / 2;
                        y = Math.round(y / this.gridSize) * this.gridSize + this.gridSize / 2;
                    }

                    this.selectedToken.x = x;
                    this.selectedToken.y = y;
                    this.draw();
                    return;
                }

                // Check for hover over tokens
                let hovering = false;
                for (let i = this.tokens.length - 1; i >= 0; i--) {
                    const token = this.tokens[i];
                    const dx = mouseX - token.x;
                    const dy = mouseY - token.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < this.gridSize * 0.4) {
                        this.hoveredToken = token;
                        this.canvas.style.cursor = 'pointer';
                        hovering = true;
                        this.draw();
                        return;
                    }
                }

                // Not hovering over anything
                if (!hovering && this.hoveredToken) {
                    this.hoveredToken = null;
                    this.canvas.style.cursor = 'crosshair';
                    this.draw();
                }
            }

            onMouseUp() {
                this.isDragging = false;
                this.isDraggingSpawn = false;
                this.draw();
            }

            toggleGrid() {
                this.showGrid = !this.showGrid;
                const btn = document.getElementById('grid-toggle-btn');
                btn.textContent = this.showGrid ? 'Hide Grid' : 'Show Grid';
                btn.classList.toggle('active', this.showGrid);
                this.draw();
            }

            toggleSnap() {
                this.snapToGrid = !this.snapToGrid;
                const btn = document.getElementById('snap-toggle-btn');
                btn.textContent = `Snap: ${this.snapToGrid ? 'ON' : 'OFF'}`;
                btn.classList.toggle('active', this.snapToGrid);
            }

            setBackgroundFromURL() {
                const url = document.getElementById('bg-image-url').value;
                if (!url || !url.trim()) {
                    alert('Please enter an image URL');
                    return;
                }

                const img = new Image();
                img.onload = () => {
                    this.backgroundImage = img;
                    this.draw();
                    this.addLog('Background image loaded from URL', 'info');
                };
                img.onerror = () => {
                    alert('Failed to load image from URL. Please check the URL and try again.');
                };
                img.src = url;
            }

            uploadBackgroundImage(input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            this.backgroundImage = img;
                            this.draw();
                            this.addLog('Background image uploaded', 'info');
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            }

            clearBackground() {
                this.backgroundImage = null;
                this.draw();
                this.addLog('Background image cleared', 'info');
                document.getElementById('bg-image-url').value = '';
                document.getElementById('bg-image-file').value = '';
            }

            addToken(type) {
                // Center tokens within grid squares, not at intersections
                const centerX = (this.cols / 2) * this.gridSize + this.gridSize / 2;
                const centerY = (this.rows / 2) * this.gridSize + this.gridSize / 2;

                this.tokens.push({
                    type: type,
                    x: centerX,
                    y: centerY,
                    speed: 30, // movement speed in feet
                    selected: false
                });

                this.addLog(`Added ${type} token to battlefield`, 'info');
                this.draw();
            }

            clearTokens() {
                const count = this.tokens.length;
                this.tokens = [];
                if (count > 0) {
                    this.addLog(`Cleared ${count} token(s) from battlefield`, 'info');
                }
                this.draw();
            }

            loadAllPartyMembers() {
                if (PARTY_CHARACTERS.length === 0) {
                    alert('No party members saved. Add party members in the PARTY tab first.');
                    return;
                }

                let loaded = 0;
                PARTY_CHARACTERS.forEach((char, index) => {
                    // Check if already on map
                    if (!this.tokens.find(t => t.id === char.id)) {
                        // Place party members at spawn point in a cluster
                        const spawnX = this.spawnPoint ? this.spawnPoint.x : (this.cols / 2) * this.gridSize;
                        const spawnY = this.spawnPoint ? this.spawnPoint.y : (this.rows - 2) * this.gridSize;

                        // Arrange in a small cluster around spawn point
                        const offsetX = ((index % 3) - 1) * this.gridSize; // -1, 0, 1 grid squares
                        const offsetY = (Math.floor(index / 3) - 1) * this.gridSize;

                        const x = spawnX + offsetX;
                        const y = spawnY + offsetY;

                        this.tokens.push({
                            id: char.id,
                            name: char.name,
                            type: 'player',
                            faction: 'Continental',
                            x: x,
                            y: y,
                            speed: char.speed || 30,
                            hp: char.hp,
                            maxHp: char.maxHp,
                            ac: char.ac,
                            portrait: char.portrait || null, // Use character portrait if available
                            character: char, // Store full character reference
                            selected: false
                        });
                        loaded++;
                    }
                });

                if (loaded > 0) {
                    this.addLog(`Loaded ${loaded} party member(s) onto the map`, 'info');
                    this.draw();
                } else {
                    this.addLog('All party members already on map', 'info');
                }
            }

            updateLocationInfo(location) {
                const container = document.getElementById('location-info-detail');
                if (!container) return;

                container.innerHTML = `
                    <div class="info-section">
                        <div class="section-title">üìç ${location.icon} ${location.name}</div>
                        <div class="info-text">${location.info}</div>
                    </div>
                    ${location.dmOnly && app.dmMode ? `
                        <div class="info-section" style="border: 2px solid #dc2626; background: rgba(220, 38, 38, 0.1);">
                            <div class="section-title">üé≤ DM Only</div>
                            <div class="info-text">${location.dmOnly}</div>
                        </div>
                    ` : ''}
                `;
            }

            draw() {
                // Clear canvas
                this.ctx.fillStyle = '#2a2a2a';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                // Draw background image
                if (this.backgroundImage) {
                    this.ctx.globalAlpha = 0.7;
                    this.ctx.drawImage(
                        this.backgroundImage,
                        0, 0,
                        this.canvas.width,
                        this.canvas.height
                    );
                    this.ctx.globalAlpha = 1.0;
                }

                // Draw rooms/walls
                this.drawRooms();

                // Draw grid
                if (this.showGrid) {
                    this.drawGrid();
                }

                // Draw tokens
                this.tokens.forEach(token => this.drawToken(token));

                // Draw spawn point
                if (this.spawnPoint) {
                    this.drawSpawnPoint();
                }
            }

            drawRooms() {
                const g = this.gridSize;
                this.ctx.strokeStyle = '#8b4513';
                this.ctx.lineWidth = 4;

                if (this.currentLocation === 'old-barracks-floor1') {
                    // Entrance hall
                    this.ctx.fillStyle = 'rgba(70, 50, 30, 0.3)';
                    this.ctx.fillRect(2*g, 2*g, 10*g, 8*g);
                    this.ctx.strokeRect(2*g, 2*g, 10*g, 8*g);
                    // Barracks
                    this.ctx.fillRect(14*g, 2*g, 12*g, 8*g);
                    this.ctx.strokeRect(14*g, 2*g, 12*g, 8*g);
                    // Storage
                    this.ctx.fillRect(2*g, 12*g, 10*g, 6*g);
                    this.ctx.strokeRect(2*g, 12*g, 10*g, 6*g);
                    // Stairs
                    this.ctx.fillStyle = '#d4af37';
                    this.ctx.fillRect(26*g, 8*g, 1.5*g, 2*g);
                    this.ctx.font = 'bold 24px Arial';
                    this.ctx.fillText('‚Üë', 26.3*g, 9.7*g);
                } else if (this.currentLocation === 'old-barracks-floor2') {
                    // Corridor
                    this.ctx.fillStyle = 'rgba(50, 40, 30, 0.3)';
                    this.ctx.fillRect(2*g, 8*g, 26*g, 4*g);
                    this.ctx.strokeRect(2*g, 8*g, 26*g, 4*g);
                    // Cells
                    for (let i = 0; i < 4; i++) {
                        this.ctx.fillRect((4 + i*6)*g, 2*g, 5*g, 5*g);
                        this.ctx.strokeRect((4 + i*6)*g, 2*g, 5*g, 5*g);
                        if (i === 3) {
                            this.ctx.fillStyle = '#dc2626';
                            this.ctx.font = 'bold 12px Arial';
                            this.ctx.fillText('CELL #4', (5.5 + i*6)*g, 4*g);
                            this.ctx.fillStyle = 'rgba(50, 40, 30, 0.3)';
                        }
                    }
                    // Stairs
                    this.ctx.fillStyle = '#d4af37';
                    this.ctx.font = 'bold 24px Arial';
                    this.ctx.fillRect(1*g, 9*g, 1.5*g, 2*g);
                    this.ctx.fillText('‚Üì', 1.3*g, 10.7*g);
                    this.ctx.fillRect(27*g, 9*g, 1.5*g, 2*g);
                    this.ctx.fillText('‚Üë', 27.3*g, 10.7*g);
                } else if (this.currentLocation === 'old-barracks-floor3') {
                    // Rall's office
                    this.ctx.fillStyle = 'rgba(80, 50, 30, 0.4)';
                    this.ctx.fillRect(4*g, 4*g, 10*g, 8*g);
                    this.ctx.strokeRect(4*g, 4*g, 10*g, 8*g);
                    this.ctx.fillStyle = '#d4af37';
                    this.ctx.font = 'bold 14px Arial';
                    this.ctx.fillText('RALL', 7*g, 8.5*g);
                    // Officers quarters
                    this.ctx.fillStyle = 'rgba(70, 50, 30, 0.3)';
                    this.ctx.fillRect(16*g, 4*g, 10*g, 8*g);
                    this.ctx.strokeRect(16*g, 4*g, 10*g, 8*g);
                    // Stairs down
                    this.ctx.fillStyle = '#d4af37';
                    this.ctx.font = 'bold 24px Arial';
                    this.ctx.fillRect(1*g, 9*g, 1.5*g, 2*g);
                    this.ctx.fillText('‚Üì', 1.3*g, 10.7*g);
                } else if (this.currentLocation === 'washington-camp') {
                    // Command tent
                    this.ctx.fillStyle = 'rgba(59, 130, 246, 0.2)';
                    this.ctx.fillRect(8*g, 6*g, 14*g, 8*g);
                    this.ctx.strokeRect(8*g, 6*g, 14*g, 8*g);
                    this.ctx.fillStyle = '#3b82f6';
                    this.ctx.font = 'bold 14px Arial';
                    this.ctx.fillText('HQ', 14*g, 10.5*g);
                }
            }

            drawSpawnPoint() {
                if (!this.spawnPoint) return;

                const g = this.gridSize;
                const x = this.spawnPoint.x;
                const y = this.spawnPoint.y;
                const size = g * 0.9;

                this.ctx.save();

                // Draw spawn marker [_*_]
                this.ctx.shadowColor = 'rgba(212, 175, 55, 0.8)';
                this.ctx.shadowBlur = 15;

                // Outer square
                this.ctx.strokeStyle = '#d4af37';
                this.ctx.fillStyle = 'rgba(212, 175, 55, 0.2)';
                this.ctx.lineWidth = 3;
                this.ctx.strokeRect(x - size/2, y - size/2, size, size);
                this.ctx.fillRect(x - size/2, y - size/2, size, size);

                // Draw door icon
                this.ctx.fillStyle = '#d4af37';
                this.ctx.font = `bold ${g * 0.6}px Arial`;
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillText('üö™', x, y);

                // Label
                this.ctx.shadowBlur = 0;
                this.ctx.fillStyle = '#d4af37';
                this.ctx.font = 'bold 10px Arial';
                this.ctx.fillText('SPAWN', x, y + size/2 + 12);

                this.ctx.restore();
            }

            drawGrid() {
                this.ctx.strokeStyle = 'rgba(212, 175, 55, 0.3)';
                this.ctx.lineWidth = 1;

                // Vertical lines
                for (let x = 0; x <= this.cols; x++) {
                    const px = x * this.gridSize;
                    this.ctx.beginPath();
                    this.ctx.moveTo(px, 0);
                    this.ctx.lineTo(px, this.canvas.height);
                    this.ctx.stroke();

                    // Labels every 5 squares
                    if (x % 5 === 0 && x > 0) {
                        this.ctx.fillStyle = '#d4af37';
                        this.ctx.font = 'bold 12px monospace';
                        this.ctx.fillText(x.toString(), px - 10, 15);
                    }
                }

                // Horizontal lines
                for (let y = 0; y <= this.rows; y++) {
                    const py = y * this.gridSize;
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, py);
                    this.ctx.lineTo(this.canvas.width, py);
                    this.ctx.stroke();

                    // Labels every 5 squares
                    if (y % 5 === 0 && y > 0) {
                        this.ctx.fillStyle = '#d4af37';
                        this.ctx.font = 'bold 12px monospace';
                        this.ctx.fillText(y.toString(), 5, py - 5);
                    }
                }
            }

            drawToken(token) {
                const isHovered = token === this.hoveredToken;
                const isSelected = token === this.selectedToken;
                const size = this.gridSize * 0.8 * (isHovered ? 1.1 : 1);

                // Draw movement range (glowing circle) - only when selected and NOT dragging
                if (isSelected && !this.isDragging) {
                    const moveSquares = Math.floor(token.speed / this.gridFeet);
                    const moveRadius = moveSquares * this.gridSize;

                    // Outer glow
                    const gradient = this.ctx.createRadialGradient(token.x, token.y, 0, token.x, token.y, moveRadius);
                    gradient.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
                    gradient.addColorStop(0.7, 'rgba(59, 130, 246, 0.1)');
                    gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
                    this.ctx.fillStyle = gradient;
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                    // Range circle
                    this.ctx.strokeStyle = 'rgba(59, 130, 246, 0.6)';
                    this.ctx.lineWidth = 2;
                    this.ctx.beginPath();
                    this.ctx.arc(token.x, token.y, moveRadius, 0, Math.PI * 2);
                    this.ctx.stroke();
                }

                // Draw hover glow
                if (isHovered && !isSelected) {
                    this.ctx.save();
                    this.ctx.shadowColor = token.type === 'player' ? '#3b82f6' : '#dc2626';
                    this.ctx.shadowBlur = 20;
                    this.ctx.beginPath();
                    this.ctx.arc(token.x, token.y, size / 2, 0, Math.PI * 2);
                    this.ctx.strokeStyle = token.type === 'player' ? '#3b82f6' : '#dc2626';
                    this.ctx.lineWidth = 1;
                    this.ctx.stroke();
                    this.ctx.restore();
                }

                // Draw token with portrait or fallback
                this.ctx.save();

                // Shadow
                this.ctx.shadowColor = 'rgba(0, 0, 0, 0.6)';
                this.ctx.shadowBlur = isHovered ? 15 : 10;
                this.ctx.shadowOffsetX = 2;
                this.ctx.shadowOffsetY = 2;

                const hasPortrait = token.portrait && this.portraitImages && this.portraitImages[token.portrait];

                if (hasPortrait) {
                    // Draw portrait image
                    const img = this.portraitImages[token.portrait];
                    this.ctx.save();
                    this.ctx.beginPath();
                    this.ctx.arc(token.x, token.y, size / 2, 0, Math.PI * 2);
                    this.ctx.closePath();
                    this.ctx.clip();

                    // Draw image centered and scaled to fit
                    this.ctx.drawImage(img, token.x - size / 2, token.y - size / 2, size, size);
                    this.ctx.restore();
                } else {
                    // Fallback: colored circle
                    this.ctx.fillStyle = token.type === 'player' ? '#3b82f6' : '#dc2626';
                    this.ctx.beginPath();
                    this.ctx.arc(token.x, token.y, size / 2, 0, Math.PI * 2);
                    this.ctx.fill();

                    // Icon fallback
                    this.ctx.shadowColor = 'transparent';
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = `bold ${size * 0.5}px Arial`;
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillText(token.type === 'player' ? 'üë§' : '‚öîÔ∏è', token.x, token.y);
                }

                // Border
                this.ctx.strokeStyle = isSelected ? '#d4af37' : (isHovered ? '#fff' : 'rgba(255, 255, 255, 0.9)');
                this.ctx.lineWidth = isSelected ? 4 : (isHovered ? 3 : 2);
                this.ctx.beginPath();
                this.ctx.arc(token.x, token.y, size / 2, 0, Math.PI * 2);
                this.ctx.stroke();

                this.ctx.restore();

                // Character info tooltip (if character token)
                if (token.character && isHovered) {
                    this.ctx.save();

                    // Build stat text (no description - moved to Notes tab)
                    const char = token.character;
                    const lines = [
                        char.name,
                        char.title || '',
                        `${char.faction} ‚Ä¢ Speed ${char.speed}ft`,
                        `HP: ${char.hp || '?'}/${char.maxHp || '?'} ‚Ä¢ AC: ${char.ac || '?'}`
                    ].filter(l => l);

                    // Measure and draw background
                    this.ctx.font = 'bold 12px Arial';
                    const nameWidth = this.ctx.measureText(char.name).width;
                    this.ctx.font = '10px Arial';
                    const maxWidth = Math.max(
                        nameWidth,
                        ...lines.slice(1).map(l => this.ctx.measureText(l).width)
                    );

                    const padding = 8;
                    const lineHeight = 14;
                    const boxWidth = maxWidth + padding * 2;
                    const boxHeight = lines.length * lineHeight + padding;
                    const boxX = token.x - boxWidth / 2;
                    const boxY = token.y - this.gridSize - boxHeight - 5;

                    // Draw tooltip box
                    this.ctx.fillStyle = 'rgba(0, 0, 0, 0.95)';
                    this.ctx.strokeStyle = token.type === 'player' ? '#3b82f6' : '#dc2626';
                    this.ctx.lineWidth = 2;
                    this.ctx.fillRect(boxX, boxY, boxWidth, boxHeight);
                    this.ctx.strokeRect(boxX, boxY, boxWidth, boxHeight);

                    // Draw text
                    this.ctx.textAlign = 'left';
                    this.ctx.textBaseline = 'top';
                    lines.forEach((line, i) => {
                        if (i === 0) {
                            this.ctx.font = 'bold 12px Arial';
                            this.ctx.fillStyle = token.type === 'player' ? '#3b82f6' : '#dc2626';
                        } else {
                            this.ctx.font = '10px Arial';
                            this.ctx.fillStyle = '#ffffff';
                        }
                        this.ctx.fillText(line, boxX + padding, boxY + padding + i * lineHeight);
                    });

                    this.ctx.restore();
                } else if (token.character && isSelected) {
                    // Just show name when selected
                    this.ctx.save();
                    this.ctx.fillStyle = 'rgba(0, 0, 0, 0.9)';
                    this.ctx.font = 'bold 11px Arial';
                    const nameWidth = this.ctx.measureText(token.character.name).width;
                    const labelY = token.y + this.gridSize * 0.5;
                    this.ctx.fillRect(token.x - nameWidth/2 - 4, labelY, nameWidth + 8, 16);

                    this.ctx.fillStyle = token.type === 'player' ? '#3b82f6' : '#dc2626';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(token.character.name, token.x, labelY + 11);
                    this.ctx.restore();
                }
            }

            loadLocationCharacters(locationKey) {
                // Auto-load character tokens for this location
                Object.values(CHARACTERS).forEach(char => {
                    if (char.location === locationKey) {
                        this.addCharacterToken(char);
                    }
                });
            }

            addCharacterToken(character) {
                // Center tokens within grid squares, not at intersections
                const centerX = (this.cols / 2) * this.gridSize + this.gridSize / 2;
                const centerY = (this.rows / 2) * this.gridSize + this.gridSize / 2;

                // Add some randomness to prevent tokens from stacking
                const randomOffsetX = Math.floor(Math.random() * 5 - 2) * this.gridSize;
                const randomOffsetY = Math.floor(Math.random() * 5 - 2) * this.gridSize;
                const finalX = centerX + randomOffsetX;
                const finalY = centerY + randomOffsetY;

                this.tokens.push({
                    type: character.type || 'player',
                    x: finalX,
                    y: finalY,
                    speed: character.speed || 30,
                    character: character,
                    name: character.name,
                    selected: false
                });

                this.addLog(`${character.name} entered battlefield`, character.type === 'enemy' ? 'combat' : 'movement');
                this.draw();
            }

            renderCharacterLibrary(locationKey) {
                const container = document.getElementById('party-list');
                if (!container) return;

                console.log('Rendering character library for:', locationKey);
                console.log('Total characters available:', Object.keys(CHARACTERS).length);

                const locationCharacters = Object.values(CHARACTERS).filter(c => c.location === locationKey);
                console.log('Characters at this location:', locationCharacters.length, locationCharacters.map(c => c.name));

                if (locationCharacters.length === 0) {
                    const totalChars = Object.keys(CHARACTERS).length;
                    container.innerHTML = `
                        <div class="character-card">
                            <div class="character-name">No characters at this location</div>
                            <div class="character-info">${totalChars > 0 ? 'Characters loaded but none assigned to this location' : '‚è≥ Loading characters... Please wait a moment and try reopening this location.'}</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        ${locationCharacters.map(char => {
                            const onMap = this.tokens.some(t => t.character && t.character.id === char.id);
                            const factionColor = char.type === 'player' ? '#3b82f6' : '#dc2626';
                            return `
                                <div onclick="tactical.${onMap ? 'selectCharacterToken' : 'addCharacterFromLibrary'}('${char.id}')"
                                     style="display: flex; align-items: center; gap: 1rem; padding: 0.8rem; background: rgba(30, 58, 95, 0.2); border: 2px solid ${onMap ? '#16a34a' : 'rgba(212, 175, 55, 0.3)'}; border-left: 4px solid ${factionColor}; border-radius: 6px; cursor: pointer; transition: all 0.2s;"
                                     onmouseover="this.style.background='rgba(30, 58, 95, 0.4)'; this.style.borderColor='${factionColor}'"
                                     onmouseout="this.style.background='rgba(30, 58, 95, 0.2)'; this.style.borderColor='${onMap ? '#16a34a' : 'rgba(212, 175, 55, 0.3)'}'">
                                    <div style="font-size: 2rem;">${char.type === 'player' ? '‚óè' : '‚ñ≤'}</div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; font-size: 1rem; margin-bottom: 0.2rem; color: ${factionColor};">${char.name}</div>
                                        <div style="font-size: 0.8rem; opacity: 0.8;">${char.title || ''}</div>
                                        <div style="font-size: 0.75rem; margin-top: 0.3rem; opacity: 0.7;">${char.faction} ‚Ä¢ ${char.speed}ft</div>
                                    </div>
                                    <div style="padding: 0.4rem 0.8rem; background: ${onMap ? 'rgba(22, 163, 74, 0.3)' : 'rgba(212, 175, 55, 0.3)'}; border-radius: 4px; font-size: 0.75rem; font-weight: bold; white-space: nowrap;">
                                        ${onMap ? '‚úì ON MAP' : '+ ADD'}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            selectCharacterToken(characterId) {
                // Find and select the token for this character
                const token = this.tokens.find(t => t.character && t.character.id === characterId);
                if (token) {
                    this.selectedToken = token;
                    this.isDragging = false;
                    this.draw();
                    this.addLog(`Selected ${token.name}`, 'info');
                    // Switch to MAPS tab to see the selected token
                    switchTacticalTab('maps');
                }
            }

            openCharacterLibrary(type) {
                // Switch to PARTY tab to show character library
                switchTacticalTab('party');
                this.addLog(`Opening character library (${type === 'player' ? 'Continental' : 'Hessian'} forces)`, 'info');
            }

            addCharacterFromLibrary(characterId) {
                // Look up character in CHARACTERS object
                const character = CHARACTERS[characterId];
                if (character) {
                    this.addCharacterToken(character);
                    // Re-render library to update status
                    this.renderCharacterLibrary(this.currentLocation);
                    // Switch to MAPS tab to see the token
                    switchTacticalTab('maps');
                }
            }

            addLog(message, type = 'info') {
                const time = new Date().toLocaleTimeString();
                this.battleLog.unshift({ time, message, type });
                if (this.battleLog.length > 50) this.battleLog.pop();
                this.renderLog();
            }

            clearLog() {
                this.battleLog = [];
                this.renderLog();
            }

            renderLog() {
                const container = document.getElementById('log-entries');
                if (!container) return;

                if (this.battleLog.length === 0) {
                    container.innerHTML = '<p style="opacity: 0.7; font-size: 0.8rem;">No combat events yet</p>';
                    return;
                }

                container.innerHTML = this.battleLog.map(entry => `
                    <div class="log-entry ${entry.type}">
                        <div class="log-time">${entry.time}</div>
                        <div>${entry.message}</div>
                    </div>
                `).join('');
            }

            // Portrait Image Management
            loadPortraitImage(url) {
                return new Promise((resolve, reject) => {
                    if (this.portraitImages[url]) {
                        resolve(this.portraitImages[url]);
                        return;
                    }

                    const img = new Image();
                    img.onload = () => {
                        this.portraitImages[url] = img;
                        this.draw(); // Redraw to show the portrait
                        resolve(img);
                    };
                    img.onerror = () => reject(new Error('Failed to load portrait'));
                    img.src = url;
                });
            }

            setCharacterPortrait(characterId, imageUrl) {
                const character = CHARACTERS[characterId];
                if (character) {
                    character.portrait = imageUrl;
                    this.loadPortraitImage(imageUrl).then(() => {
                        this.addLog(`Updated portrait for ${character.name}`, 'info');
                    }).catch(err => {
                        this.addLog(`Failed to load portrait for ${character.name}`, 'error');
                        console.error(err);
                    });
                }
            }

            uploadPortraitForCharacter(characterId, file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const dataUrl = e.target.result;
                    this.setCharacterPortrait(characterId, dataUrl);
                };
                reader.readAsDataURL(file);
            }

            cleanup() {
                this.tokens = [];
                this.selectedToken = null;
                this.backgroundImage = null;
                this.battleLog = [];
                this.renderLog();
            }
        }

        class CampaignApp {
            constructor() {
                this.map = null;
                this.tacticalMap = null;
                this.markers = {};
                this.state = { visited: [], images: {} };
                this.gridLayer = null;
                this.gridVisible = false;
                this.gridSize = 5;
                this.backgroundLayer = null;
                this.currentTactical = null;
                this.dmMode = true; // Default to DM mode

                this.layers = {
                    street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19
                    }),
                    satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        maxZoom: 22
                    }),
                    terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                        maxZoom: 17
                    }),
                    fantasy: L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: '&copy; OpenStreetMap contributors, &copy; CARTO'
                    })
                };

                this.currentLayer = 'satellite';
            }

            init() {
                this.load();
                this.setupMap();
                this.render();
                this.setupEventListeners();

                // Set DM mode button as active by default
                document.getElementById('dm-mode-toggle').classList.add('active');

                // Show help banner for first-time users
                if (!this.state.visited || this.state.visited.length === 0) {
                    this.showHelpBanner();
                }

                // Auto-save every 30 seconds
                setInterval(() => this.save(), 30000);
            }

            setupMap() {
                this.map = L.map('map', {
                    center: [40.2190, -74.7608],
                    zoom: 13
                });

                this.layers.satellite.addTo(this.map);

                Object.keys(CAMPAIGN).forEach(key => this.createMarker(key));
                L.control.scale({ position: 'bottomleft', imperial: true }).addTo(this.map);
            }

            setLayer(type) {
                this.map.removeLayer(this.layers[this.currentLayer]);
                this.layers[type].addTo(this.map);
                this.currentLayer = type;

                document.querySelectorAll('.layer-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`layer-${type}`).classList.add('active');
            }

            getFantasyIcon(type, emoji) {
                const icons = {
                    continental: `<svg viewBox="0 0 50 50" width="50" height="50">
                        <defs>
                            <filter id="shadow-continental"><feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.5"/></filter>
                        </defs>
                        <circle cx="25" cy="25" r="22" fill="rgba(59, 130, 246, 0.3)" stroke="#3b82f6" stroke-width="2" filter="url(#shadow-continental)"/>
                        <path d="M15,20 L20,15 L25,18 L30,15 L35,20 L30,25 L25,22 L20,25 Z" fill="#3b82f6" stroke="#1e40af" stroke-width="1.5"/>
                        <rect x="23" y="25" width="4" height="10" fill="#3b82f6" stroke="#1e40af" stroke-width="1"/>
                        <text x="25" y="32" font-size="18" text-anchor="middle" fill="#fff">${emoji}</text>
                    </svg>`,

                    hessian: `<svg viewBox="0 0 50 50" width="50" height="50">
                        <defs>
                            <filter id="shadow-hessian"><feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.5"/></filter>
                        </defs>
                        <circle cx="25" cy="25" r="22" fill="rgba(245, 158, 11, 0.3)" stroke="#f59e0b" stroke-width="2" filter="url(#shadow-hessian)"/>
                        <rect x="15" y="15" width="20" height="20" fill="#f59e0b" stroke="#d97706" stroke-width="2"/>
                        <rect x="12" y="10" width="6" height="8" fill="#f59e0b" stroke="#d97706" stroke-width="1.5"/>
                        <rect x="32" y="10" width="6" height="8" fill="#f59e0b" stroke="#d97706" stroke-width="1.5"/>
                        <text x="25" y="30" font-size="16" text-anchor="middle" fill="#fff">${emoji}</text>
                    </svg>`,

                    quest: `<svg viewBox="0 0 50 50" width="50" height="50">
                        <defs>
                            <filter id="shadow-quest"><feDropShadow dx="0" dy="2" stdDeviation="4" flood-opacity="0.6"/></filter>
                            <radialGradient id="questGlow">
                                <stop offset="0%" style="stop-color:#dc2626;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#991b1b;stop-opacity:1" />
                            </radialGradient>
                        </defs>
                        <circle cx="25" cy="25" r="23" fill="url(#questGlow)" stroke="#b91c1c" stroke-width="2.5" filter="url(#shadow-quest)"/>
                        <circle cx="25" cy="25" r="18" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="1.5"/>
                        <text x="25" y="32" font-size="20" text-anchor="middle" fill="#fff">${emoji}</text>
                    </svg>`,

                    crossing: `<svg viewBox="0 0 50 50" width="50" height="50">
                        <defs>
                            <filter id="shadow-crossing"><feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.5"/></filter>
                        </defs>
                        <circle cx="25" cy="25" r="22" fill="rgba(6, 182, 212, 0.3)" stroke="#06b6d4" stroke-width="2" filter="url(#shadow-crossing)"/>
                        <path d="M10,25 Q25,15 40,25 Q25,35 10,25" fill="#06b6d4" fill-opacity="0.4" stroke="#0891b2" stroke-width="1.5"/>
                        <path d="M15,25 Q25,20 35,25" fill="none" stroke="#0891b2" stroke-width="1.5"/>
                        <text x="25" y="31" font-size="16" text-anchor="middle" fill="#fff">${emoji}</text>
                    </svg>`
                };

                return icons[type] || icons.continental;
            }

            createMarker(key) {
                const loc = CAMPAIGN[key];

                // Get custom fantasy icon SVG
                const iconSVG = this.getFantasyIcon(loc.type, loc.icon);
                const html = `<div class="marker-container ${loc.type}">${iconSVG}</div>`;

                const marker = L.marker(loc.coords, {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: html,
                        iconSize: [50, 50],
                        iconAnchor: [25, 50]
                    })
                }).addTo(this.map);

                const popupHTML = `
                    <div class="popup-title">${loc.icon} ${loc.name}</div>
                    <div class="popup-desc">${loc.desc}</div>
                    <div class="popup-actions">
                        <button class="popup-btn" onclick="app.showInfo('${key}')">üìñ Info</button>
                        <button class="popup-btn tactical" onclick="app.openTactical('${key}')">‚Üí Enter</button>
                    </div>
                `;

                marker.bindPopup(popupHTML);
                marker.on('click', () => this.select(key));

                // Faction color for tooltip
                const factionColor = loc.faction.includes('Continental') ? '#3b82f6' :
                                   loc.faction.includes('Hessian') ? '#f59e0b' : '#06b6d4';

                marker.bindTooltip(`
                    <div style="text-align: center;">
                        <div style="font-weight: bold; margin-bottom: 0.2rem;">${loc.icon} ${loc.name}</div>
                        <div style="font-size: 0.75rem; color: ${factionColor}; font-weight: bold;">${loc.faction}</div>
                    </div>
                `, {
                    permanent: false,
                    direction: 'top',
                    offset: [0, -35],
                    className: 'custom-tooltip'
                });

                this.markers[key] = marker;
            }

            select(key) {
                const loc = CAMPAIGN[key];

                if (!this.state.visited.includes(key)) {
                    this.state.visited.push(key);
                    this.save();
                }

                this.map.flyTo(loc.coords, 16, { duration: 1.5 });
                this.markers[key].openPopup();
                this.render();
            }

            showInfo(key) {
                const loc = CAMPAIGN[key];
                document.getElementById('info-title').textContent = `${loc.icon} ${loc.name}`;
                document.getElementById('info-subtitle').textContent = `${loc.coords[0].toFixed(4)}¬∞N, ${Math.abs(loc.coords[1]).toFixed(4)}¬∞W ‚Ä¢ ${loc.faction}`;

                let dmSection = '';
                if (this.dmMode && loc.dmOnly) {
                    dmSection = `
                        <div class="info-section" style="border: 2px solid #dc2626; background: rgba(220, 38, 38, 0.1);">
                            <div class="section-title">üé≤ DM Only</div>
                            <div class="info-text">${loc.dmOnly}</div>
                        </div>
                    `;
                }

                document.getElementById('info-body').innerHTML = `
                    <div class="info-section">
                        <div class="section-title">üìú About</div>
                        <div class="info-text">${loc.info}</div>
                    </div>
                    ${dmSection}
                `;
                document.getElementById('info-modal').classList.add('active');
            }

            toggleDMMode() {
                this.dmMode = !this.dmMode;
                const btn = document.getElementById('dm-mode-toggle');
                if (this.dmMode) {
                    btn.classList.add('active');
                    btn.textContent = 'üé≤ DM Mode';
                } else {
                    btn.classList.remove('active');
                    btn.textContent = 'üë• Player Mode';
                }
            }

            openTactical(key) {
                const loc = CAMPAIGN[key];
                this.currentTactical = key;

                // Special handling for multi-floor locations
                if (key === 'old-barracks') {
                    this.showFloorSelection();
                    return;
                }

                document.getElementById('tactical-location-name').textContent = `${loc.icon} ${loc.name}`;
                document.getElementById('tactical-overlay').classList.add('active');

                // Initialize tactical grid
                setTimeout(() => {
                    if (!window.tactical) {
                        window.tactical = new TacticalGrid();
                    }
                    tactical.init(key, loc);
                }, 50);
            }

            showFloorSelection() {
                // Create floor selection modal
                const modal = document.getElementById('info-modal');
                const title = document.getElementById('info-title');
                const subtitle = document.getElementById('info-subtitle');
                const body = document.getElementById('info-body');

                title.textContent = '‚öîÔ∏è The Old Barracks';
                subtitle.textContent = 'Select Floor';

                // Count characters per floor
                const floor1Chars = Object.values(CHARACTERS).filter(c => c.location === 'old-barracks-floor1');
                const floor2Chars = Object.values(CHARACTERS).filter(c => c.location === 'old-barracks-floor2');
                const floor3Chars = Object.values(CHARACTERS).filter(c => c.location === 'old-barracks-floor3');

                body.innerHTML = `
                    <div class="info-section">
                        <div class="section-title">Choose which floor to enter</div>
                        <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;">
                            <button class="btn" onclick="app.openFloor('old-barracks-floor1')" style="padding: 1rem; text-align: left;">
                                <strong style="font-size: 1.1rem;">üèõÔ∏è First Floor - Main Entrance</strong>
                                <div style="margin-top: 0.5rem; font-size: 0.85rem; opacity: 0.8;">
                                    ${floor1Chars.length} guards stationed ‚Ä¢ Entrance hall & barracks
                                </div>
                            </button>
                            <button class="btn" onclick="app.openFloor('old-barracks-floor2')" style="padding: 1rem; text-align: left;">
                                <strong style="font-size: 1.1rem;">‚õìÔ∏è Second Floor - Cell Block</strong>
                                <div style="margin-top: 0.5rem; font-size: 0.85rem; opacity: 0.8;">
                                    ${floor2Chars.length} occupants ‚Ä¢ Prison cells including Cell #4
                                </div>
                            </button>
                            <button class="btn" onclick="app.openFloor('old-barracks-floor3')" style="padding: 1rem; text-align: left;">
                                <strong style="font-size: 1.1rem;">üëë Third Floor - Officers' Quarters</strong>
                                <div style="margin-top: 0.5rem; font-size: 0.85rem; opacity: 0.8;">
                                    ${floor3Chars.length} officers ‚Ä¢ Colonel Rall's command post
                                </div>
                            </button>
                        </div>
                    </div>
                `;

                modal.classList.add('active');
            }

            openFloor(floorKey) {
                // Close the floor selection modal
                document.getElementById('info-modal').classList.remove('active');

                const floorNames = {
                    'old-barracks-floor1': 'Old Barracks - First Floor',
                    'old-barracks-floor2': 'Old Barracks - Second Floor (Cell Block)',
                    'old-barracks-floor3': 'Old Barracks - Third Floor (Officers\' Quarters)'
                };

                // Show tactical overlay
                document.getElementById('tactical-overlay').classList.add('active');
                document.getElementById('tactical-location-name').textContent = `‚öîÔ∏è ${floorNames[floorKey]}`;

                // Initialize tactical grid with floor data
                setTimeout(() => {
                    if (!window.tactical) {
                        window.tactical = new TacticalGrid();
                    }
                    tactical.init(floorKey, { name: floorNames[floorKey] });
                }, 50);
            }

            render() {
                this.renderLocations();
                this.renderCharacters();
                document.getElementById('stat-visited').textContent =
                    `${this.state.visited.length} / ${Object.keys(CAMPAIGN).length}`;
            }

            renderLocations() {
                let html = '';
                Object.keys(CAMPAIGN).forEach(key => {
                    const loc = CAMPAIGN[key];
                    const visited = this.state.visited.includes(key);

                    html += `
                        <div class="location-card ${loc.type}" onclick="app.select('${key}')">
                            <div class="location-name">
                                <span>${loc.icon} ${loc.name}</span>
                                <span>
                                    ${visited ? '<span class="badge visited">‚úì</span>' : ''}
                                </span>
                            </div>
                            <div class="location-desc">${loc.desc}</div>
                        </div>
                    `;
                });
                document.getElementById('locations-list').innerHTML = html;
            }

            renderCharacters() {
                const container = document.getElementById('characters-library');
                if (!container) return;

                // Only show NPCs/allies, not enemies (to avoid spoilers)
                const npcs = Object.values(CHARACTERS).filter(c => c.type !== 'enemy');

                if (npcs.length === 0) {
                    container.innerHTML = '<p style="opacity: 0.7; font-size: 0.9rem;">Loading characters...</p>';
                    return;
                }

                // Simple card list with location display
                const html = npcs.map(char => {
                    const borderColor = '#3b82f6';
                    const icon = 'üë§';
                    const location = CAMPAIGN[char.location];
                    const locationName = location ? location.name : char.location;

                    return `
                        <div onclick="showCharacterDetail('${char.id}')" style="background: rgba(30, 58, 95, 0.3); border-left: 4px solid ${borderColor}; border-radius: 6px; padding: 0.8rem; margin-bottom: 0.8rem; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='rgba(30, 58, 95, 0.5)'" onmouseout="this.style.background='rgba(30, 58, 95, 0.3)'">
                            <div style="display: flex; align-items: center; gap: 0.8rem; margin-bottom: 0.5rem;">
                                <div style="font-size: 1.5rem;">${icon}</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; color: var(--secondary);">${char.name}</div>
                                    <div style="font-size: 0.75rem; opacity: 0.8;">${char.title || char.faction || ''}</div>
                                    <div style="font-size: 0.7rem; opacity: 0.6; margin-top: 0.2rem;">üìç ${locationName}</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; font-size: 0.7rem;">
                                <div style="text-align: center; padding: 0.3rem; background: rgba(0,0,0,0.3); border-radius: 3px;">
                                    <div style="opacity: 0.7;">HP</div>
                                    <div style="font-weight: bold;">${char.hp || '?'}</div>
                                </div>
                                <div style="text-align: center; padding: 0.3rem; background: rgba(0,0,0,0.3); border-radius: 3px;">
                                    <div style="opacity: 0.7;">AC</div>
                                    <div style="font-weight: bold;">${char.ac || '?'}</div>
                                </div>
                                <div style="text-align: center; padding: 0.3rem; background: rgba(0,0,0,0.3); border-radius: 3px;">
                                    <div style="opacity: 0.7;">SPD</div>
                                    <div style="font-weight: bold;">${char.speed || 30}</div>
                                </div>
                                <div style="text-align: center; padding: 0.3rem; background: rgba(0,0,0,0.3); border-radius: 3px;">
                                    <div style="opacity: 0.7;">INIT</div>
                                    <div style="font-weight: bold;">${char.initiative || '+0'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;
            }

            showHelpBanner() {
                const banner = document.getElementById('help-banner');
                banner.classList.add('show');
                setTimeout(() => banner.classList.remove('show'), 5000);
            }

            save() {
                localStorage.setItem('trenton_campaign', JSON.stringify(this.state));
            }

            load() {
                const saved = localStorage.getItem('trenton_campaign');
                if (saved) {
                    try { this.state = JSON.parse(saved); } catch (e) {}
                }
            }

            exportSave() {
                const blob = new Blob([JSON.stringify(this.state, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `trenton_save_${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            reset() {
                if (confirm('Reset campaign? All progress will be lost.')) {
                    localStorage.removeItem('trenton_campaign');
                    location.reload();
                }
            }

            setupEventListeners() {
                document.getElementById('import-file').onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            this.state = JSON.parse(ev.target.result);
                            this.save();
                            this.render();
                            alert('Save imported successfully!');
                        } catch (err) {
                            alert('Import failed - invalid file');
                        }
                    };
                    reader.readAsText(file);
                };
            }
        }

        const app = new CampaignApp();

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('hidden');
        }

        function showTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + name).classList.add('active');
        }

        function closeInfo() {
            document.getElementById('info-modal').classList.remove('active');
        }

        function toggleHelp() {
            document.getElementById('help-overlay').classList.toggle('active');
        }

        function closeTactical() {
            document.getElementById('tactical-overlay').classList.remove('active');
            if (window.tactical) {
                tactical.cleanup();
            }
        }

        function switchTacticalTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tactical-tab').forEach(tab => tab.classList.remove('active'));

            // Find and activate the correct tab button
            const tabs = document.querySelectorAll('.tactical-tab');
            const tabIndex = ['maps', 'party', 'encounters', 'combat', 'notes', 'info'].indexOf(tabName);
            if (tabIndex >= 0 && tabs[tabIndex]) {
                tabs[tabIndex].classList.add('active');
            }

            // Update tab content
            document.querySelectorAll('.tactical-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tactical-tab-${tabName}`).classList.add('active');

            // Load character lists when switching to CHARACTERS tab
            if (tabName === 'encounters') {
                renderEnemiesList();
                renderNPCsList();
            }

            // Load party list when switching to PARTY tab
            if (tabName === 'party') {
                renderPartyList();
            }
        }

        function rollDice(sides) {
            const result = Math.floor(Math.random() * sides) + 1;
            if (window.tactical) {
                tactical.addLog(`Rolled d${sides}: ${result}`, 'combat');
            }
            return result;
        }

        function rollAllInitiative() {
            if (!window.tactical) return;
            const encounter = ENCOUNTERS[tactical.currentLocation];
            if (!encounter || !encounter.enemies) return;

            encounter.enemies.forEach(enemyId => {
                const enemy = CHARACTERS[enemyId];
                if (enemy) {
                    const roll = rollDice(20);
                    tactical.addLog(`${enemy.name}: Initiative ${roll}`, 'combat');
                }
            });
        }

        function updateHP(enemyId, newHP) {
            if (!window.tactical) return;
            const enemy = CHARACTERS[enemyId];
            if (enemy) {
                tactical.addLog(`${enemy.name}: HP changed to ${newHP}`, 'info');
            }
        }

        function attackRoll(enemyId, enemyName) {
            const roll = rollDice(20);
            const damage = rollDice(8) + 5;
            if (window.tactical) {
                if (roll >= 15) {
                    tactical.addLog(`${enemyName}: CRITICAL HIT! ${roll}+5=${roll+5} to hit ‚Üí ${damage} damage`, 'combat');
                } else {
                    tactical.addLog(`${enemyName}: Attack roll ${roll}+5=${roll+5} to hit`, 'combat');
                }
            }
        }

        function switchFloor(floorKey) {
            if (!window.tactical) return;

            const floorNames = {
                'old-barracks-floor1': 'Old Barracks - Ground Floor',
                'old-barracks-floor2': 'Old Barracks - Cell Block',
                'old-barracks-floor3': 'Old Barracks - Officers\' Quarters'
            };

            // Update active floor tab
            document.querySelectorAll('.floor-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update location and reinit
            document.getElementById('tactical-location-name').textContent = `‚öîÔ∏è ${floorNames[floorKey]}`;
            tactical.cleanup();
            tactical.init(floorKey, { name: floorNames[floorKey] });

            // Populate NOTES tab with location-specific notes
            const notesTextarea = document.getElementById('tactical-notes');
            if (notesTextarea && LOCATION_NOTES[floorKey]) {
                notesTextarea.value = LOCATION_NOTES[floorKey];
            }
        }

        // CHARACTER MANAGEMENT
        let PARTY_CHARACTERS = JSON.parse(localStorage.getItem('party_characters') || '[]');

        let currentCharacterType = 'player'; // Track what type of character we're adding

        function showAddCharacterModal(type) {
            currentCharacterType = type || 'player';
            document.getElementById('character-modal').style.display = 'flex';
            document.getElementById('character-form').reset();
            document.getElementById('char-preview').style.display = 'none';
            document.getElementById('char-placeholder').style.display = 'flex';
        }

        function closeCharacterModal() {
            document.getElementById('character-modal').style.display = 'none';
        }

        // Character Detail Modal (for sidebar characters)
        let currentDetailCharId = null;

        function showCharacterDetail(charId) {
            // Look in CHARACTERS object first, then PARTY_CHARACTERS
            let char = CHARACTERS[charId];
            if (!char) {
                char = PARTY_CHARACTERS.find(c => c.id === charId);
            }
            if (!char) return;

            currentDetailCharId = charId;
            document.getElementById('char-detail-name').textContent = char.name;

            const location = CAMPAIGN[char.location];
            const locationName = location ? location.name : char.location;

            const hasImage = char.image && char.image.trim();

            document.getElementById('char-detail-content').innerHTML = `
                <div style="display: grid; gap: 1.5rem;">
                    <!-- Image and Quick Info -->
                    <div style="display: grid; grid-template-columns: ${hasImage ? '200px 1fr' : '1fr'}; gap: 1.5rem;">
                        ${hasImage ? `
                            <div style="width: 200px; height: 200px; background: rgba(0,0,0,0.3); border-radius: 8px; overflow: hidden; border: 3px solid var(--secondary);">
                                <img src="${char.image}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\"display: flex; align-items: center; justify-content: center; height: 100%; font-size: 4rem; opacity: 0.5;\\">üë§</div>';">
                            </div>
                        ` : ''}
                        <div>
                            <div style="margin-bottom: 1rem;">
                                <div style="font-size: 1.1rem; opacity: 0.8;">${char.title || char.class || ''}</div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                                <div><strong>Type:</strong> ${char.type === 'enemy' ? 'üëπ Enemy' : 'üë§ Ally'}</div>
                                <div><strong>Faction:</strong> ${char.faction || 'Unknown'}</div>
                                <div><strong>Location:</strong> ${locationName}</div>
                                <div><strong>Speed:</strong> ${char.speed || 30}ft</div>
                            </div>
                        </div>
                    </div>

                    <!-- Core Stats Grid -->
                    <div>
                        <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 0.8rem; color: var(--secondary);">üìä Combat Stats</div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                            <div style="text-align: center; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 0.3rem;">HP</div>
                                <div style="font-size: 1.8rem; font-weight: bold; color: #16a34a;">${char.hp || '?'}/${char.maxHp || '?'}</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 0.3rem;">AC</div>
                                <div style="font-size: 1.8rem; font-weight: bold;">${char.ac || '?'}</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 0.3rem;">Initiative</div>
                                <div style="font-size: 1.8rem; font-weight: bold; color: var(--secondary);">${char.initiative || '+0'}</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 0.3rem;">Proficiency</div>
                                <div style="font-size: 1.8rem; font-weight: bold;">+${char.proficiency || 2}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Ability Scores -->
                    ${char.str !== undefined ? `
                        <div>
                            <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 0.8rem; color: var(--secondary);">üí™ Ability Scores</div>
                            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.8rem;">
                                <div style="text-align: center; padding: 0.8rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                    <div style="font-size: 0.7rem; opacity: 0.7; margin-bottom: 0.3rem;">STR</div>
                                    <div style="font-size: 1.5rem; font-weight: bold;">${char.str || 10}</div>
                                    <div style="font-size: 0.8rem; opacity: 0.8;">(${Math.floor((char.str - 10) / 2) >= 0 ? '+' : ''}${Math.floor((char.str - 10) / 2)})</div>
                                </div>
                                <div style="text-align: center; padding: 0.8rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                    <div style="font-size: 0.7rem; opacity: 0.7; margin-bottom: 0.3rem;">DEX</div>
                                    <div style="font-size: 1.5rem; font-weight: bold;">${char.dex || 10}</div>
                                    <div style="font-size: 0.8rem; opacity: 0.8;">(${Math.floor((char.dex - 10) / 2) >= 0 ? '+' : ''}${Math.floor((char.dex - 10) / 2)})</div>
                                </div>
                                <div style="text-align: center; padding: 0.8rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                    <div style="font-size: 0.7rem; opacity: 0.7; margin-bottom: 0.3rem;">CON</div>
                                    <div style="font-size: 1.5rem; font-weight: bold;">${char.con || 10}</div>
                                    <div style="font-size: 0.8rem; opacity: 0.8;">(${Math.floor((char.con - 10) / 2) >= 0 ? '+' : ''}${Math.floor((char.con - 10) / 2)})</div>
                                </div>
                                <div style="text-align: center; padding: 0.8rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                    <div style="font-size: 0.7rem; opacity: 0.7; margin-bottom: 0.3rem;">INT</div>
                                    <div style="font-size: 1.5rem; font-weight: bold;">${char.int || 10}</div>
                                    <div style="font-size: 0.8rem; opacity: 0.8;">(${Math.floor((char.int - 10) / 2) >= 0 ? '+' : ''}${Math.floor((char.int - 10) / 2)})</div>
                                </div>
                                <div style="text-align: center; padding: 0.8rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                    <div style="font-size: 0.7rem; opacity: 0.7; margin-bottom: 0.3rem;">WIS</div>
                                    <div style="font-size: 1.5rem; font-weight: bold;">${char.wis || 10}</div>
                                    <div style="font-size: 0.8rem; opacity: 0.8;">(${Math.floor((char.wis - 10) / 2) >= 0 ? '+' : ''}${Math.floor((char.wis - 10) / 2)})</div>
                                </div>
                                <div style="text-align: center; padding: 0.8rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                    <div style="font-size: 0.7rem; opacity: 0.7; margin-bottom: 0.3rem;">CHA</div>
                                    <div style="font-size: 1.5rem; font-weight: bold;">${char.cha || 10}</div>
                                    <div style="font-size: 0.8rem; opacity: 0.8;">(${Math.floor((char.cha - 10) / 2) >= 0 ? '+' : ''}${Math.floor((char.cha - 10) / 2)})</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Saving Throws -->
                    ${char.strSave !== undefined ? `
                        <div>
                            <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 0.8rem; color: var(--secondary);">üõ°Ô∏è Saving Throws</div>
                            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.8rem;">
                                <div style="text-align: center; padding: 0.8rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                    <div style="font-size: 0.7rem; opacity: 0.7; margin-bottom: 0.3rem;">STR</div>
                                    <div style="font-size: 1.3rem; font-weight: bold;">${char.strSave || '+0'}</div>
                                </div>
                                <div style="text-align: center; padding: 0.8rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                    <div style="font-size: 0.7rem; opacity: 0.7; margin-bottom: 0.3rem;">DEX</div>
                                    <div style="font-size: 1.3rem; font-weight: bold;">${char.dexSave || '+0'}</div>
                                </div>
                                <div style="text-align: center; padding: 0.8rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                    <div style="font-size: 0.7rem; opacity: 0.7; margin-bottom: 0.3rem;">CON</div>
                                    <div style="font-size: 1.3rem; font-weight: bold;">${char.conSave || '+0'}</div>
                                </div>
                                <div style="text-align: center; padding: 0.8rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                    <div style="font-size: 0.7rem; opacity: 0.7; margin-bottom: 0.3rem;">INT</div>
                                    <div style="font-size: 1.3rem; font-weight: bold;">${char.intSave || '+0'}</div>
                                </div>
                                <div style="text-align: center; padding: 0.8rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                    <div style="font-size: 0.7rem; opacity: 0.7; margin-bottom: 0.3rem;">WIS</div>
                                    <div style="font-size: 1.3rem; font-weight: bold;">${char.wisSave || '+0'}</div>
                                </div>
                                <div style="text-align: center; padding: 0.8rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                    <div style="font-size: 0.7rem; opacity: 0.7; margin-bottom: 0.3rem;">CHA</div>
                                    <div style="font-size: 1.3rem; font-weight: bold;">${char.chaSave || '+0'}</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Skills -->
                    ${char.skills && Object.keys(char.skills).length > 0 ? `
                        <div>
                            <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 0.8rem; color: var(--secondary);">‚≠ê Skills</div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                                ${Object.entries(char.skills).map(([skill, bonus]) => `
                                    <div style="padding: 0.6rem; background: rgba(0,0,0,0.3); border-radius: 6px; display: flex; justify-content: space-between;">
                                        <span style="opacity: 0.9;">${skill}</span>
                                        <span style="font-weight: bold; color: var(--secondary);">${bonus}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${char.description ? `
                        <div>
                            <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--secondary);">üìù Notes</div>
                            <div style="opacity: 0.9; line-height: 1.6; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 6px;">${char.description}</div>
                        </div>
                    ` : ''}

                    <!-- Attacks -->
                    ${char.attacks && char.attacks.length > 0 ? `
                        <div>
                            <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 0.8rem; color: var(--secondary);">‚öîÔ∏è Attacks & Actions</div>
                            ${char.attacks.map(attack => `
                                <div style="background: rgba(220, 38, 38, 0.2); padding: 0.8rem; border-left: 3px solid #dc2626; margin-bottom: 0.5rem; border-radius: 4px; font-family: monospace; font-size: 0.9rem;">
                                    ${attack}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('character-detail-modal').style.display = 'flex';
        }

        function closeCharacterDetail() {
            document.getElementById('character-detail-modal').style.display = 'none';
            currentDetailCharId = null;
        }

        function editCharacterFromDetail() {
            if (!currentDetailCharId) return;

            const char = CHARACTERS[currentDetailCharId];
            if (!char) return;

            // Close detail modal
            closeCharacterDetail();

            // Open character creation modal with pre-filled data
            currentCharacterType = char.type || 'player';
            document.getElementById('character-modal').style.display = 'flex';

            // Pre-fill form
            document.getElementById('char-name').value = char.name || '';
            document.getElementById('char-class').value = char.class || char.title || '';
            document.getElementById('char-hp').value = char.hp || 30;
            document.getElementById('char-ac').value = char.ac || 15;
            document.getElementById('char-speed').value = char.speed || 30;
            document.getElementById('char-initiative').value = char.initiative || '+0';
            document.getElementById('char-proficiency').value = char.proficiency || 2;
            document.getElementById('char-str').value = char.str || 10;
            document.getElementById('char-dex').value = char.dex || 10;
            document.getElementById('char-con').value = char.con || 10;
            document.getElementById('char-int').value = char.int || 10;
            document.getElementById('char-wis').value = char.wis || 10;
            document.getElementById('char-cha').value = char.cha || 10;
            document.getElementById('char-str-save').value = char.strSave || '+0';
            document.getElementById('char-dex-save').value = char.dexSave || '+0';
            document.getElementById('char-con-save').value = char.conSave || '+0';
            document.getElementById('char-int-save').value = char.intSave || '+0';
            document.getElementById('char-wis-save').value = char.wisSave || '+0';
            document.getElementById('char-cha-save').value = char.chaSave || '+0';
            document.getElementById('char-skills').value = char.skills ? JSON.stringify(char.skills, null, 2) : '';
            document.getElementById('char-attacks').value = (char.attacks || []).join('\n');
            document.getElementById('char-image-url').value = char.image || '';

            // Show image preview if available
            if (char.image) {
                previewImage(char.image);
            } else {
                document.getElementById('char-preview').style.display = 'none';
                document.getElementById('char-placeholder').style.display = 'flex';
            }

            // Modify save function to update instead of create new
            const form = document.getElementById('character-form');
            form.onsubmit = function(event) {
                event.preventDefault();

                // Parse skills JSON
                let skills = {};
                const skillsInput = document.getElementById('char-skills').value.trim();
                if (skillsInput) {
                    try {
                        skills = JSON.parse(skillsInput);
                    } catch (e) {
                        alert('Invalid JSON format for skills. Please use format: {"Athletics": "+5", "Perception": "+3"}');
                        return;
                    }
                }

                // Update existing character
                char.name = document.getElementById('char-name').value;
                char.class = document.getElementById('char-class').value;
                char.hp = parseInt(document.getElementById('char-hp').value);
                char.maxHp = parseInt(document.getElementById('char-hp').value);
                char.ac = parseInt(document.getElementById('char-ac').value);
                char.speed = parseInt(document.getElementById('char-speed').value);
                char.initiative = document.getElementById('char-initiative').value;
                char.proficiency = parseInt(document.getElementById('char-proficiency').value) || 2;
                char.str = parseInt(document.getElementById('char-str').value) || 10;
                char.dex = parseInt(document.getElementById('char-dex').value) || 10;
                char.con = parseInt(document.getElementById('char-con').value) || 10;
                char.int = parseInt(document.getElementById('char-int').value) || 10;
                char.wis = parseInt(document.getElementById('char-wis').value) || 10;
                char.cha = parseInt(document.getElementById('char-cha').value) || 10;
                char.strSave = document.getElementById('char-str-save').value || '+0';
                char.dexSave = document.getElementById('char-dex-save').value || '+0';
                char.conSave = document.getElementById('char-con-save').value || '+0';
                char.intSave = document.getElementById('char-int-save').value || '+0';
                char.wisSave = document.getElementById('char-wis-save').value || '+0';
                char.chaSave = document.getElementById('char-cha-save').value || '+0';
                char.skills = skills;
                char.attacks = document.getElementById('char-attacks').value.split('\n').filter(a => a.trim());
                char.image = document.getElementById('char-image-url').value || null;

                // Update in storage
                CHARACTERS[currentDetailCharId] = char;

                // Refresh displays
                if (app.renderCharacters) app.renderCharacters();
                renderEnemiesList();
                renderNPCsList();

                closeCharacterModal();

                // Restore normal save function
                form.onsubmit = saveCharacter;
            };
        }

        function previewImage(url) {
            if (url) {
                const preview = document.getElementById('char-preview');
                const placeholder = document.getElementById('char-placeholder');
                preview.src = url;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
            }
        }

        function uploadImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage(e.target.result);
                    document.getElementById('char-image-url').value = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveCharacter(event) {
            event.preventDefault();

            // Parse skills JSON
            let skills = {};
            const skillsInput = document.getElementById('char-skills').value.trim();
            if (skillsInput) {
                try {
                    skills = JSON.parse(skillsInput);
                } catch (e) {
                    alert('Invalid JSON format for skills. Please use format: {"Athletics": "+5", "Perception": "+3"}');
                    return;
                }
            }

            const character = {
                id: 'char_' + Date.now(),
                name: document.getElementById('char-name').value,
                class: document.getElementById('char-class').value,
                hp: parseInt(document.getElementById('char-hp').value),
                maxHp: parseInt(document.getElementById('char-hp').value),
                ac: parseInt(document.getElementById('char-ac').value),
                speed: parseInt(document.getElementById('char-speed').value),
                initiative: document.getElementById('char-initiative').value,
                proficiency: parseInt(document.getElementById('char-proficiency').value) || 2,
                str: parseInt(document.getElementById('char-str').value) || 10,
                dex: parseInt(document.getElementById('char-dex').value) || 10,
                con: parseInt(document.getElementById('char-con').value) || 10,
                int: parseInt(document.getElementById('char-int').value) || 10,
                wis: parseInt(document.getElementById('char-wis').value) || 10,
                cha: parseInt(document.getElementById('char-cha').value) || 10,
                strSave: document.getElementById('char-str-save').value || '+0',
                dexSave: document.getElementById('char-dex-save').value || '+0',
                conSave: document.getElementById('char-con-save').value || '+0',
                intSave: document.getElementById('char-int-save').value || '+0',
                wisSave: document.getElementById('char-wis-save').value || '+0',
                chaSave: document.getElementById('char-cha-save').value || '+0',
                skills: skills,
                attacks: document.getElementById('char-attacks').value.split('\n').filter(a => a.trim()),
                image: document.getElementById('char-image-url').value || null,
                type: currentCharacterType
            };

            // Save to appropriate location based on type
            if (currentCharacterType === 'player') {
                PARTY_CHARACTERS.push(character);
                localStorage.setItem('party_characters', JSON.stringify(PARTY_CHARACTERS));
                renderPartyList();

                // Add to tactical map if currently in tactical view
                if (window.tactical && window.tactical.canvas) {
                    tactical.addCharacterToken(character);
                    tactical.addLog(`Added ${character.name} to the battlefield`, 'info');
                }
            } else {
                // Add to CHARACTERS object for enemies/NPCs
                CHARACTERS[character.id] = character;
                if (currentCharacterType === 'enemy') {
                    renderEnemiesList();
                } else {
                    renderNPCsList();
                }

                // Add to tactical map if currently in tactical view
                if (window.tactical && window.tactical.canvas) {
                    tactical.addCharacterToken(character);
                    tactical.addLog(`Added ${character.name} to the battlefield`, 'info');
                }
            }

            closeCharacterModal();
        }

        function renderPartyList() {
            const container = document.getElementById('party-list');
            if (PARTY_CHARACTERS.length === 0) {
                container.innerHTML = '<p style="opacity: 0.7; text-align: center; padding: 2rem;">No party members yet. Add players above.</p>';
                return;
            }

            container.innerHTML = PARTY_CHARACTERS.map(char => renderStatBlock(char)).join('');
        }

        function renderStatBlock(char) {
            const imgSrc = char.image || '';
            const hasImage = imgSrc && imgSrc.trim();

            return `
                <div onclick="showCharacterDetail('${char.id}')" style="background: rgba(30, 58, 95, 0.3); border: 3px solid var(--secondary); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; display: grid; grid-template-columns: 150px 1fr; gap: 1.5rem; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='rgba(30, 58, 95, 0.5)'" onmouseout="this.style.background='rgba(30, 58, 95, 0.3)'">
                    <!-- Image -->
                    <div style="width: 150px; height: 150px; background: rgba(0,0,0,0.3); border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        ${hasImage ? `<img src="${imgSrc}" style="width: 100%; height: 100%; object-fit: cover;">` : '<div style="font-size: 4rem; opacity: 0.5;">üë§</div>'}
                    </div>

                    <!-- Stats -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h3 style="margin: 0; color: var(--secondary); font-size: 1.5rem;">${char.name}</h3>
                                ${char.class || char.title ? `<div style="opacity: 0.8; font-style: italic; margin-top: 0.3rem;">${char.class || char.title}</div>` : ''}
                            </div>
                            <button onclick="event.stopPropagation(); deleteCharacter('${char.id}')" style="background: #dc2626; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Remove</button>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin-bottom: 1rem;">
                            <div style="text-align: center; padding: 0.8rem; background: rgba(0,0,0,0.3); border-radius: 6px;">
                                <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 0.3rem;">HP</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: #16a34a;">${char.hp}/${char.maxHp}</div>
                            </div>
                            <div style="text-align: center; padding: 0.8rem; background: rgba(0,0,0,0.3); border-radius: 6px;">
                                <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 0.3rem;">AC</div>
                                <div style="font-size: 1.5rem; font-weight: bold;">${char.ac}</div>
                            </div>
                            <div style="text-align: center; padding: 0.8rem; background: rgba(0,0,0,0.3); border-radius: 6px;">
                                <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 0.3rem;">Speed</div>
                                <div style="font-size: 1.5rem; font-weight: bold;">${char.speed}ft</div>
                            </div>
                            <div style="text-align: center; padding: 0.8rem; background: rgba(0,0,0,0.3); border-radius: 6px;">
                                <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 0.3rem;">Init</div>
                                <div style="font-size: 1.5rem; font-weight: bold;">${char.initiative}</div>
                            </div>
                            <div style="text-align: center; padding: 0.8rem; background: rgba(0,0,0,0.3); border-radius: 6px;">
                                <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 0.3rem;">Prof</div>
                                <div style="font-size: 1.5rem; font-weight: bold;">+${char.proficiency || 2}</div>
                            </div>
                        </div>

                        <!-- Ability Scores Preview -->
                        ${char.str !== undefined ? `
                            <div style="margin-bottom: 1rem;">
                                <div style="font-weight: bold; margin-bottom: 0.5rem; opacity: 0.9;">Abilities</div>
                                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.5rem;">
                                    <div style="text-align: center; padding: 0.5rem; background: rgba(0,0,0,0.3); border-radius: 4px;">
                                        <div style="font-size: 0.65rem; opacity: 0.7;">STR</div>
                                        <div style="font-weight: bold;">${char.str}</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.5rem; background: rgba(0,0,0,0.3); border-radius: 4px;">
                                        <div style="font-size: 0.65rem; opacity: 0.7;">DEX</div>
                                        <div style="font-weight: bold;">${char.dex}</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.5rem; background: rgba(0,0,0,0.3); border-radius: 4px;">
                                        <div style="font-size: 0.65rem; opacity: 0.7;">CON</div>
                                        <div style="font-weight: bold;">${char.con}</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.5rem; background: rgba(0,0,0,0.3); border-radius: 4px;">
                                        <div style="font-size: 0.65rem; opacity: 0.7;">INT</div>
                                        <div style="font-weight: bold;">${char.int}</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.5rem; background: rgba(0,0,0,0.3); border-radius: 4px;">
                                        <div style="font-size: 0.65rem; opacity: 0.7;">WIS</div>
                                        <div style="font-weight: bold;">${char.wis}</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.5rem; background: rgba(0,0,0,0.3); border-radius: 4px;">
                                        <div style="font-size: 0.65rem; opacity: 0.7;">CHA</div>
                                        <div style="font-weight: bold;">${char.cha}</div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <div style="font-size: 0.85rem; opacity: 0.7; font-style: italic;">Click for full stats, saves & skills</div>
                    </div>
                </div>
            `;
        }

        function deleteCharacter(id) {
            if (confirm('Remove this character from the party?')) {
                PARTY_CHARACTERS = PARTY_CHARACTERS.filter(c => c.id !== id);
                localStorage.setItem('party_characters', JSON.stringify(PARTY_CHARACTERS));
                renderPartyList();
            }
        }

        function importCharacterJSON() {
            const json = prompt('Paste character JSON:');
            if (json) {
                try {
                    const char = JSON.parse(json);
                    char.id = 'char_' + Date.now();
                    PARTY_CHARACTERS.push(char);
                    localStorage.setItem('party_characters', JSON.stringify(PARTY_CHARACTERS));
                    renderPartyList();
                } catch (e) {
                    alert('Invalid JSON: ' + e.message);
                }
            }
        }

        function importDNDBeyond() {
            const json = prompt('Paste D&D Beyond character JSON:');
            if (json) {
                try {
                    const data = JSON.parse(json);
                    const char = {
                        id: 'char_' + Date.now(),
                        name: data.name || 'Unknown',
                        class: data.classes ? data.classes.map(c => c.definition.name).join('/') : '',
                        hp: data.baseHitPoints || 30,
                        maxHp: data.baseHitPoints || 30,
                        ac: data.armorClass || 15,
                        speed: 30,
                        initiative: '+' + (Math.floor((data.stats.find(s => s.id === 2).value - 10) / 2)),
                        attacks: [],
                        image: data.avatarUrl || data.decorations?.avatarUrl || null,
                        type: 'player'
                    };
                    PARTY_CHARACTERS.push(char);
                    localStorage.setItem('party_characters', JSON.stringify(PARTY_CHARACTERS));
                    renderPartyList();
                } catch (e) {
                    alert('Failed to parse D&D Beyond JSON: ' + e.message);
                }
            }
        }

        // Character Subtab Switching
        function switchCharacterSubtab(subtab) {
            // Update button styles
            const enemiesBtn = document.getElementById('enemies-subtab');
            const npcsBtn = document.getElementById('npcs-subtab');

            if (subtab === 'enemies') {
                enemiesBtn.style.background = '#dc2626';
                enemiesBtn.style.color = 'white';
                npcsBtn.style.background = 'rgba(251, 191, 36, 0.2)';
                npcsBtn.style.color = 'var(--secondary)';

                document.getElementById('enemies-list').style.display = 'block';
                document.getElementById('npcs-list').style.display = 'none';
            } else {
                npcsBtn.style.background = 'var(--secondary)';
                npcsBtn.style.color = 'var(--primary)';
                enemiesBtn.style.background = 'rgba(220, 38, 38, 0.2)';
                enemiesBtn.style.color = '#dc2626';

                document.getElementById('npcs-list').style.display = 'block';
                document.getElementById('enemies-list').style.display = 'none';
            }
        }

        // Render Enemies List
        function renderEnemiesList() {
            const container = document.getElementById('enemies-cards');
            if (!container) return;

            // Show ALL enemies - let DM choose what to use
            const enemies = Object.values(CHARACTERS).filter(c => c.type === 'enemy');

            if (enemies.length === 0) {
                container.innerHTML = '<p style="opacity: 0.7; text-align: center; padding: 2rem;">No enemies yet. Add enemies above.</p>';
                return;
            }

            container.innerHTML = enemies.map(char => renderStatBlockCompact(char)).join('');
        }

        // Render NPCs List
        function renderNPCsList() {
            const container = document.getElementById('npcs-cards');
            if (!container) return;

            // Show ALL NPCs - let DM choose what to use
            const npcs = Object.values(CHARACTERS).filter(c => c.type !== 'enemy');

            if (npcs.length === 0) {
                container.innerHTML = '<p style="opacity: 0.7; text-align: center; padding: 2rem;">No NPCs yet. Add NPCs above.</p>';
                return;
            }

            container.innerHTML = npcs.map(char => renderStatBlockCompact(char)).join('');
        }

        // Compact stat block without description
        function renderStatBlockCompact(char) {
            const imgSrc = char.image || '';
            const hasImage = imgSrc && imgSrc.trim();

            return `
                <div style="background: rgba(30, 58, 95, 0.3); border: 3px solid var(--secondary); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                    <div style="display: grid; grid-template-columns: 150px 1fr; gap: 1.5rem;">
                        <!-- Image -->
                        <div style="width: 150px; height: 150px; background: rgba(0,0,0,0.3); border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                            ${hasImage ? `<img src="${imgSrc}" style="width: 100%; height: 100%; object-fit: cover;">` : '<div style="font-size: 4rem; opacity: 0.5;">üë§</div>'}
                        </div>

                        <!-- Stats -->
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <div>
                                    <h3 style="margin: 0; color: var(--secondary); font-size: 1.5rem;">${char.name}</h3>
                                    ${char.class || char.title ? `<div style="opacity: 0.8; font-style: italic; margin-top: 0.3rem;">${char.class || char.title}</div>` : ''}
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="duplicateEnemy('${char.id}')" style="background: var(--secondary); color: var(--primary); border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold;">üìã Copy</button>
                                    <button onclick="addEnemyToMap('${char.id}')" style="background: #16a34a; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold;">+ Map</button>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1rem;">
                                <div style="text-align: center; padding: 0.8rem; background: rgba(0,0,0,0.3); border-radius: 6px;">
                                    <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 0.3rem;">HP</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #16a34a;">${char.hp || '?'}/${char.maxHp || '?'}</div>
                                </div>
                                <div style="text-align: center; padding: 0.8rem; background: rgba(0,0,0,0.3); border-radius: 6px;">
                                    <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 0.3rem;">AC</div>
                                    <div style="font-size: 1.5rem; font-weight: bold;">${char.ac || '?'}</div>
                                </div>
                                <div style="text-align: center; padding: 0.8rem; background: rgba(0,0,0,0.3); border-radius: 6px;">
                                    <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 0.3rem;">Speed</div>
                                    <div style="font-size: 1.5rem; font-weight: bold;">${char.speed || 30}ft</div>
                                </div>
                                <div style="text-align: center; padding: 0.8rem; background: 0,0,0,0.3); border-radius: 6px;">
                                    <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 0.3rem;">Initiative</div>
                                    <div style="font-size: 1.5rem; font-weight: bold;">${char.initiative || '+0'}</div>
                                </div>
                            </div>

                            ${char.attacks && char.attacks.length > 0 ? `
                                <div>
                                    <div style="font-weight: bold; margin-bottom: 0.5rem; opacity: 0.9;">‚öîÔ∏è Attacks</div>
                                    ${char.attacks.map(attack => `
                                        <div style="background: rgba(220, 38, 38, 0.2); padding: 0.6rem; border-left: 3px solid #dc2626; margin-bottom: 0.5rem; border-radius: 4px; font-family: monospace; font-size: 0.9rem;">
                                            ${attack}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Duplicate enemy to create more
        function duplicateEnemy(charId) {
            const original = CHARACTERS[charId];
            if (!original) return;

            const newChar = {
                ...original,
                id: 'char_' + Date.now(),
                name: original.name + ' (Copy)',
                hp: original.maxHp // Reset HP to full
            };

            CHARACTERS[newChar.id] = newChar;
            renderEnemiesList();
            renderNPCsList();

            if (window.tactical) {
                tactical.addLog(`Duplicated ${original.name}`, 'info');
            }
        }

        // Add enemy directly to map
        function addEnemyToMap(charId) {
            const char = CHARACTERS[charId];
            if (!char || !window.tactical) return;

            tactical.addCharacterToken(char);
            tactical.addLog(`Added ${char.name} to battlefield`, 'info');
        }

        // COMBAT TRACKER
        let COMBAT_TRACKER = [];
        let currentTurnIndex = 0;

        function addPartyToCombat() {
            PARTY_CHARACTERS.forEach(char => {
                if (!COMBAT_TRACKER.find(c => c.id === char.id)) {
                    COMBAT_TRACKER.push({
                        ...char,
                        initiative: null,
                        initiativeRoll: null
                    });
                }
            });
            renderInitiativeList();
            if (window.tactical) {
                tactical.addLog(`Added ${PARTY_CHARACTERS.length} party members to combat`, 'info');
            }
        }

        function addEnemyToCombat() {
            const enemies = Object.values(CHARACTERS).filter(c => c.type === 'enemy');
            if (enemies.length === 0) {
                // Switch to CHARACTERS tab to add enemies
                if (confirm('No enemies available. Switch to CHARACTERS tab to add enemies?')) {
                    switchTacticalTab('encounters');
                }
                return;
            }

            // Simple prompt for now - could be enhanced with a modal selector
            const enemyNames = enemies.map(e => e.name).join('\n');
            const selectedName = prompt('Select enemy to add:\n\n' + enemyNames);

            if (selectedName) {
                const enemy = enemies.find(e => e.name === selectedName);
                if (enemy && !COMBAT_TRACKER.find(c => c.id === enemy.id)) {
                    COMBAT_TRACKER.push({
                        ...enemy,
                        initiative: null,
                        initiativeRoll: null
                    });
                    renderInitiativeList();
                    if (window.tactical) {
                        tactical.addLog(`Added ${enemy.name} to combat`, 'info');
                    }
                }
            }
        }

        function addAllCombatantsToCombat() {
            // Add all party members
            PARTY_CHARACTERS.forEach(char => {
                if (!COMBAT_TRACKER.find(c => c.id === char.id)) {
                    COMBAT_TRACKER.push({
                        ...char,
                        initiative: null,
                        initiativeRoll: null
                    });
                }
            });

            // Add all characters from tactical map tokens
            if (window.tactical && window.tactical.tokens) {
                window.tactical.tokens.forEach(token => {
                    if (token.character && !COMBAT_TRACKER.find(c => c.id === token.character.id)) {
                        COMBAT_TRACKER.push({
                            ...token.character,
                            initiative: null,
                            initiativeRoll: null
                        });
                    }
                });
            }

            // Also add all enemies from CHARACTERS
            Object.values(CHARACTERS).forEach(char => {
                if (!COMBAT_TRACKER.find(c => c.id === char.id)) {
                    COMBAT_TRACKER.push({
                        ...char,
                        initiative: null,
                        initiativeRoll: null
                    });
                }
            });

            renderInitiativeList();
            if (window.tactical) {
                tactical.addLog(`Added ${COMBAT_TRACKER.length} total combatants to combat`, 'info');
            }
        }

        function nextTurn() {
            if (COMBAT_TRACKER.length === 0) return;

            currentTurnIndex = (currentTurnIndex + 1) % COMBAT_TRACKER.length;
            updateTurnDisplay();
            renderInitiativeList();

            if (window.tactical) {
                tactical.addLog(`Turn: ${COMBAT_TRACKER[currentTurnIndex].name}`, 'combat');
            }
        }

        function previousTurn() {
            if (COMBAT_TRACKER.length === 0) return;

            currentTurnIndex = currentTurnIndex - 1;
            if (currentTurnIndex < 0) currentTurnIndex = COMBAT_TRACKER.length - 1;
            updateTurnDisplay();
            renderInitiativeList();

            if (window.tactical) {
                tactical.addLog(`Turn: ${COMBAT_TRACKER[currentTurnIndex].name}`, 'combat');
            }
        }

        function updateTurnDisplay() {
            const turnTracker = document.getElementById('turn-tracker');
            const currentTurnName = document.getElementById('current-turn-name');

            if (COMBAT_TRACKER.length > 0) {
                turnTracker.style.display = 'block';
                currentTurnName.textContent = COMBAT_TRACKER[currentTurnIndex].name;
            } else {
                turnTracker.style.display = 'none';
                currentTurnName.textContent = '‚Äî';
            }
        }

        function rollAllCombatInitiative() {
            if (COMBAT_TRACKER.length === 0) {
                alert('Add combatants to combat first!');
                return;
            }

            COMBAT_TRACKER.forEach(combatant => {
                const roll = Math.floor(Math.random() * 20) + 1;
                const initMod = parseInt(combatant.initiative) || 0;
                combatant.initiativeRoll = roll + initMod;

                if (window.tactical) {
                    tactical.addLog(`${combatant.name}: Initiative ${roll} + ${initMod} = ${combatant.initiativeRoll}`, 'combat');
                }
            });

            // Sort by initiative (highest first)
            COMBAT_TRACKER.sort((a, b) => (b.initiativeRoll || 0) - (a.initiativeRoll || 0));

            // Start turn tracker
            currentTurnIndex = 0;
            updateTurnDisplay();
            renderInitiativeList();

            if (window.tactical) {
                tactical.addLog(`Combat started! Turn: ${COMBAT_TRACKER[0].name}`, 'combat');
            }
        }

        function renderInitiativeList() {
            const container = document.getElementById('initiative-list');

            if (COMBAT_TRACKER.length === 0) {
                container.innerHTML = '<p style="opacity: 0.7; text-align: center; padding: 3rem;">No combatants in initiative. Add characters and roll initiative to begin.</p>';
                return;
            }

            container.innerHTML = COMBAT_TRACKER.map((combatant, index) => {
                const imgSrc = combatant.image || '';
                const hasImage = imgSrc && imgSrc.trim();
                const borderColor = combatant.type === 'enemy' ? '#dc2626' : '#3b82f6';
                const initiativeDisplay = combatant.initiativeRoll !== null ? combatant.initiativeRoll : '‚Äî';
                const isCurrentTurn = index === currentTurnIndex;
                const bgColor = isCurrentTurn ? 'rgba(251, 191, 36, 0.3)' : 'rgba(30, 58, 95, 0.3)';
                const borderStyle = isCurrentTurn ? '5px solid var(--secondary)' : `5px solid ${borderColor}`;
                const bgHover = isCurrentTurn ? 'rgba(251, 191, 36, 0.5)' : 'rgba(30, 58, 95, 0.5)';

                return `
                    <div onclick="openCombatantActions('${combatant.id}')" style="background: ${bgColor}; border-left: ${borderStyle}; border-radius: 8px; padding: 1rem; margin-bottom: 0.8rem; display: grid; grid-template-columns: 60px 80px 1fr 120px 100px auto; gap: 1rem; align-items: center; cursor: pointer; transition: background 0.2s; ${isCurrentTurn ? 'box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);' : ''}" onmouseover="this.style.background='${bgHover}'" onmouseout="this.style.background='${bgColor}'"${isCurrentTurn ? ' data-current-turn="true"' : ''}>
                        <!-- Initiative # -->
                        <div style="text-align: center; font-size: 2rem; font-weight: bold; color: var(--secondary);">
                            ${index + 1}
                        </div>

                        <!-- Portrait -->
                        <div style="width: 60px; height: 60px; background: rgba(0,0,0,0.3); border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                            ${hasImage ? `<img src="${imgSrc}" style="width: 100%; height: 100%; object-fit: cover;">` : '<div style="font-size: 2rem; opacity: 0.5;">üë§</div>'}
                        </div>

                        <!-- Name & Class -->
                        <div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--secondary);">${combatant.name}</div>
                            ${combatant.class ? `<div style="opacity: 0.7; font-size: 0.85rem;">${combatant.class}</div>` : ''}
                        </div>

                        <!-- HP -->
                        <div style="text-align: center;">
                            <div style="font-size: 0.75rem; opacity: 0.7; margin-bottom: 0.3rem;">HP</div>
                            <input type="number" value="${combatant.hp}" onchange="updateCombatantHP('${combatant.id}', this.value)" onclick="event.stopPropagation()" style="width: 100%; padding: 0.4rem; background: rgba(0,0,0,0.3); border: 2px solid #16a34a; color: #16a34a; border-radius: 4px; text-align: center; font-size: 1.2rem; font-weight: bold;">
                            <div style="opacity: 0.6; font-size: 0.8rem; margin-top: 0.2rem;">/ ${combatant.maxHp}</div>
                        </div>

                        <!-- AC -->
                        <div style="text-align: center; padding: 0.8rem; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            <div style="font-size: 0.75rem; opacity: 0.7; margin-bottom: 0.3rem;">AC</div>
                            <div style="font-size: 1.5rem; font-weight: bold;">${combatant.ac}</div>
                        </div>

                        <!-- Initiative Roll -->
                        <div style="text-align: center; padding: 0.8rem; background: rgba(251, 191, 36, 0.2); border: 2px solid var(--secondary); border-radius: 6px;">
                            <div style="font-size: 0.75rem; opacity: 0.7; margin-bottom: 0.3rem;">Initiative</div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: var(--secondary);">${initiativeDisplay}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateCombatantHP(id, newHP) {
            const combatant = COMBAT_TRACKER.find(c => c.id === id);
            if (combatant) {
                combatant.hp = parseInt(newHP);
                if (window.tactical) {
                    tactical.addLog(`${combatant.name}: HP changed to ${newHP}/${combatant.maxHp}`, 'info');
                }
            }
        }

        let currentCombatantId = null;

        function openCombatantActions(id) {
            const combatant = COMBAT_TRACKER.find(c => c.id === id);
            if (!combatant) return;

            currentCombatantId = id;

            // Update modal content
            document.getElementById('combatant-modal-name').textContent = combatant.name;
            document.getElementById('modal-hp').textContent = `${combatant.hp}/${combatant.maxHp}`;
            document.getElementById('modal-ac').textContent = combatant.ac;
            document.getElementById('modal-speed').textContent = `${combatant.speed}ft`;
            document.getElementById('modal-initiative').textContent = combatant.initiative || '‚Äî';
            document.getElementById('modal-type').textContent = combatant.type === 'enemy' ? 'üëπ Enemy' : 'üë• Ally';

            // Render attacks
            const attacksContainer = document.getElementById('modal-attacks');
            if (combatant.attacks && combatant.attacks.length > 0) {
                attacksContainer.innerHTML = combatant.attacks.map((attack, idx) => `
                    <button onclick="rollAttack(${idx}, '${attack.replace(/'/g, "\\'")}')" style="padding: 1rem; background: rgba(220, 38, 38, 0.2); border: 3px solid #dc2626; color: white; border-radius: 8px; cursor: pointer; text-align: left; font-family: monospace; font-size: 0.95rem; transition: background 0.2s;" onmouseover="this.style.background='rgba(220, 38, 38, 0.4)'" onmouseout="this.style.background='rgba(220, 38, 38, 0.2)'">
                        ${attack}
                    </button>
                `).join('');
            } else {
                attacksContainer.innerHTML = '<p style="opacity: 0.6; text-align: center; padding: 1rem;">No attacks defined</p>';
            }

            // Show modal
            document.getElementById('combatant-actions-modal').style.display = 'flex';
        }

        function closeCombatantModal() {
            document.getElementById('combatant-actions-modal').style.display = 'none';
            currentCombatantId = null;
        }

        function rollAttack(attackIndex, attackText) {
            const combatant = COMBAT_TRACKER.find(c => c.id === currentCombatantId);
            if (!combatant) return;

            const attackRoll = Math.floor(Math.random() * 20) + 1;
            const damageRoll = Math.floor(Math.random() * 8) + 1;

            if (window.tactical) {
                if (attackRoll === 20) {
                    tactical.addLog(`${combatant.name}: CRITICAL HIT! (${attackRoll}) - ${attackText}`, 'combat');
                } else if (attackRoll === 1) {
                    tactical.addLog(`${combatant.name}: CRITICAL MISS! (${attackRoll}) - ${attackText}`, 'combat');
                } else {
                    tactical.addLog(`${combatant.name}: Attack roll ${attackRoll} - ${attackText}`, 'combat');
                }
            }
        }

        function rollSavingThrow(ability) {
            const combatant = COMBAT_TRACKER.find(c => c.id === currentCombatantId);
            if (!combatant) return;

            const roll = Math.floor(Math.random() * 20) + 1;
            const modifier = 0; // Default modifier - could be enhanced with actual ability scores

            if (window.tactical) {
                tactical.addLog(`${combatant.name}: ${ability} Save: ${roll} + ${modifier} = ${roll + modifier}`, 'combat');
            }
        }

        function clearCombatTracker() {
            if (confirm('Clear all combatants from initiative?')) {
                COMBAT_TRACKER = [];
                currentTurnIndex = 0;
                updateTurnDisplay();
                renderInitiativeList();
                if (window.tactical) {
                    tactical.addLog('Combat tracker cleared', 'info');
                }
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => app.init());
        } else {
            app.init();
        }
    </script>

    <!-- Fantasy Mode Elements -->
    <div class="parchment-overlay"></div>
    <div class="fantasy-corner top-left"></div>
    <div class="fantasy-corner top-right"></div>
    <div class="fantasy-corner bottom-left"></div>
    <div class="fantasy-corner bottom-right"></div>

    <svg class="compass-rose" viewBox="0 0 100 100">
        <defs>
            <radialGradient id="compassGrad">
                <stop offset="0%" style="stop-color:#d4af37;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#8b6f47;stop-opacity:1" />
            </radialGradient>
        </defs>
        <!-- Outer circle -->
        <circle cx="50" cy="50" r="48" fill="none" stroke="#8b6f47" stroke-width="2"/>
        <circle cx="50" cy="50" r="42" fill="none" stroke="#8b6f47" stroke-width="1"/>

        <!-- Main directions -->
        <polygon points="50,8 55,45 50,42 45,45" fill="url(#compassGrad)" stroke="#4a2511" stroke-width="1"/>
        <polygon points="50,92 55,55 50,58 45,55" fill="#6b5537" stroke="#4a2511" stroke-width="1"/>
        <polygon points="8,50 45,45 42,50 45,55" fill="#6b5537" stroke="#4a2511" stroke-width="1"/>
        <polygon points="92,50 55,45 58,50 55,55" fill="#6b5537" stroke="#4a2511" stroke-width="1"/>

        <!-- Diagonal directions -->
        <polygon points="20,20 45,45 42,42" fill="#8b6f47" stroke="#4a2511" stroke-width="0.5"/>
        <polygon points="80,20 55,45 58,42" fill="#8b6f47" stroke="#4a2511" stroke-width="0.5"/>
        <polygon points="20,80 45,55 42,58" fill="#8b6f47" stroke="#4a2511" stroke-width="0.5"/>
        <polygon points="80,80 55,55 58,58" fill="#8b6f47" stroke="#4a2511" stroke-width="0.5"/>

        <!-- Center -->
        <circle cx="50" cy="50" r="4" fill="#d4af37" stroke="#4a2511" stroke-width="1"/>

        <!-- Direction letters -->
        <text x="50" y="18" font-family="Cinzel, serif" font-size="10" font-weight="bold" text-anchor="middle" fill="#4a2511">N</text>
        <text x="50" y="90" font-family="Cinzel, serif" font-size="8" text-anchor="middle" fill="#4a2511">S</text>
        <text x="18" y="54" font-family="Cinzel, serif" font-size="8" text-anchor="middle" fill="#4a2511">W</text>
        <text x="82" y="54" font-family="Cinzel, serif" font-size="8" text-anchor="middle" fill="#4a2511">E</text>
    </svg>

    <div class="fantasy-legend">
        <div class="fantasy-legend-title">MAP KEY</div>
        <div class="fantasy-legend-item">
            <div class="fantasy-legend-icon quest">‚öîÔ∏è</div>
            <span>Quest Location</span>
        </div>
        <div class="fantasy-legend-item">
            <div class="fantasy-legend-icon continental">‚õ∫</div>
            <span>Continental</span>
        </div>
        <div class="fantasy-legend-item">
            <div class="fantasy-legend-icon hessian">üèõÔ∏è</div>
            <span>Hessian</span>
        </div>
        <div class="fantasy-legend-item">
            <div class="fantasy-legend-icon crossing">üö£</div>
            <span>River Crossing</span>
        </div>
    </div>

    <button class="fantasy-toggle" onclick="toggleFantasyMode()">
        <span class="fantasy-toggle-text">üó∫Ô∏è Fantasy Mode</span>
    </button>

    <script>
        // Fantasy Mode Toggle
        function toggleFantasyMode() {
            const body = document.body;
            const button = document.querySelector('.fantasy-toggle-text');
            const isFantasyMode = body.classList.toggle('fantasy-mode');

            button.textContent = isFantasyMode ? 'üìç Realistic Mode' : 'üó∫Ô∏è Fantasy Mode';

            // Always use satellite for fantasy mode (looks best)
            if (window.app && isFantasyMode) {
                app.setLayer('satellite');
            }

            // Save preference
            localStorage.setItem('fantasyMode', isFantasyMode);
        }

        // Load preference on page load
        document.addEventListener('DOMContentLoaded', () => {
            const savedMode = localStorage.getItem('fantasyMode') === 'true';
            if (savedMode) {
                document.body.classList.add('fantasy-mode');
                document.querySelector('.fantasy-toggle-text').textContent = 'üìç Realistic Mode';
                // Apply satellite layer for fantasy mode after app initializes
                setTimeout(() => {
                    if (window.app) {
                        app.setLayer('satellite');
                    }
                }, 100);
            }
        });
    </script>
</body>
</html>
