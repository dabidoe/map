<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battle of Trenton 1776</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Georgia, serif;
            background: #0a0a0a;
            color: #f4e8d0;
            overflow: hidden;
        }
        
        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 320px;
            height: 100vh;
            background: linear-gradient(180deg, #1a1410 0%, #0a0a0a 100%);
            border-right: 3px solid #d4af37;
            transition: transform 0.3s ease;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 20px rgba(0,0,0,0.5);
        }
        
        .sidebar.hidden {
            transform: translateX(-320px);
        }
        
        /* Sidebar Tab (always visible) */
        .sidebar-tab {
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #1e3a5f 0%, #0f1f3a 100%);
            color: #d4af37;
            border: 3px solid #d4af37;
            border-left: none;
            padding: 1.5rem 0.6rem;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            writing-mode: vertical-rl;
            transition: all 0.3s;
            z-index: 2001;
            box-shadow: 4px 0 15px rgba(0,0,0,0.4);
        }
        
        .sidebar.hidden ~ .sidebar-tab {
            left: 0;
        }
        
        .sidebar:not(.hidden) ~ .sidebar-tab {
            left: 320px;
        }
        
        .sidebar-tab:hover {
            background: linear-gradient(135deg, #d4af37 0%, #b8941f 100%);
            color: #1e3a5f;
            padding-right: 0.8rem;
        }
        
        /* Header */
        .sidebar-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #0f1f3a 100%);
            padding: 1.2rem;
            border-bottom: 3px solid #d4af37;
        }
        
        .campaign-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #d4af37;
            margin-bottom: 0.3rem;
        }
        
        .campaign-meta {
            font-size: 0.8rem;
            opacity: 0.8;
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }
        
        /* Tabs */
        .sidebar-tabs {
            display: flex;
            background: rgba(30, 58, 95, 0.3);
            border-bottom: 2px solid #d4af37;
        }
        
        .tab {
            flex: 1;
            padding: 0.7rem;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
            transition: all 0.3s;
            border-right: 1px solid rgba(212, 175, 55, 0.3);
        }
        
        .tab:last-child { border-right: none; }
        .tab:hover { background: rgba(212, 175, 55, 0.2); }
        .tab.active { background: rgba(212, 175, 55, 0.3); color: #d4af37; }
        
        /* Tab Content */
        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: none;
        }
        
        .tab-content.active { display: block; }
        
        /* Location Cards */
        .location-card {
            background: rgba(30, 58, 95, 0.2);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-left: 4px solid #1e3a5f;
            border-radius: 6px;
            padding: 0.9rem;
            margin-bottom: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .location-card:hover {
            background: rgba(30, 58, 95, 0.4);
            border-left-color: #d4af37;
            transform: translateX(5px);
        }
        
        .location-card.active {
            background: rgba(212, 175, 55, 0.2);
            border-color: #d4af37;
        }
        
        .location-card.quest { border-left-color: #dc2626; }
        .location-card.continental { border-left-color: #3b82f6; }
        .location-card.hessian { border-left-color: #f59e0b; }
        
        .location-name {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 0.4rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .location-desc {
            font-size: 0.85rem;
            opacity: 0.8;
            line-height: 1.4;
        }
        
        .badge {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 0.3rem;
        }
        
        .badge.visited { background: #16a34a; color: white; }
        .badge.tactical { background: #dc2626; color: white; }
        
        /* Log Entries */
        .log-entry {
            background: rgba(30, 58, 95, 0.2);
            border-left: 3px solid #d4af37;
            padding: 0.7rem;
            margin-bottom: 0.7rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .log-time {
            font-size: 0.7rem;
            opacity: 0.6;
            font-family: 'Courier New', monospace;
            margin-bottom: 0.2rem;
        }
        
        .log-entry.combat { border-left-color: #dc2626; }
        .log-entry.travel { border-left-color: #3b82f6; }
        .log-entry.discovery { border-left-color: #16a34a; }
        
        /* Save Tab */
        .save-section {
            margin-bottom: 1.5rem;
        }
        
        .save-label {
            font-weight: bold;
            color: #d4af37;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .btn-save {
            width: 100%;
            background: #1e3a5f;
            border: 2px solid #d4af37;
            color: #d4af37;
            padding: 0.7rem;
            border-radius: 6px;
            cursor: pointer;
            font-family: Georgia, serif;
            font-weight: bold;
            margin-bottom: 0.5rem;
            transition: all 0.3s;
            font-size: 0.85rem;
        }
        
        .btn-save:hover {
            background: #d4af37;
            color: #1e3a5f;
            transform: scale(1.02);
        }
        
        .btn-save.danger {
            background: #dc2626;
            border-color: #dc2626;
            color: white;
        }
        
        .btn-save.danger:hover {
            background: #b91c1c;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.6rem;
            background: rgba(30, 58, 95, 0.2);
            border-radius: 4px;
            margin-bottom: 0.4rem;
            font-size: 0.85rem;
        }
        
        .stat-value {
            font-weight: bold;
            color: #d4af37;
        }
        
        /* Route Calculator */
        .route-calc {
            background: rgba(30, 58, 95, 0.3);
            border: 2px solid rgba(212, 175, 55, 0.5);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .route-calc-title {
            font-weight: bold;
            color: #d4af37;
            margin-bottom: 0.8rem;
            font-size: 0.9rem;
        }
        
        .route-select {
            width: 100%;
            background: rgba(26, 20, 16, 0.5);
            border: 1px solid #d4af37;
            color: #f4e8d0;
            padding: 0.6rem;
            border-radius: 4px;
            font-family: Georgia, serif;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        
        .route-result {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 4px;
            padding: 0.8rem;
            margin-top: 0.8rem;
            display: none;
        }
        
        .route-result.active { display: block; }
        
        .route-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            text-align: center;
        }
        
        .route-stat-value {
            font-weight: bold;
            color: #d4af37;
            font-size: 1.1rem;
        }
        
        .route-stat-label {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 0.2rem;
        }
        
        /* Map */
        .map-container {
            position: fixed;
            left: 320px;
            top: 0;
            width: calc(100% - 320px);
            height: 100vh;
            transition: all 0.3s ease;
        }
        
        .sidebar.hidden ~ .map-container {
            left: 0;
            width: 100%;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* Info Modal */
        .info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 4000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .info-modal.active { display: flex; }
        
        .info-content {
            background: linear-gradient(135deg, #1a1410 0%, #0a0a0a 100%);
            border: 4px solid #d4af37;
            border-radius: 12px;
            padding: 2rem;
            max-width: 700px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .info-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid #d4af37;
        }
        
        .info-title {
            font-size: 1.7rem;
            color: #d4af37;
            font-weight: bold;
        }
        
        .info-subtitle {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-top: 0.3rem;
        }
        
        .info-close {
            background: #dc2626;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-family: Georgia, serif;
        }
        
        .info-close:hover {
            background: #b91c1c;
        }
        
        .info-section {
            background: rgba(30, 58, 95, 0.2);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 1.3rem;
            margin-bottom: 1.3rem;
        }
        
        .section-title {
            font-size: 1.1rem;
            color: #d4af37;
            font-weight: bold;
            margin-bottom: 0.8rem;
        }
        
        .info-text {
            font-size: 0.95rem;
            line-height: 1.7;
            margin-bottom: 0.8rem;
        }
        
        .info-list {
            list-style: none;
            padding: 0;
        }
        
        .info-list li {
            padding: 0.4rem 0 0.4rem 1.3rem;
            position: relative;
            line-height: 1.6;
            font-size: 0.9rem;
        }
        
        .info-list li:before {
            content: "‚ñ∏";
            position: absolute;
            left: 0;
            color: #d4af37;
        }
        
        .historical-fact {
            background: rgba(212, 175, 55, 0.1);
            border-left: 4px solid #d4af37;
            padding: 0.9rem;
            margin: 0.8rem 0;
            font-style: italic;
        }
        
        /* Tactical Overlay */
        .tactical-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.98);
            z-index: 5000;
        }
        
        .tactical-overlay.active { display: block; }
        
        .tactical-close {
            position: fixed;
            top: 15px;
            left: 15px;
            background: #dc2626;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-family: Georgia, serif;
            z-index: 5001;
            font-size: 1rem;
        }
        
        .tactical-close:hover {
            background: #b91c1c;
        }
        
        .tactical-frame {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* Markers */
        .custom-marker {
            background: none;
            border: none;
        }
        
        .marker-pin {
            width: 40px;
            height: 40px;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            border: 3px solid #fff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .marker-pin:hover {
            transform: rotate(-45deg) scale(1.4);
            z-index: 1000;
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.6);
        }
        
        .marker-pin.quest {
            background: radial-gradient(circle, #dc2626, #991b1b);
            animation: pulse 2s infinite;
        }
        
        .marker-pin.hessian {
            background: radial-gradient(circle, #f59e0b, #d97706);
        }
        
        .marker-pin.continental {
            background: radial-gradient(circle, #3b82f6, #1e40af);
        }
        
        .marker-pin.crossing {
            background: radial-gradient(circle, #06b6d4, #0891b2);
        }
        
        @keyframes pulse {
            0%, 100% { transform: rotate(-45deg) scale(1); }
            50% { transform: rotate(-45deg) scale(1.2); }
        }
        
        .marker-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            font-size: 1.2rem;
        }
        
        /* Leaflet Popup Styling */
        .leaflet-popup-content-wrapper {
            background: rgba(26, 20, 16, 0.98);
            color: #f4e8d0;
            border: 3px solid #d4af37;
            border-radius: 8px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.7);
        }
        
        .leaflet-popup-content {
            font-family: Georgia, serif;
            margin: 1.2rem;
            min-width: 220px;
        }
        
        .leaflet-popup-tip {
            background: rgba(26, 20, 16, 0.98);
        }
        
        .popup-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #d4af37;
            margin-bottom: 0.5rem;
        }
        
        .popup-coords {
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            opacity: 0.6;
            margin-bottom: 0.5rem;
        }
        
        .popup-desc {
            font-size: 0.9rem;
            margin-bottom: 0.8rem;
            line-height: 1.5;
        }
        
        .popup-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }
        
        .popup-btn {
            background: #1e3a5f;
            color: #d4af37;
            border: 1px solid #d4af37;
            padding: 0.6rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-family: Georgia, serif;
            font-size: 0.8rem;
            transition: all 0.3s;
        }
        
        .popup-btn:hover {
            background: #d4af37;
            color: #1e3a5f;
        }
        
        .popup-btn.tactical {
            background: #dc2626;
            border-color: #dc2626;
            color: white;
            grid-column: 1 / -1;
        }
        
        .popup-btn.tactical:hover {
            background: #b91c1c;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="campaign-title">‚öîÔ∏è Battle of Trenton</div>
            <div class="campaign-meta">
                <span>üìÖ Dec 25-26, 1776</span>
                <span>üå°Ô∏è 28¬∞F</span>
                <span>‚ùÑÔ∏è Sleet</span>
            </div>
        </div>
        
        <div class="sidebar-tabs">
            <div class="tab active" onclick="showTab('locations')">üìç Map</div>
            <div class="tab" onclick="showTab('log')">üìú Log</div>
            <div class="tab" onclick="showTab('save')">üíæ Save</div>
        </div>
        
        <div class="tab-content active" id="tab-locations">
            <div class="route-calc">
                <div class="route-calc-title">üó∫Ô∏è Calculate Route</div>
                <select class="route-select" id="route-from">
                    <option value="">From...</option>
                </select>
                <select class="route-select" id="route-to">
                    <option value="">To...</option>
                </select>
                <div class="route-result" id="route-result">
                    <div class="route-stats">
                        <div>
                            <div class="route-stat-value" id="calc-dist">--</div>
                            <div class="route-stat-label">miles</div>
                        </div>
                        <div>
                            <div class="route-stat-value" id="calc-walk">--</div>
                            <div class="route-stat-label">walk</div>
                        </div>
                        <div>
                            <div class="route-stat-value" id="calc-horse">--</div>
                            <div class="route-stat-label">horse</div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="locations-list"></div>
        </div>
        
        <div class="tab-content" id="tab-log"></div>
        
        <div class="tab-content" id="tab-save">
            <div class="save-section">
                <div class="save-label">üíæ Save Game</div>
                <button class="btn-save" onclick="game.save()">Save Progress</button>
                <button class="btn-save" onclick="game.exportSave()">üì§ Export Save</button>
                <button class="btn-save" onclick="document.getElementById('import-file').click()">üì• Import Save</button>
                <input type="file" id="import-file" accept=".json" style="display:none">
            </div>
            
            <div class="save-section">
                <div class="save-label">üìä Statistics</div>
                <div class="stat-row">
                    <span>Locations Visited</span>
                    <span class="stat-value" id="stat-visited">0 / 7</span>
                </div>
                <div class="stat-row">
                    <span>Log Entries</span>
                    <span class="stat-value" id="stat-logs">0</span>
                </div>
            </div>
            
            <div class="save-section">
                <div class="save-label">‚ö†Ô∏è Reset</div>
                <button class="btn-save danger" onclick="game.reset()">Reset Campaign</button>
            </div>
        </div>
    </div>
    
    <!-- Sidebar Tab (always visible) -->
    <div class="sidebar-tab" onclick="toggleSidebar()">üìç LOCATIONS</div>
    
    <!-- Map -->
    <div class="map-container">
        <div id="map"></div>
    </div>
    
    <!-- Info Modal -->
    <div class="info-modal" id="info-modal">
        <div class="info-content">
            <div class="info-header">
                <div>
                    <div class="info-title" id="info-title">Location</div>
                    <div class="info-subtitle" id="info-subtitle">Coordinates</div>
                </div>
                <button class="info-close" onclick="closeInfo()">‚úï</button>
            </div>
            <div id="info-body"></div>
        </div>
    </div>
    
    <!-- Tactical Overlay -->
    <div class="tactical-overlay" id="tactical-overlay">
        <button class="tactical-close" onclick="closeTactical()">‚Üê Back to Campaign Map</button>
        <iframe class="tactical-frame" id="tactical-frame"></iframe>
    </div>
    
    <script>
        const LOCATIONS = {
            'washington-camp': {
                name: "Washington's Encampment",
                coords: [40.2976, -74.8709],
                elevation: 120,
                type: 'continental',
                icon: '‚õ∫',
                desc: "General Washington's command tent on the Pennsylvania side.",
                tactical: null,
                historical: {
                    overview: "On Christmas night 1776, General George Washington assembled approximately 2,400 Continental Army troops at this encampment in Pennsylvania, preparing for one of the most daring operations of the Revolutionary War.",
                    facts: [
                        "The army began assembling here around 3:00 PM on December 25, 1776",
                        "Troops were organized into three divisions under Generals Greene, Sullivan, and Stirling",
                        "Many soldiers lacked proper winter clothing and footwear",
                        "Washington kept the target destination secret from most officers until the last moment",
                        "The password for the operation was 'Victory or Death'"
                    ],
                    significance: "This site marks the staging ground for Washington's famous Delaware River crossing. The decision to attack during a winter storm, on Christmas night, demonstrated Washington's strategic brilliance and desperation to achieve a much-needed victory.",
                    forces: "Continental Army: ~2,400 troops, 18 cannons"
                }
            },
            'river-crossing': {
                name: 'Delaware River Crossing',
                coords: [40.2950, -74.8650],
                elevation: 80,
                type: 'crossing',
                icon: 'üö£',
                desc: "McConkey's Ferry. 2,400 troops crossed here Christmas night.",
                tactical: null,
                historical: {
                    overview: "The Delaware River crossing at McConkey's Ferry is one of the most iconic moments in American history. Despite freezing temperatures, ice floes, and a winter storm, Washington's army successfully ferried across the Delaware.",
                    facts: [
                        "The crossing began around 6:00 PM on December 25, 1776",
                        "Durham boats (40-60 feet long) were used to ferry troops",
                        "The operation took approximately 9 hours to complete",
                        "Ice chunks in the river threatened to crush the boats",
                        "The crossing was delayed by 3 hours due to weather",
                        "Colonel John Glover's Marblehead Regiment manned the boats"
                    ],
                    significance: "Emanuel Leutze's famous 1851 painting immortalized this crossing, though it contains historical inaccuracies. The actual crossing occurred at night in a blizzard, making it far more treacherous than typically depicted.",
                    forces: "Three divisions crossed; two other divisions failed to cross at different points downstream"
                }
            },
            'old-barracks': {
                name: 'The Old Barracks',
                coords: [40.2190, -74.7608],
                elevation: 50,
                type: 'quest',
                icon: '‚öîÔ∏è',
                desc: 'Hessian garrison. A.G. Achilles imprisoned in Cell #4.',
                tactical: 'old_barracks_ultimate.html',
                historical: {
                    overview: "Built in 1758 during the French and Indian War, the Old Barracks served as housing for British troops. By December 1776, it was occupied by Hessian soldiers under Colonel Rall's command.",
                    facts: [
                        "One of the oldest barracks buildings in America (still standing today!)",
                        "Originally built to house 300 British soldiers",
                        "Housed Hessian troops from the Rall Regiment in December 1776",
                        "Approximately 40-50 Hessian soldiers were quartered here during the battle",
                        "Some Hessians were captured here while still in their bunks",
                        "The building survives today as a museum in Trenton"
                    ],
                    significance: "The Old Barracks represents one of the few remaining physical structures from the Battle of Trenton. Its capture was crucial to securing the town and preventing organized Hessian resistance.",
                    forces: "Hessian garrison: ~40-50 soldiers from the Rall Regiment"
                }
            },
            'rall-hq': {
                name: "Rall's Headquarters",
                coords: [40.2195, -74.7592],
                elevation: 52,
                type: 'hessian',
                icon: 'üèõÔ∏è',
                desc: "Colonel Rall's command at Stacy's Tavern.",
                tactical: null,
                historical: {
                    overview: "Colonel Johann Rall established his headquarters at Stacy's Tavern (also called the True American Inn). This location served as the command center for all Hessian forces in Trenton.",
                    facts: [
                        "Colonel Rall was playing cards here when the attack began",
                        "A Loyalist farmer attempted to deliver a warning note to Rall the night before",
                        "Rall put the unread note in his pocket - it was found on his body after he was killed",
                        "The headquarters was located near the center of town for quick response",
                        "Rall had dismissed concerns about American attack, considering them defeated",
                        "He had refused to build defensive fortifications, calling them unnecessary"
                    ],
                    significance: "Rall's overconfidence and dismissal of warnings proved fatal. His death during the battle (mortally wounded, died the next day) contributed to the collapse of Hessian resistance.",
                    forces: "Command staff and personal guard"
                }
            },
            'king-street': {
                name: 'King Street Battery',
                coords: [40.2210, -74.7615],
                elevation: 55,
                type: 'hessian',
                icon: 'üõ°Ô∏è',
                desc: 'Northern artillery with 6-pounder cannon.',
                tactical: null,
                historical: {
                    overview: "The King Street battery represented one of two main artillery positions defending Trenton from the north. Despite having cannon, the Hessians were unable to effectively deploy them during the surprise attack.",
                    facts: [
                        "Positioned to defend against attack from Princeton to the north",
                        "Equipped with 6-pounder field pieces",
                        "Crews were caught off-guard by the dawn attack",
                        "American forces under General Sullivan attacked from this direction",
                        "The artillery pieces were captured early in the battle",
                        "Wet weather had dampened much of the Hessian gunpowder"
                    ],
                    significance: "The rapid capture of this battery prevented the Hessians from organizing effective artillery defense. The Americans turned these captured guns against their former owners.",
                    forces: "Artillery crew: ~20-30 Hessian gunners"
                }
            },
            'queen-street': {
                name: 'Queen Street Battery',
                coords: [40.2175, -74.7600],
                elevation: 48,
                type: 'hessian',
                icon: 'üõ°Ô∏è',
                desc: 'Southern artillery position.',
                tactical: null,
                historical: {
                    overview: "The Queen Street battery formed the southern artillery defense of Trenton. Like its northern counterpart, it was quickly overrun by American forces.",
                    facts: [
                        "Protected the southern approach to Trenton",
                        "Also equipped with 6-pounder cannon",
                        "Crews struggled to serve their pieces in the sleet and snow",
                        "General Greene's division approached from this direction",
                        "The position was abandoned as Hessians attempted to retreat",
                        "Captured guns were later used by the Continental Army"
                    ],
                    significance: "The loss of both artillery batteries left the Hessians without their most powerful weapons, forcing them to rely on muskets alone against Washington's coordinated attack.",
                    forces: "Artillery crew: ~20-30 Hessian gunners"
                }
            },
            'assunpink': {
                name: 'Assunpink Creek Bridge',
                coords: [40.2145, -74.7598],
                elevation: 42,
                type: 'continental',
                icon: 'üåâ',
                desc: 'Continental fallback position.',
                tactical: null,
                historical: {
                    overview: "The Assunpink Creek bridge represented Washington's planned escape route if the attack failed. Instead, it became the Hessians' attempted escape route as they fled south.",
                    facts: [
                        "Washington secured this bridge to ensure his escape route",
                        "Hessian forces attempted to retreat across it when surrounded",
                        "American troops blocked the bridge, trapping the Hessians",
                        "The creek was partially frozen, making crossing difficult",
                        "Some Hessians attempted to wade across and drowned",
                        "The bridge would see more action in the Second Battle of Trenton (Jan 2, 1777)"
                    ],
                    significance: "Control of this bridge was crucial to Washington's victory. By blocking the Hessian retreat, American forces forced a surrender rather than allowing an escape.",
                    forces: "American rear guard: Several hundred troops"
                }
            }
        };
        
        class Game {
            constructor() {
                this.state = { visited: [], current: null, log: [] };
                this.map = null;
                this.markers = {};
                this.routeLine = null;
            }
            
            init() {
                this.load();
                this.setupMap();
                this.setupRouteCalc();
                this.render();
                setInterval(() => this.save(), 30000);
            }
            
            setupMap() {
                this.map = L.map('map', {
                    center: [40.2190, -74.7608],
                    zoom: 13
                });
                
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    maxZoom: 19
                }).addTo(this.map);
                
                Object.keys(LOCATIONS).forEach(key => this.createMarker(key));
                L.control.scale({ position: 'bottomleft', imperial: true }).addTo(this.map);
            }
            
            createMarker(key) {
                const loc = LOCATIONS[key];
                const html = `<div class="marker-pin ${loc.type}"><div class="marker-icon">${loc.icon}</div></div>`;
                
                const marker = L.marker(loc.coords, {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: html,
                        iconSize: [40, 40],
                        iconAnchor: [20, 40]
                    })
                }).addTo(this.map);
                
                const popupHTML = `
                    <div class="popup-title">${loc.icon} ${loc.name}</div>
                    <div class="popup-coords">${loc.coords[0].toFixed(4)}¬∞N, ${Math.abs(loc.coords[1]).toFixed(4)}¬∞W ‚Ä¢ ${loc.elevation} ft</div>
                    <div class="popup-desc">${loc.desc}</div>
                    <div class="popup-actions">
                        <button class="popup-btn" onclick="game.showInfo('${key}')">üìñ History</button>
                        ${loc.tactical ? `<button class="popup-btn tactical" onclick="game.openTactical('${key}')">‚öîÔ∏è Enter Tactical Map</button>` : ''}
                    </div>
                `;
                
                marker.bindPopup(popupHTML);
                marker.on('click', () => this.select(key));
                
                // Tooltip on hover
                marker.bindTooltip(`${loc.icon} ${loc.name}`, {
                    permanent: false,
                    direction: 'top',
                    offset: [0, -35]
                });
                
                this.markers[key] = marker;
            }
            
            setupRouteCalc() {
                const fromSelect = document.getElementById('route-from');
                const toSelect = document.getElementById('route-to');
                
                Object.keys(LOCATIONS).forEach(key => {
                    const loc = LOCATIONS[key];
                    fromSelect.innerHTML += `<option value="${key}">${loc.icon} ${loc.name}</option>`;
                    toSelect.innerHTML += `<option value="${key}">${loc.icon} ${loc.name}</option>`;
                });
                
                const calcRoute = () => {
                    const from = fromSelect.value;
                    const to = toSelect.value;
                    
                    if (from && to && from !== to) {
                        const loc1 = LOCATIONS[from];
                        const loc2 = LOCATIONS[to];
                        const dist = this.calcDist(loc1.coords, loc2.coords);
                        const walk = this.calcTime(dist, 3);
                        const horse = this.calcTime(dist, 8);
                        
                        document.getElementById('calc-dist').textContent = dist.toFixed(1);
                        document.getElementById('calc-walk').textContent = walk.toFixed(0) + 'm';
                        document.getElementById('calc-horse').textContent = horse.toFixed(0) + 'm';
                        document.getElementById('route-result').classList.add('active');
                        
                        // Draw route
                        if (this.routeLine) this.map.removeLayer(this.routeLine);
                        this.routeLine = L.polyline([loc1.coords, loc2.coords], {
                            color: '#3b82f6',
                            weight: 4,
                            opacity: 0.7,
                            dashArray: '10, 10'
                        }).addTo(this.map);
                        
                        this.map.fitBounds(this.routeLine.getBounds(), { padding: [50, 50] });
                        
                        this.addLog(`üó∫Ô∏è Route: ${loc1.name} ‚Üí ${loc2.name} (${dist.toFixed(1)} mi, ${walk.toFixed(0)} min)`, 'travel');
                    } else {
                        document.getElementById('route-result').classList.remove('active');
                        if (this.routeLine) {
                            this.map.removeLayer(this.routeLine);
                            this.routeLine = null;
                        }
                    }
                };
                
                fromSelect.onchange = calcRoute;
                toSelect.onchange = calcRoute;
            }
            
            select(key) {
                const loc = LOCATIONS[key];
                this.state.current = key;
                
                if (!this.state.visited.includes(key)) {
                    this.state.visited.push(key);
                    this.addLog(`üìç Discovered ${loc.name}`, 'discovery');
                }
                
                this.map.flyTo(loc.coords, 16, { duration: 1.5 });
                this.markers[key].openPopup();
                
                this.save();
                this.render();
            }
            
            showInfo(key) {
                const loc = LOCATIONS[key];
                const hist = loc.historical;
                
                document.getElementById('info-title').textContent = `${loc.icon} ${loc.name}`;
                document.getElementById('info-subtitle').textContent = 
                    `${loc.coords[0].toFixed(4)}¬∞N, ${Math.abs(loc.coords[1]).toFixed(4)}¬∞W ‚Ä¢ ${loc.elevation} ft`;
                
                document.getElementById('info-body').innerHTML = `
                    <div class="info-section">
                        <div class="section-title">üìú Overview</div>
                        <div class="info-text">${hist.overview}</div>
                    </div>
                    <div class="info-section">
                        <div class="section-title">üìö Historical Facts</div>
                        <ul class="info-list">
                            ${hist.facts.map(f => `<li>${f}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="info-section">
                        <div class="section-title">‚≠ê Significance</div>
                        <div class="info-text">${hist.significance}</div>
                        <div class="historical-fact"><strong>Forces:</strong> ${hist.forces}</div>
                    </div>
                `;
                
                document.getElementById('info-modal').classList.add('active');
            }
            
            openTactical(key) {
                const loc = LOCATIONS[key];
                if (!loc.tactical) return;
                document.getElementById('tactical-frame').src = loc.tactical;
                document.getElementById('tactical-overlay').classList.add('active');
                this.addLog(`‚öîÔ∏è Entered ${loc.name} tactical map`, 'combat');
            }
            
            calcDist(c1, c2) {
                const R = 3959;
                const lat1 = c1[0] * Math.PI / 180;
                const lat2 = c2[0] * Math.PI / 180;
                const dLat = (c2[0] - c1[0]) * Math.PI / 180;
                const dLon = (c2[1] - c1[1]) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                         Math.cos(lat1) * Math.cos(lat2) *
                         Math.sin(dLon/2) * Math.sin(dLon/2);
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            }
            
            calcTime(dist, speed) {
                return (dist / speed) * 60;
            }
            
            addLog(text, type = 'info') {
                this.state.log.unshift({
                    time: new Date().toLocaleTimeString(),
                    text: text,
                    type: type
                });
                if (this.state.log.length > 100) this.state.log.pop();
                this.save();
                this.renderLog();
            }
            
            render() {
                this.renderLocations();
                this.renderLog();
                document.getElementById('stat-visited').textContent = `${this.state.visited.length} / ${Object.keys(LOCATIONS).length}`;
                document.getElementById('stat-logs').textContent = this.state.log.length;
            }
            
            renderLocations() {
                let html = '';
                Object.keys(LOCATIONS).forEach(key => {
                    const loc = LOCATIONS[key];
                    const visited = this.state.visited.includes(key);
                    const active = this.state.current === key;
                    
                    html += `
                        <div class="location-card ${loc.type} ${active ? 'active' : ''}" onclick="game.select('${key}')">
                            <div class="location-name">
                                <span>${loc.icon} ${loc.name}</span>
                                <span>
                                    ${visited ? '<span class="badge visited">‚úì</span>' : ''}
                                    ${loc.tactical ? '<span class="badge tactical">‚öîÔ∏è</span>' : ''}
                                </span>
                            </div>
                            <div class="location-desc">${loc.desc}</div>
                        </div>
                    `;
                });
                document.getElementById('locations-list').innerHTML = html;
            }
            
            renderLog() {
                let html = '';
                this.state.log.forEach(entry => {
                    html += `
                        <div class="log-entry ${entry.type}">
                            <div class="log-time">${entry.time}</div>
                            <div class="log-text">${entry.text}</div>
                        </div>
                    `;
                });
                document.getElementById('tab-log').innerHTML = html || '<div class="log-entry">No entries yet. Start exploring!</div>';
            }
            
            save() {
                localStorage.setItem('trenton_1776', JSON.stringify(this.state));
            }
            
            load() {
                const saved = localStorage.getItem('trenton_1776');
                if (saved) {
                    try { this.state = JSON.parse(saved); } catch (e) {}
                }
            }
            
            exportSave() {
                const blob = new Blob([JSON.stringify(this.state, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `trenton_save_${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                this.addLog('üíæ Save exported', 'info');
            }
            
            reset() {
                if (confirm('Reset campaign? All progress will be lost.')) {
                    localStorage.removeItem('trenton_1776');
                    location.reload();
                }
            }
        }
        
        const game = new Game();
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('hidden');
        }
        
        function showTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + name).classList.add('active');
        }
        
        function closeInfo() {
            document.getElementById('info-modal').classList.remove('active');
        }
        
        function closeTactical() {
            document.getElementById('tactical-overlay').classList.remove('active');
            document.getElementById('tactical-frame').src = '';
        }
        
        document.getElementById('import-file').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    game.state = JSON.parse(ev.target.result);
                    game.save();
                    game.render();
                    game.addLog('üì• Save imported', 'info');
                } catch (err) {
                    alert('Import failed');
                }
            };
            reader.readAsText(file);
        };
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => game.init());
        } else {
            game.init();
        }
    </script>
</body>
</html>
